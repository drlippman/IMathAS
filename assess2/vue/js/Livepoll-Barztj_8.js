import{s as r,T as Q,A as x,Q as V,b as L}from"./index-zX0dKd_l.js";import{_ as S,I as C,M as U,e as w,j as i,k as R,l as f,C as D,q,t as m,g,o as h,x as v,Y as y,G as A,W as N,F as T,f as I,m as P,Z as O,z as k}from"./i18n-CTIODh6d.js";const j={name:"LivepollNav",props:["qn"],components:{MenuButton:U,Icons:C},computed:{navOptions(){var e=[];e.push({onclick:()=>this.$emit("selectq",0),title:this.$t("livepoll.settings"),dispqn:0});for(const s in r.assessInfo.questions){const n=parseInt(s)+1;e.push({onclick:()=>this.$emit("selectq",n),title:this.$t("question_n",{n}),dispqn:n})}return e},showNextPrev(){return Object.keys(this.navOptions).length>1},dispqn(){return parseInt(this.qn)+1},curstate(){return r.assessInfo.livepoll_status.curstate},studentCount(){return this.$t("livepoll.stucnt",r.livepollStuCnt)}},methods:{selectQuestion(e){this.$emit("selectq",e)},openQuestion(){this.$emit("openq")},closeQuestion(){this.$emit("closeq")},newVersion(){this.$emit("newversion")}}},M={class:"subheader"},F=["aria-label"],K=["disabled","aria-label"],B=["disabled","aria-label"],H={style:{"flex-grow":"1"}};function J(e,s,n,l,a,t){const u=g("menu-button"),o=g("icons");return h(),w("div",M,[i("div",{class:"flexrow",style:{"flex-grow":"1"},role:"navigation","aria-label":e.$t("regions.qnav")},[R(u,{id:"qnav",options:t.navOptions,selected:t.dispqn,searchby:"dispqn"},{default:D(({option:c})=>[q(m(c.title),1)]),_:1},8,["options","selected"]),t.showNextPrev?(h(),w("button",{key:0,onClick:s[0]||(s[0]=c=>t.selectQuestion(t.dispqn-1)),disabled:t.dispqn<=0,class:"secondarybtn",id:"qprev","aria-label":e.$t("previous")},[R(o,{name:"left"})],8,K)):f("",!0),t.showNextPrev?(h(),w("button",{key:1,onClick:s[1]||(s[1]=c=>t.selectQuestion(t.dispqn+1)),disabled:t.dispqn>=t.navOptions.length-1,class:"secondarybtn",id:"qnext","aria-label":e.$t("next")},[R(o,{name:"right"})],8,B)):f("",!0)],8,F),i("div",H,[t.curstate===2&&t.dispqn>0?(h(),w("button",{key:0,class:"primary",onClick:s[2]||(s[2]=(...c)=>t.closeQuestion&&t.closeQuestion(...c))},m(e.$t("livepoll.close_input")),1)):t.curstate>0&&t.dispqn>0?(h(),w("button",{key:1,class:"primary",onClick:s[3]||(s[3]=(...c)=>t.openQuestion&&t.openQuestion(...c))},m(e.$t("livepoll.open_input")),1)):f("",!0),(t.curstate==1||t.curstate>2)&&t.dispqn>0?(h(),w("button",{key:2,class:"secondary",onClick:s[4]||(s[4]=(...c)=>t.newVersion&&t.newVersion(...c))},[R(o,{name:"retake"}),q(" "+m(e.$t("livepoll.new_version")),1)])):f("",!0)]),i("div",null,m(t.studentCount),1)])}const z=S(j,[["render",J]]),G={name:"LivepollSettings",computed:{showQuestionDefault:{set(e){r.livepollSettings.showQuestionDefault=e},get(){return r.livepollSettings.showQuestionDefault}},showResultsLiveDefault:{set(e){r.livepollSettings.showResultsLiveDefault=e},get(){return r.livepollSettings.showResultsLiveDefault}},showResultsAfter:{set(e){r.livepollSettings.showResultsAfter=e},get(){return r.livepollSettings.showResultsAfter}},showAnswersAfter:{set(e){r.livepollSettings.showAnswersAfter=e},get(){return r.livepollSettings.showAnswersAfter}},useTimer:{set(e){r.livepollSettings.useTimer=e},get(){return r.livepollSettings.useTimer}},questionTimelimit:{set(e){r.livepollSettings.questionTimelimit=e},get(){return r.livepollSettings.questionTimelimit}}}};function E(e,s,n,l,a,t){return h(),w("div",null,[i("h2",null,m(e.$t("livepoll.settings")),1),i("p",null,[i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[0]||(s[0]=u=>t.showQuestionDefault=u)},null,512),[[y,t.showQuestionDefault]]),q(" "+m(e.$t("livepoll.show_question_default")),1)]),s[6]||(s[6]=i("br",null,null,-1)),i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=u=>t.showResultsLiveDefault=u)},null,512),[[y,t.showResultsLiveDefault]]),q(" "+m(e.$t("livepoll.show_results_live_default")),1)]),s[7]||(s[7]=i("br",null,null,-1)),i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[2]||(s[2]=u=>t.showResultsAfter=u)},null,512),[[y,t.showResultsAfter]]),q(" "+m(e.$t("livepoll.show_results_after")),1)]),s[8]||(s[8]=i("br",null,null,-1)),i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[3]||(s[3]=u=>t.showAnswersAfter=u)},null,512),[[y,t.showAnswersAfter]]),q(" "+m(e.$t("livepoll.show_answers_after")),1)]),s[9]||(s[9]=i("br",null,null,-1)),i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[4]||(s[4]=u=>t.useTimer=u)},null,512),[[y,t.useTimer]]),q(" "+m(e.$t("livepoll.use_timer")),1)]),v(i("span",null,[v(i("input",{type:"text",size:"3","onUpdate:modelValue":s[5]||(s[5]=u=>t.questionTimelimit=u)},null,512),[[N,t.questionTimelimit]]),q(" "+m(e.$t("livepoll.seconds")),1)],512),[[A,t.useTimer]])])])}const W=S(G,[["render",E]]),Y={name:"LivepollResultsChoices",props:["results","showans"],methods:{onUpdate(){this.$nextTick(()=>{setTimeout(window.drawPics,100),window.rendermathnode(this.$refs.main)})}},mounted(){this.onUpdate()},watch:{results:function(e,s){this.onUpdate()}}},Z={class:"LPres",ref:"main"},X={style:{"min-width":"10em"}},$=["innerHTML"],ee={class:"LPresbarwrap"},se={class:"LPresval"};function te(e,s,n,l,a,t){return h(),w("table",Z,[s[0]||(s[0]=i("caption",{class:"sr-only"},"Results",-1)),i("thead",null,[i("tr",null,[i("th",null,m(e.$t("livepoll.answer")),1),i("th",X,m(e.$t("livepoll.frequency")),1)])]),i("tbody",null,[(h(!0),w(T,null,I(n.results.choices,(u,o)=>(h(),w("tr",{key:o,class:P([n.showans?n.results.scoredata[o]>0?"LPshowcorrect":"LPshowwrong":""])},[i("td",{innerHTML:u},null,8,$),i("td",null,[i("span",ee,[i("span",{class:"LPresbar",style:O({width:Math.round(100*n.results.datatots[o]/n.results.maxfreq)+"%"})},[i("span",se,m(n.results.datatots[o]),1)],4)])])],2))),128))])],512)}const le=S(Y,[["render",te]]),ne={name:"LivepollResultsGeneral",props:["results","showans","itemid"],computed:{sortedKeys(){const e=this.results.datatots;return Object.keys(e).sort(function(n,l){return e[l]-e[n]})}},methods:{onUpdate(){if(this.results.qtype==="draw"){for(let e=0;e<this.sortedKeys.length;e++){let s=this.sortedKeys[e].replace(/\(/g,"[").replace(/\)/g,"]");s=s.split(";;"),s[0]!==""&&(s[0]="["+s[0].replace(/;/g,"],[")+"]"),s="[["+s.join("],[")+"]]";const n="LP"+this.itemid+"-"+e;window.canvases[n]=this.results.initpts.slice(),window.canvases[n].unshift(n),window.drawla[n]=JSON.parse(s)}this.$nextTick(()=>{for(let e=0;e<this.sortedKeys.length;e++)window.imathasDraw.initCanvases("LP"+this.itemid+"-"+e)})}this.$nextTick(()=>{setTimeout(window.drawPics,100),window.rendermathnode(this.$refs.main)})}},mounted(){this.onUpdate()},watch:{results:function(e,s){this.onUpdate()}}},ie={key:0,class:"LPdrawgrid",ref:"main"},re=["id","width","height"],oe=["id"],ue={key:1,class:"LPres",ref:"main"},ae={style:{"min-width":"10em"}},he={key:0},ce=["id","width","height"],de=["id"],we={key:1},me={class:"LPresbarwrap"},pe={class:"LPresval"};function fe(e,s,n,l,a,t){return n.results.qtype==="draw"&&n.results.initpts[11]===0?(h(),w("div",ie,[(h(!0),w(T,null,I(t.sortedKeys,(u,o)=>(h(),w("div",{key:u,class:P([n.showans?n.results.scoredata[u]>0?n.results.scoredata[u]<.99?"LPshowpartial":"LPshowcorrect":"LPshowwrong":""])},[i("canvas",{class:"drawcanvas",id:"canvasLP"+n.itemid+"-"+o,width:n.results.initpts[6],height:n.results.initpts[7]},null,8,re),i("input",{type:"hidden",id:"qnLP"+n.itemid+"-"+o},null,8,oe)],2))),128))],512)):(h(),w("table",ue,[s[0]||(s[0]=i("caption",{class:"sr-only"},"Results",-1)),i("thead",null,[i("tr",null,[i("th",null,m(e.$t("livepoll.answer")),1),i("th",ae,m(e.$t("livepoll.frequency")),1)])]),i("tbody",null,[(h(!0),w(T,null,I(t.sortedKeys,(u,o)=>(h(),w("tr",{key:u,class:P([n.showans?n.results.scoredata[u]>0?n.results.scoredata[u]<.99?"LPshowpartial":"LPshowcorrect":"LPshowwrong":""])},[n.results.qtype==="draw"?(h(),w("td",he,[i("canvas",{class:"drawcanvas",id:"canvasLP"+n.itemid+"-"+o,width:n.results.initpts[6],height:n.results.initpts[7]},null,8,ce),i("input",{type:"hidden",id:"qnLP"+n.itemid+"-"+o},null,8,de)])):(h(),w("td",we,m(u),1)),i("td",null,[i("span",me,[i("span",{class:"LPresbar",style:O({width:Math.round(100*n.results.datatots[u]/n.results.maxfreq)+"%"})},[i("span",pe,m(n.results.datatots[u]),1)],4)])])],2))),128))])],512))}const ve=S(ne,[["render",fe]]),qe={name:"LivepollResults",props:["qn","showresults","showans"],components:{LivepollResultsChoices:le,LivepollResultsGeneral:ve},computed:{qinfo(){return r.assessInfo.questions[this.qn]},numResults(){return r.livepollResults.hasOwnProperty(this.qn)?Object.keys(r.livepollResults[this.qn]).length:0},params(){const e=[];for(let s=0;s<this.qinfo.answeights.length;s++)s===0&&this.qinfo.jsparams.hasOwnProperty(this.qn)?e[s]=this.qinfo.jsparams[this.qn]:e[s]=this.qinfo.jsparams[(this.qn+1)*1e3+s];return e},results(){const e=[];for(let s=0;s<this.qinfo.answeights.length;s++){const n={},l={};if(this.params[s].hasOwnProperty("livepoll_choices"))for(let d=0;d<this.params[s].livepoll_choices.length;d++)n[d]=0,l[d]=0;const a=this.params[s].qtype,t=a==="choices"||a==="multans";if(t){let d;a==="choices"?d=this.params[s].livepoll_ans.toString().split(/\s+or\s+/):d=this.params[s].livepoll_ans.toString().split(/\s*,\s*/);for(let p=0;p<d.length;p++)l[d[p]]=1}const u=[];let o;for(const d in r.livepollResults[this.qn]){let p=r.livepollResults[this.qn][d].ans[s];t?p=p.toString().split("|"):a.match(/calc/)||a==="numfunc"?p=["`"+p+"`"]:p=[p],a==="draw"&&(o=this.condenseDraw(p[0]),u.hasOwnProperty(o)||(u[o]=p[0]));for(let _=0;_<p.length;_++)a==="draw"&&n.hasOwnProperty(u[o])?n[u[o]]+=1:n.hasOwnProperty(p[_])?n[p[_]]+=1:(n[p[_]]=1,l[p[_]]=r.livepollResults[this.qn][d].score[s])}let c=1;for(const d in n)n[d]>c&&(c=n[d]);if(e[s]={datatots:n,scoredata:l,maxfreq:c,qtype:a},t&&(e[s].choices=this.params[s].livepoll_choices),a==="draw"){const d=this.params[s].livepoll_drawinit;for(let p=1;p<Math.min(11,d.length);p++)d[p]=Number(d[p]);e[s].initpts=d}}return e}},methods:{condenseDraw(e){if(e==="")return e;var s=e.replace(/\(/g,"[").replace(/\)/g,"]");s=s.split(";;"),s[0]!==""&&(s[0]="["+s[0].replace(/;/g,"],[")+"]"),s="[["+s.join("],[")+"]]";var n=JSON.parse(s);if(n[0].length>0)for(let o=0;o<n[0].length;o++)n[0][o].length===2&&n[0][o].sort(function(c,d){return c[0]===d[0]?c[1]-d[1]:c[0]-d[0]});else if(n.length>4&&n[4].length>0)return e;n[1].length>0&&n[1].sort(function(o,c){return o[0]===c[0]?o[1]-c[1]:o[0]-c[0]}),n[2].length>0&&n[2].sort(function(o,c){return o[0]===c[0]?o[1]-c[1]:o[0]-c[0]});var l,a,t,u;if(n.length>3&&n[3].length>0)for(let o=0;o<n[3].length;o++)l=n[3][o],l[0]===5?(l[1]===l[3]?a=[5,"x",l[1]]:(t=(l[4]-l[2])/(l[3]-l[1]),u=l[2]-t*l[1],a=[5,t.toFixed(4),u.toFixed(2)]),n[3][o]=a):l[0]===5.2?(l[1]===l[3]?a=[5.2,"x",l[1],l[2]]:(t=(l[4]-l[2])/(l[3]-l[1]),a=[5.2,t.toFixed(4),l[1],l[2]]),n[3][o]=a):l[0]===5.3?(l[1]<l[3]||l[1]===l[3]&&l[2]<l[4]?a=[5.3,l[1],l[2],l[3],l[4]]:a=[5.3,l[3],l[4],l[1],l[2]],n[3][o]=a):l[0]===6?(l[1]===l[3]?a=[6,"x",l[1],l[2]]:(t=(l[4]-l[2])/((l[3]-l[1])*(l[3]-l[1])),a=[6,t.toFixed(4),l[1],l[2]]),n[3][o]=a):l[0]===6.5?(l[1]===l[3]?a=[6.5,"x",l[1],l[2]]:(u=l[3]>l[1]?1:-1,t=(l[4]-l[2])/Math.sqrt(Math.abs(l[3]-l[1])),a=[6.5,t.toFixed(4),u,l[1],l[2]]),n[3][o]=a):l[0]===8&&(l[1]===l[3]?a=[8,"x",l[1],l[2]]:(t=(l[4]-l[2])/Math.abs(l[3]-l[1]),a=[8,t.toFixed(4),l[1],l[2]]),n[3][o]=a);return JSON.stringify(n)}}},ge={key:0};function _e(e,s,n,l,a,t){const u=g("livepoll-results-choices"),o=g("livepoll-results-general");return t.qinfo&&t.qinfo.answeights?(h(),w("div",ge,[i("p",null,m(e.$t("livepoll.numresults",t.numResults)),1),v(i("div",null,[(h(!0),w(T,null,I(t.results,(c,d)=>(h(),w("div",{key:n.qn+"-"+d,class:"med-below"},[c.hasOwnProperty("choices")?(h(),k(u,{key:0,results:c,showans:n.showans},null,8,["results","showans"])):(h(),k(o,{key:1,results:c,showans:n.showans,itemid:n.qn+"-"+d},null,8,["results","showans","itemid"]))]))),128))],512),[[A,n.showresults&&t.numResults>0]])])):f("",!0)}const ye=S(qe,[["render",_e]]),be={name:"livepoll",components:{LivepollNav:z,Question:V,LivepollSettings:W,LivepollResults:ye,AssessHeader:x,Timer:Q},data:function(){return{showQuestion:!0,showResults:!0,showAnswers:!0,onSettings:!1,livepollTimer:null,socket:null}},computed:{isTeacher(){return r.assessInfo.is_teacher},curqn(){return this.onSettings?-1:parseInt(r.assessInfo.livepoll_status.curquestion)-1},curseed(){return r.assessInfo.livepoll_status.seed},curstate(){return r.assessInfo.livepoll_status.curstate},starttime(){return r.assessInfo.livepoll_status.startt},timelimit(){return r.livepollSettings.useTimer?parseInt(r.livepollSettings.questionTimelimit):r.assessInfo.livepoll_status.timelimit?parseInt(r.assessInfo.livepoll_status.timelimit):0},showAnswersLabel(){return this.curstate<3?this.$t("livepoll.show_answers_after"):this.$t("livepoll.show_answers")}},methods:{updateUsercount(e){r.livepollStuCnt=e.cnt,e.teachcnt===0&&(r.assessInfo.livepoll_status.curstate=0)},addResult(e){if(e.score=JSON.parse(e.score),e.ans=JSON.parse(e.ans),r.livepollResults.hasOwnProperty(this.curqn))r.livepollResults[this.curqn][e.user]=e;else{const s={};s[this.curqn]={},s[this.curqn][e.user]=e,r.livepollResults=Object.assign({},r.livepollResults,s)}},showHandler(e){if(e.action==="showq"){if(L.clearInitValue(e.qn),e.startt.indexOf("-")!==-1){const s=e.startt.split("-");e.startt=s[0],e.timelimit=s[1]}else e.timelimit=0;r.assessInfo.livepoll_status={curstate:2,curquestion:parseInt(e.qn)+1,seed:parseInt(e.seed),startt:parseInt(e.startt),timelimit:parseInt(e.timelimit)}}else r.assessInfo.livepoll_status=Object.assign(r.assessInfo.livepoll_status,{curquestion:parseInt(e.qn)+1,curstate:parseInt(e.action),timelimit:0})},selectQuestion(e){clearTimeout(this.livepollTimer);const s=parseInt(e)-1;if(s===-1){this.onSettings=!0;return}else this.onSettings=!1;if(s!==this.curqn){this.showQuestion=r.livepollSettings.showQuestionDefault,this.showResults=r.livepollSettings.showResultsLiveDefault,this.showAnswers=r.livepollSettings.showAnswersAfter;let n=1;r.livepollResults[s]&&Object.keys(r.livepollResults[s]).length>0&&(n=this.showAnswers?4:3),s>=0&&L.setLivepollStatus({newquestion:e,newstate:n})}},openInput(){L.setLivepollStatus({newquestion:this.curqn+1,newstate:2,timelimit:this.timelimit}),this.timelimit>0&&(this.livepollTimer=window.setTimeout(()=>this.closeInput(),1e3*this.timelimit))},closeInput(){clearTimeout(this.livepollTimer);const e=this.showAnswers?4:3;r.livepollSettings.showResultsAfter&&(this.showResults=!0),L.setLivepollStatus({newquestion:this.curqn+1,newstate:e})},newVersion(){L.setLivepollStatus({newquestion:this.curqn+1,newstate:1,forceregen:1}),r.livepollResults.hasOwnProperty(this.curqn)&&delete r.livepollResults[this.curqn]},updateShowAnswers(){if(this.curstate>2){const e=this.showAnswers?4:3;L.setLivepollStatus({newquestion:this.curqn+1,newstate:e})}}},mounted(){const e=r.assessInfo.livepoll_server,s=r.assessInfo.livepoll_data;let n="room="+s.room+"&now="+s.now;s.sig&&(n+="&sig="+encodeURIComponent(s.sig)),this.socket=window.io("https://"+e+":3000",{query:n}),this.socket.off(),this.socket.on("livepoll usercount",l=>this.updateUsercount(l)),r.assessInfo.is_teacher?this.socket.on("livepoll qans",l=>this.addResult(l)):this.socket.on("livepoll show",l=>this.showHandler(l))},created(){r.assessInfo.livepoll_status.curquestion===0&&this.isTeacher&&(this.onSettings=!0)}},ke={class:"home"},Le={key:1,class:"subheader"},Se={key:0,id:"livepoll_qsettings",style:{"flex-grow":"1"}},Re={key:1,style:{"flex-grow":"1"}},Te={key:2},Ie=["aria-label"],Pe={key:1,class:"questionpane"};function Ae(e,s,n,l,a,t){const u=g("assess-header"),o=g("livepoll-nav"),c=g("timer"),d=g("livepoll-settings"),p=g("question"),_=g("livepoll-results");return h(),w("div",ke,[R(u),t.isTeacher?(h(),k(o,{key:0,qn:t.curqn,onSelectq:t.selectQuestion,onOpenq:t.openInput,onCloseq:t.closeInput,onNewversion:t.newVersion},null,8,["qn","onSelectq","onOpenq","onCloseq","onNewversion"])):f("",!0),t.curstate>0&&t.curqn>-1&&(t.isTeacher||t.timelimit>0)?(h(),w("div",Le,[t.isTeacher?(h(),w("div",Se,[i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[0]||(s[0]=b=>e.showQuestion=b)},null,512),[[y,e.showQuestion]]),q(" "+m(e.$t("livepoll.show_question")),1)]),i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=b=>e.showResults=b)},null,512),[[y,e.showResults]]),q(" "+m(e.$t("livepoll.show_results")),1)]),i("label",null,[v(i("input",{type:"checkbox","onUpdate:modelValue":s[2]||(s[2]=b=>e.showAnswers=b),onChange:s[3]||(s[3]=(...b)=>t.updateShowAnswers&&t.updateShowAnswers(...b))},null,544),[[y,e.showAnswers]]),q(" "+m(t.showAnswersLabel),1)])])):(h(),w("div",Re)),t.timelimit>0&&t.starttime>0?(h(),k(c,{key:2,end:1e3*(t.starttime+t.timelimit),total:t.timelimit},null,8,["end","total"])):f("",!0)])):f("",!0),!t.isTeacher&&t.curstate>0?(h(),w("div",Te,[i("h2",null,m(e.$t("question_n",{n:t.curqn+1})),1)])):f("",!0),i("div",{class:"scrollpane","aria-label":e.$t("regions.questions")},[t.isTeacher&&(t.curstate===0||t.curqn===-1)?(h(),k(d,{key:0,class:"questionpane"})):f("",!0),!t.isTeacher&&t.curstate<2?(h(),w("div",Pe,m(e.$t("livepoll.waiting")),1)):f("",!0),t.curqn>=0&&(t.isTeacher&&t.curstate>0||!t.isTeacher&&t.curstate>1)?v((h(),k(p,{key:2,qn:t.curqn,active:!0,state:t.curstate,seed:t.curseed},null,8,["qn","state","seed"])),[[A,e.showQuestion]]):f("",!0),t.isTeacher?(h(),k(_,{showresults:e.showResults,showans:t.curstate===4,qn:t.curqn,key:t.curqn+"-"+t.curseed},null,8,["showresults","showans","qn"])):f("",!0)],8,Ie)])}const xe=S(be,[["render",Ae]]);export{xe as default};
