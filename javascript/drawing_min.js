var canvases=new Array,drawla=new Array,imathasDraw=function($){var clickcnt,lastdrawmouseup,mouseintarget,normslider,drawexport,mouseisdown=!1,targets=new Array,imgs=new Array,targetOuts=new Array,lines=new Array,dots=new Array,odots=new Array,tplines=new Array,tptypes=new Array,ineqlines=new Array,ineqtypes=new Array,curLine=null,drawstyle=[],drawlocky=[],curTPcurve=null,curIneqcurve=null,ineqcolors=["rgb(0,0,255)","rgb(255,0,0)","rgb(0,255,0)"],ineqacolors=["rgba(0,0,255,.4)","rgba(255,0,0,.4)","rgba(0,255,0,.4)"],asymcolor="rgb(0,200,0)",dragObj=null,oldpointpos=null,curTarget=null,curCursor=null,nocanvaswarning=!1,hasTouch=!1,didMultiTouch=!1,clickmightbenewcurve=!1,hasTouchTimer=null,tpModeN={5:2,5.2:2,5.3:2,5.4:2,6:2,6.1:2,6.3:2,6.5:2,6.6:2,7:2,7.2:2,7.4:2,7.5:2,8:2,8.2:2,8.3:2,8.4:2,8.5:3,8.6:3,9:2,9.1:2,10:3,10.2:3,10.3:3,10.4:3},tpHasAsymp={7.4:1,7.5:1,8.2:1,8.5:1,8.6:1};function reset(){clearAllDrawListners(),targets.length=0,imgs.length=0,targetOuts.length=0,lines.length=0,dots.length=0,odots.length=0,tplines.length=0,tptypes.length=0,ineqlines.length=0,ineqtypes.length=0,drawstyle.length=0,drawlocky.length=0,curIneqcurve=curTPcurve=dragObj=curLine=curTarget=null}function clearcanvas(e,t){targetOuts[e]&&targetOuts[e].disabled&&!t||lines.hasOwnProperty(e)&&(lines[e].length=0,dots[e].length=0,odots[e].length=0,tplines[e].length=0,tptypes[e].length=0,ineqlines[e].length=0,ineqtypes[e].length=0,"canvas"==targets[curTarget=e].type&&drawTarget(),dragObj=curLine=curTarget=null)}function clearlastline(e){0<lines[e].length&&(lines[e].length=lines[e].length-1),curTarget=e,drawTarget(),dragObj=curLine=curTarget=null}function addA11yTarget(e,t,r){var n,a,i,s,g,u,l,o,c,d,T,p,h,m,y,w,f,v,b=e[0],q=e[13].split(","),x=!0;for("noprev"==q[q.length-1]&&(x=!1,q.pop()),n=e[2],a=e[3],(i=e[4])==(s=e[5])&&(i=-1,s=1),g=e[6],u=e[7],e=e[8],null==(l=document.getElementById("a11ydraw"+b))&&(c=document.getElementById("canvas"+b))&&!x&&(o=$("<div>").append($("<p>",{text:_("Drawn Elements:")})),(l=document.createElement("ul")).setAttribute("id","allydraw"+b),o.append(l),$(c).replaceWith(o)),targetOuts[b]=document.getElementById("qn"+b),c=!!document.getElementById("a11ydrawnew"+b),targetOuts[b].disabled&&(c&&(document.getElementById("a11ydrawnew"+b).disabled=!0),$(".a11ydrawadd[data-qn="+b+"]").prop("disabled",!0)),targets[b]={type:"a11y",el:l,vispreview:x,xmin:n,xmax:a,ymin:i,ymax:s,imgborder:g,imgwidth:u,imgheight:e},x&&(targets[b].canv=document.getElementById("canvas"+b)),targets[b].pixperx=(u-2*g)/(a-n),targets[b].pixpery=i==s?1:(e-2*g)/(s-i),"inequality"==q[0]?(d=q.shift(),0==q.length?q=["line"]:"both"==q[0]&&(q=["line","parab"])):"twopoint"==q[0]?(d=q.shift(),0==q.length&&(q=["line","parab","abs","circle","dot"])):"numberline"==q[0]?(d="basic",q.shift()):d="basic",targets[b].afgroup=d,T={inequality:{line:[{mode:10,descr:_("Linear inequality with solid line"),inN:3,input:_("Enter 2 points on the line, then a third point in the shaded region")},{mode:10.2,descr:_("Linear inequality with dashed line"),inN:3,input:_("Enter 2 points on the line, then a third point in the shaded region")}],parab:[{mode:10.3,descr:_("Parabolic inequality with solid line"),inN:3,input:_("Enter the vertex, then another point on the parabola, then a third point in the shaded region")},{mode:10.4,descr:_("Parabolic inequality with dashed line"),inN:3,input:_("Enter the vertex, then another point on the parabola, then a third point in the shaded region")}],abs:[{mode:10.5,descr:_("Absolute value inequality with solid line"),inN:3,input:_("Enter the corner point of the absolute value, then another point on the graph, then a third point in the shaded region")},{mode:10.6,descr:_("Absolute value inequality with dashed line"),inN:3,input:_("Enter the corner point of the absolute value, then another point on the graph, then a third point in the shaded region")}]},twopoint:{line:[{mode:5,descr:_("Line"),inN:2,input:_("Enter two points on the line")}],lineseg:[{mode:5.3,descr:_("Line segment"),inN:2,input:_("Enter the starting and ending point of the line segment")}],ray:[{mode:5.2,descr:_("Ray"),inN:2,input:_("Enter the starting point of the ray and another point on the ray")}],parab:[{mode:6,descr:_("Parabola"),inN:2,input:_("Enter the vertex, then another point on the parabola")}],horizparab:[{mode:6.1,descr:_("Parabola opening right or left"),inN:2,input:_("Enter the vertex, then another point on the parabola")}],cubic:[{mode:6.3,descr:_("Cubic"),inN:2,input:_("Enter the inflection point, then another point on the cubic")}],cuberoot:[{mode:6.6,descr:_("Cube root"),inN:2,input:_("Enter the inflection point of the cube root, then another point on the graph")}],abs:[{mode:8,descr:_("Absolute value"),inN:2,input:_("Enter the corner point of the absolute value, then another point on the graph")}],rational:[{mode:8.2,descr:_("Rational"),inN:2,input:_("Enter the point where the vertical and horizontal asymptote cross, then a point on the graph")}],exp:[{mode:8.3,descr:_("Exponential"),inN:2,input:_("Enter two points on the graph")}],log:[{mode:8.4,descr:_("Logarithm"),inN:2,input:_("Enter two points on the graph")}],genexp:[{mode:8.5,descr:_("Shifted Exponential"),inN:3,input:_("Enter a point on the asymptote, then enter two points on the graph")}],genlog:[{mode:8.6,descr:_("Shifted Logarithm"),inN:3,input:_("Enter a point on the asymptote, then enter two points on the graph")}],circle:[{mode:7,descr:_("Circle"),inN:2,input:_("Enter the center point of the circle, then a point on the graph")}],ellipse:[{mode:7.2,descr:_("Ellipse"),inN:2,input:_("Enter the center point of the ellipse, then a point offset from the center by the horizontal radius and vertical radius")}],hyperbola:[{mode:7.4,descr:_("Vertical hyperbola"),inN:2,input:_("Enter the center point of the hyperbola, then a point (x,y) where x is the x-coordinate of the co-vertex and y is the y-coordinate of the vertex")},{mode:7.5,descr:_("Horizontal hyperbola"),inN:2,input:_("Enter the center point of the hyperbola, then a point (x,y) where x is the x-coordinate of the vertex and y is the y-coordinate of the co-vertex")}],dot:[{mode:1,descr:_("Solid dot"),inN:1,input:_("Enter the coordinates of the dot")}],opendot:[{mode:2,descr:_("Open dot"),inN:1,input:_("Enter the coordinates of the dot")}],trig:[{mode:9,descr:_("Cosine"),inN:2,input:_("Enter a point at the start of a phase, then a point half a phase further")},{mode:9.1,descr:_("Sine"),inN:2,input:_("Enter a point at the start of a phase, then a point a quarter phase further")}],vector:[{mode:5.4,descr:_("Vector"),inN:2,input:_("Enter the starting and ending point of the vector")}]},basic:{line:[{mode:0,descr:_("Lines"),inN:"list",input:_("Enter a list of points to connect with lines")}],lineseg:[{mode:.5,descr:_("Line segment"),inN:2,input:_("Enter the starting and ending point of the line segment")}],freehand:[{mode:.7,descr:_("Freehand"),inN:"list",input:_("Enter a list of points to connect with lines")}],dot:[{mode:1,descr:_("Solid dot"),inN:1,input:_("Enter the coordinates of the dot")}],opendot:[{mode:2,descr:_("Open dot"),inN:1,input:_("Enter the coordinates of the dot")}],polygon:[{mode:0,descr:_("Polygon"),inN:"list",input:_("Enter a list of points for dots to connect with lines"),dotline:1}],closedpolygon:[{mode:0,descr:_("Polygon"),inN:"list",input:_("Enter a list of points for dots to connect with lines"),dotline:2}]}},null==lines[b]&&(lines[b]=new Array),null==dots[b]&&(dots[b]=new Array),null==odots[b]&&(odots[b]=new Array),null==tplines[b]&&(tplines[b]=new Array),null==tptypes[b]&&(tptypes[b]=new Array),null==ineqlines[b]&&(ineqlines[b]=new Array),null==ineqtypes[b]&&(ineqtypes[b]=new Array),h=[],m=[],y=[],f=0;f<q.length;f++)if(T[d].hasOwnProperty(q[f]))for(0==f&&(p=T[d][q[f]][0].mode),v=0;v<T[d][q[f]].length;v++)y[T[d][q[f]][v].mode]=T[d][q[f]][v],h.push(T[d][q[f]][v].mode),w='<option value="'+T[d][q[f]][v].mode+'"',w+=' data-af="'+q[f]+'">'+T[d][q[f]][v].descr+"</option>",m.push(w);if(c&&(document.getElementById("a11ydrawnew"+b).innerHTML=m),targets[b].defmode=p,targets[b].inputmodes=h,targets[b].selects=m,targets[b].moderef=y,c||!x)if(null==t&&lines.hasOwnProperty(b)){for(f=0;f<lines[b].length;f++)adda11ydraw(b,0,pixcoordstopointlist(lines[b][f],b));for(f=0;f<dots[b].length;f++)adda11ydraw(b,1,pixcoordstopointlist(dots[b][f],b));for(f=0;f<odots[b].length;f++)adda11ydraw(b,2,pixcoordstopointlist(odots[b][f],b));for(f=0;f<tplines[b].length;f++)adda11ydraw(b,tptypes[b][f],pixcoordstopointlist(tplines[b][f][0],b)+","+pixcoordstopointlist(tplines[b][f][1],b));for(f=0;f<ineqlines[b].length;f++)adda11ydraw(b,ineqtypes[b][f],pixcoordstopointlist(ineqlines[b][f][0],b)+","+pixcoordstopointlist(ineqlines[b][f][1],b)+","+pixcoordstopointlist(ineqlines[b][f][2],b))}else if(null!=t)for(f=0;f<t.length;f++)adda11ydraw(b,t[f][0],t[f][1].replace(/\[/g,"(").replace(/\]/g,")"));x&&initBackground(targets[b].canv,b,r,u,e,!0)}function adda11ydraw(e,t,r){var n=targets[e],t=t||document.getElementById("a11ydrawnew"+e).value,a=r||"",i=(n.afgroup,n.el.getElementsByTagName("li").length+1),e=targetOuts[e].disabled?" disabled ":"",i='<span class="sr-only draweln">'+_("Drawing element ")+i+"</span>";html=(html=(html=(html=(html=i)+n.moderef[t].descr+'.<br/><label><span class="a11ydrawinstr"></span><br/>')+'<input type="text" value="'+a+'" data-n="'+n.moderef[t].inN+'" '+e)+'onblur="imathasDraw.updatea11ydraw(this)"/></label><button type="button" class="imgbutton" onclick="imathasDraw.removea11ydraw(this)"'+e+">")+_("Remove")+" "+i+"</button>",a=$("<li>",{class:"a11ydrawrow","data-mode":t}).html(html),$(n.el).append(a),a.find(".a11ydrawinstr").text(n.moderef[t].input),r||a.find("input").focus()}function removea11ydraw(e){setariastatus(_("Removed drawing element"));var t=$(e).closest("ul");$(e).parent().remove(),t.find("li").each(function(e,t){e=_("Drawing element ")+(e+1);$(t).find(".draweln").html(e)}),t.prev().focus(),encodea11ydraw(t.attr("id").substring(8))}function changea11ydraw(e,t){var r=$(e).val(),t=targets[t].moderef[r];$(e).closest("li").find(".a11ydrawinstr").text(t.input),encodea11ydraw()}function updatea11ydraw(e){var t,r,n,a,i,s=0,g=e.value.trim();for("("==g.charAt(0)&&")"==g.slice(-1)||(s|=1),t=g.slice(1,-1).split(/\)\s*,\s*\(/),(g=e.getAttribute("data-n")).match(/\d/)&&t.length!=parseInt(g)&&(s|=2),r=0;r<t.length;r++)for(2!=(n=t[r].split(/,/)).length&&(s|=1),a=0;a<n.length;a++)0==n[a].trim().length&&(s|=1);"noticetext"==e.parentNode.parentNode.lastChild.className&&e.parentNode.parentNode.removeChild(e.parentNode.parentNode.lastChild),s?(e.setAttribute("aria-invalid",!0),(i=document.createElement("span")).id=uniqid("a11ydrawerr"),i.className="noticetext",1==(1&s)?(i.innerHTML="<br>"+_("Error: Invalid format for points. Give points as open parenthesis number comma number close parenthesis. Separate points with a comma."),setariastatus(_("Error: Invalid format for points"))):(i.innerHTML="<br>"+_("Error: Incorrect number of points. Expecting ")+g,setariastatus(_("Error: Incorrect number of points"))),e.parentNode.parentNode.appendChild(i),e.setAttribute("aria-describedby",i.id)):(e.removeAttribute("aria-invalid"),e.removeAttribute("aria-describedby"),setariastatus("")),encodea11ydraw(parseInt($(e).closest(".a11ydraw").attr("id").substring(8)))}function pixcoordstopointlist(e,t){var t=targets[t],r=(e[0]-t.imgborder)/t.pixperx+t.xmin,e=(t.imgheight-e[1]-t.imgborder)/t.pixpery+t.ymin;return"("+Math.round(100*r)/100+","+Math.round(100*e)/100+")"}function encodea11ydraw(qn){var oldCurTarget,tarnum,thistarg,enclines,encdots,encodots,enctplines,enctpineq,saveinput,afgroup;for(tarnum in void 0===qn&&(qn=-1),oldCurTarget=curTarget,targets)-1<qn&&qn!=tarnum||(thistarg=targets[tarnum],"a11y"==thistarg.type&&(-1<qn&&qn==tarnum&&(curTarget=tarnum),lines[tarnum].length=0,dots[tarnum].length=0,odots[tarnum].length=0,tplines[tarnum].length=0,tptypes[tarnum].length=0,ineqlines[tarnum].length=0,ineqtypes[tarnum].length=0,enclines=[],encdots=[],encodots=[],enctplines=[],enctpineq=[],saveinput=[],afgroup=targets[tarnum].afgroup,$("#a11ydraw"+tarnum).find(".a11ydrawrow").each(function(i,el){var outpts,outptsraw,input=$(el).find("input").val(),mode=el.getAttribute("data-mode");for(saveinput.push("["+mode+',"'+input+'"]'),input=input.replace(/[\(\)]/g,"").split(/\s*,\s*/),outpts=[],outptsraw=[],i=1;i<input.length;i+=2){try{input[i-1]=eval(prepWithMath(mathjs(input[i-1])))}catch(e){input[i-1]=NaN}try{input[i]=eval(prepWithMath(mathjs(input[i])))}catch(e){input[i]=NaN}input[i-1]=(input[i-1]-thistarg.xmin)*thistarg.pixperx+thistarg.imgborder,input[i]=thistarg.imgheight-(input[i]-thistarg.ymin)*thistarg.pixpery-thistarg.imgborder,outpts.push(Math.round(input[i-1])+","+Math.round(input[i])),outptsraw.push([input[i-1],input[i]])}1==mode?(encdots.push("("+outpts.join("),(")+")"),dots[tarnum].push(outptsraw)):2==mode?(encodots.push("("+outpts.join("),(")+")"),odots[tarnum].push(outptsraw)):mode<1?(enclines.push("("+outpts.join("),(")+")"),lines[tarnum].push(outptsraw)):5<=mode&&mode<10&&2==outpts.length?(enctplines.push("("+mode+","+outpts.join(",")+")"),tplines[tarnum].push(outptsraw),tptypes[tarnum].push(mode)):10<=mode&&3==outpts.length&&(enctpineq.push("("+mode+","+outpts.join(",")+")"),ineqlines[tarnum].push(outptsraw),ineqtypes[tarnum].push(mode))}),targetOuts[tarnum].value=enclines.join(";")+";;"+encdots.join(",")+";;"+encodots.join(",")+";;"+enctplines.join(",")+";;"+enctpineq.join(",")+";;"+saveinput.join(","),$(targetOuts[tarnum]).trigger("input").trigger("change")));-1<qn&&targets[qn].vispreview&&drawTarget(null,null,!0),curTarget=oldCurTarget}function addTarget(e,t,r,n,a,i,s,g,u,l,o,c,d,T,p){var h=document.getElementById(t);$(h).is(":hidden")&&$(h).on("mouseover.imathasdrawwait touchstart.imathasdrawwait",function(){$(h).off("mouseover.imathasdrawwait touchstart.imathasdrawwait"),initCanvases(e)}),h.style.userSelect="none",h.style.webkitUserSelect="none",h.style.MozUserSelect="none",t=getPosition(h),targets[e]={type:"canvas",el:h,left:t.x,top:t.y,width:h.offsetWidth,height:h.offsetHeight,xmin:a,xmax:i,ymin:s,ymax:g,imgborder:u,imgwidth:l,imgheight:o,mode:c,dotline:d},"string"==typeof p&&-1!=p.indexOf(":")?(p=p.split(":"),targets[e].snaptogridx=+p[0],targets[e].snaptogridy=+p[1]):(targets[e].snaptogridx=+p,targets[e].snaptogridy=+p),targets[e].pixperx=(l-2*u)/(i-a),targets[e].pixpery=s==g?1:(o-2*u)/(g-s),targetOuts[e]=document.getElementById(n),null==lines[e]&&(lines[e]=new Array),null==dots[e]&&(dots[e]=new Array),null==odots[e]&&(odots[e]=new Array),null==tplines[e]&&(tplines[e]=new Array),null==tptypes[e]&&(tptypes[e]=new Array),null==ineqlines[e]&&(ineqlines[e]=new Array),null==ineqtypes[e]&&(ineqtypes[e]=new Array),drawstyle[e]=5<=c?1:0,drawlocky[e]=T,initBackground(h,e,r,l,o,!1)}function initBackground(e,t,r,n,a,i){var s;r.match(/initPicture/)?(0==$(e).closest(".drawcanvasholder").length&&($(e).removeClass("drawcanvas").wrap($("<div>",{class:"drawcanvas",style:"position:relative;width:"+n+"px;height:"+a+"px"})).wrap($("<div>",{class:"drawcanvasholder",style:"position:absolute;top:0;left:0;z-index:2"})),$(e).closest(".drawcanvas").prepend($("<div>",{class:"canvasbg",style:"position:absolute;top:0;left:0"}).append($("<embed>",{"data-nomag":1,type:"image/svg+xml",align:"middle",width:n,height:a,script:r}).attr("width",n).attr("height",a)))),imgs[t]=null,s=curTarget,curTarget=t,drawTarget(null,null,i),setTimeout(function(){window.drawPics($(e).closest(".drawcanvas")[0])},30),curTarget=s):""!==r?(imgs[t]=new Image,imgs[t].onload=function(){var e=curTarget;curTarget=t,drawTarget(null,null,i),curTarget=e},imgs[t].src=r):(imgs[t]=null,s=curTarget,curTarget=t,drawTarget(null,null,i),curTarget=s)}function settool(e,t,r){for(var n=document.getElementById("drawtools"+t),a=n.getElementsByTagName("span"),i=0;i<a.length;i++)a[i].className="";for(a=n.getElementsByTagName("img"),i=0;i<a.length;i++)a[i].className="";e.className="sel",setDrawMode(t,r),curTarget=t,drawTarget()}function setDrawMode(e,t){targets[e].mode=t}function setDotLine(e,t){targets[e].dotline=t}function drawTarget(e,t,C){var r,n,A,a,i,s,g,u,S,l,o,c,d,T,p,h,m,y,w,f,v,D,b,W,q,x,M,O,L,j,R,H,z,P,U,F,Y,E,I,X,V,G,J,Q,_,N,B,k,$;try{r=(targets[curTarget].canv||targets[curTarget].el).getContext("2d")}catch(e){nocanvaswarning||(nocanvaswarning=!0,alert("Your browser does not support drawing answer entry.  Please try again using Internet Explorer 6+ (Windows), FireFox 1.5+ (Win/Mac), Safari 1.3+ (Mac), Opera 9+ (Win/Mac), or Camino (Mac)"))}for(r.fillStyle="rgb(0,0,255)",r.lineWidth=2,r.strokeStyle="rgb(0,0,255)",r.clearRect(0,0,targets[curTarget].imgwidth,targets[curTarget].imgheight),null!==imgs[curTarget]&&r.drawImage(imgs[curTarget],0,0),r.beginPath(),n=0;n<ineqlines[curTarget].length;n++){if(r.strokeStyle=ineqcolors[A=n%3],r.fillStyle=ineqcolors[A],u=g=s=i=a=null,3==ineqlines[curTarget][n].length?(i=ineqlines[curTarget][n][1][0],g=ineqlines[curTarget][n][1][1],s=ineqlines[curTarget][n][2][0],u=ineqlines[curTarget][n][2][1]):2==ineqlines[curTarget][n].length?(i=ineqlines[curTarget][n][1][0],g=ineqlines[curTarget][n][1][1],s=e,u=t):curIneqcurve==n&&null!=e&&1==ineqlines[curTarget][n].length&&(i=e,g=t),null!=s&&(r.save(),r.fillStyle=ineqacolors[A],r.beginPath(),ineqtypes[curTarget][n]<=10.2?(i!=ineqlines[curTarget][n][0][0]&&(a=(g-ineqlines[curTarget][n][0][1])/(i-ineqlines[curTarget][n][0][0])),Math.abs(i-ineqlines[curTarget][n][0][0])<1||100<Math.abs(a)?(r.moveTo(ineqlines[curTarget][n][0][0],0),r.lineTo(ineqlines[curTarget][n][0][0],targets[curTarget].imgheight),i<s?(r.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(targets[curTarget].imgwidth,0)):(r.lineTo(0,targets[curTarget].imgheight),r.lineTo(0,0))):(S=a*(s-i)+g,l=ineqlines[curTarget][n][0][1]-a*ineqlines[curTarget][n][0][0],o=ineqlines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-ineqlines[curTarget][n][0][0]),r.moveTo(0,l),r.lineTo(targets[curTarget].imgwidth,o),S<u?(r.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(0,targets[curTarget].imgheight)):(r.lineTo(targets[curTarget].imgwidth,0),r.lineTo(0,0))),r.closePath()):ineqtypes[curTarget][n]<=10.4?shadeParabola(r,ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],i,g,s,u,targets[curTarget].imgwidth,targets[curTarget].imgheight):1<Math.abs(i-ineqlines[curTarget][n][0][0])&&(a=(g-ineqlines[curTarget][n][0][1])/(i-ineqlines[curTarget][n][0][0]),i<ineqlines[curTarget][n][0][0]&&(a*=-1),S=a*Math.abs(s-ineqlines[curTarget][n][0][0])+ineqlines[curTarget][n][0][1],l=ineqlines[curTarget][n][0][1]+a*ineqlines[curTarget][n][0][0],o=ineqlines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-ineqlines[curTarget][n][0][0]),S<u?(r.moveTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(0,targets[curTarget].imgheight)):(r.moveTo(targets[curTarget].imgwidth,0),r.lineTo(0,0)),r.lineTo(0,l),r.lineTo(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1]),r.lineTo(targets[curTarget].imgwidth,o)),r.fill(),r.restore()),r.beginPath(),null!=i&&(ineqtypes[curTarget][n]<=10.2?(i!=ineqlines[curTarget][n][0][0]&&(a=(g-ineqlines[curTarget][n][0][1])/(i-ineqlines[curTarget][n][0][0])),Math.abs(i-ineqlines[curTarget][n][0][0])<1||100<Math.abs(a)?10.2==ineqtypes[curTarget][n]?null!=dragObj&&10<=dragObj.mode&&dragObj.mode<11&&dragObj.num==n&&0==dragObj.subnum?(r.dashedLine(ineqlines[curTarget][n][1][0],ineqlines[curTarget][n][1][1],ineqlines[curTarget][n][1][0],targets[curTarget].imgheight),r.dashedLine(ineqlines[curTarget][n][1][0],ineqlines[curTarget][n][1][1],ineqlines[curTarget][n][1][0],0)):(r.dashedLine(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],ineqlines[curTarget][n][0][0],targets[curTarget].imgheight),r.dashedLine(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],ineqlines[curTarget][n][0][0],0)):(r.moveTo(ineqlines[curTarget][n][0][0],0),r.lineTo(ineqlines[curTarget][n][0][0],targets[curTarget].imgheight),r.stroke()):(l=ineqlines[curTarget][n][0][1]-a*ineqlines[curTarget][n][0][0],o=ineqlines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-ineqlines[curTarget][n][0][0]),10.2==ineqtypes[curTarget][n]?null!=dragObj&&10<=dragObj.mode&&dragObj.mode<11&&dragObj.num==n&&0==dragObj.subnum?(r.dashedLine(ineqlines[curTarget][n][1][0],ineqlines[curTarget][n][1][1],targets[curTarget].imgwidth,o),r.dashedLine(ineqlines[curTarget][n][1][0],ineqlines[curTarget][n][1][1],0,l)):(r.dashedLine(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],targets[curTarget].imgwidth,o),r.dashedLine(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],0,l)):(r.moveTo(0,l),r.lineTo(targets[curTarget].imgwidth,o),r.stroke()))):ineqtypes[curTarget][n]<=10.4?10.3==ineqtypes[curTarget][n]?(i!=ineqlines[curTarget][n][0][0]&&(g==ineqlines[curTarget][n][0][1]?(r.moveTo(0,g),r.lineTo(targets[curTarget].imgwidth,g)):(c=(g-ineqlines[curTarget][n][0][1])/((i-ineqlines[curTarget][n][0][0])*(i-ineqlines[curTarget][n][0][0])),h=g>ineqlines[curTarget][n][0][1]?(d=Math.sqrt((targets[curTarget].imgheight-ineqlines[curTarget][n][0][1])/c)+ineqlines[curTarget][n][0][0],T=-1*Math.sqrt((targets[curTarget].imgheight-ineqlines[curTarget][n][0][1])/c)+ineqlines[curTarget][n][0][0],p=ineqlines[curTarget][n][0][1]-(targets[curTarget].imgheight-ineqlines[curTarget][n][0][1]),targets[curTarget].imgheight):(d=Math.sqrt((0-ineqlines[curTarget][n][0][1])/c)+ineqlines[curTarget][n][0][0],T=-1*Math.sqrt((0-ineqlines[curTarget][n][0][1])/c)+ineqlines[curTarget][n][0][0],p=2*ineqlines[curTarget][n][0][1],0),w=(m=d+2/3*(ineqlines[curTarget][n][0][0]-d))+(T-d)/3,f=y=h+2/3*(p-h),r.moveTo(d,h),r.bezierCurveTo(m,y,w,f,T,h))),r.stroke()):i!=ineqlines[curTarget][n][0][0]&&dashedParabola(r,ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],i,g,targets[curTarget].imgwidth,targets[curTarget].imgheight):i!=ineqlines[curTarget][n][0][0]&&(a=(g-ineqlines[curTarget][n][0][1])/(i-ineqlines[curTarget][n][0][0]),i<ineqlines[curTarget][n][0][0]&&(a*=-1),l=ineqlines[curTarget][n][0][1]+a*ineqlines[curTarget][n][0][0],o=ineqlines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-ineqlines[curTarget][n][0][0]),10.6==ineqtypes[curTarget][n]?(null!=dragObj&&10<=dragObj.mode&&dragObj.mode<11&&dragObj.num==n&&dragObj.subnum,r.dashedLine(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],targets[curTarget].imgwidth,o),r.dashedLine(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1],0,l)):(r.moveTo(0,l),r.lineTo(ineqlines[curTarget][n][0][0],ineqlines[curTarget][n][0][1]),r.lineTo(targets[curTarget].imgwidth,o),r.stroke()))),ineqtypes[curTarget][n]==targets[curTarget].mode){for(r.beginPath(),v=0;v<ineqlines[curTarget][n].length;v++)2==v?(r.arc(ineqlines[curTarget][n][v][0],ineqlines[curTarget][n][v][1],4,0,2*Math.PI,!0),r.fill()):r.fillRect(ineqlines[curTarget][n][v][0]-3,ineqlines[curTarget][n][v][1]-3,6,6);1==ineqlines[curTarget][n].length&&null!=i&&r.fillRect(i-3,g-3,6,6)}r.beginPath()}for(r.fillStyle="rgb(0,0,255)",1==drawlocky[curTarget]?r.lineWidth=4:r.lineWidth=2,r.strokeStyle="rgb(0,0,255)",n=0;n<tplines[curTarget].length;n++){if(5<=tptypes[curTarget][n]&&tptypes[curTarget][n]<6)g=i=a=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&(5.3==tptypes[curTarget][n]||5.4==tptypes[curTarget][n]?(r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),r.lineTo(i,g),5.4==tptypes[curTarget][n]&&(b=[i-tplines[curTarget][n][0][0],g-tplines[curTarget][n][0][1]],1e-4<(M=Math.sqrt(b[0]*b[0]+b[1]*b[1]))&&(r.moveTo(i-15*(b=[b[0]/M,b[1]/M])[0]-4*(M=[-b[1],b[0]])[0],g-15*b[1]-5*M[1]),r.lineTo(i,g),r.moveTo(i-15*b[0]+4*M[0],g-15*b[1]+5*M[1]),r.lineTo(i,g)))):(i!=tplines[curTarget][n][0][0]&&(a=(g-tplines[curTarget][n][0][1])/(i-tplines[curTarget][n][0][0])),Math.abs(i-tplines[curTarget][n][0][0])<1||100<Math.abs(a)?5.2==tptypes[curTarget][n]?(r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),g>tplines[curTarget][n][0][1]?r.lineTo(tplines[curTarget][n][0][0],targets[curTarget].imgheight):r.lineTo(tplines[curTarget][n][0][0],0)):(r.moveTo(tplines[curTarget][n][0][0],0),r.lineTo(tplines[curTarget][n][0][0],targets[curTarget].imgheight)):(l=tplines[curTarget][n][0][1]-a*tplines[curTarget][n][0][0],o=tplines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0]),l=tplines[curTarget][n][0][1]-a*tplines[curTarget][n][0][0],o=tplines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0]),5.2==tptypes[curTarget][n]?(r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),i>tplines[curTarget][n][0][0]?r.lineTo(targets[curTarget].imgwidth,o):r.lineTo(0,l)):(r.moveTo(0,l),r.lineTo(targets[curTarget].imgwidth,o)))));else if(6==tptypes[curTarget][n]||6.1==tptypes[curTarget][n])i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&(6==tptypes[curTarget][n]?g==tplines[curTarget][n][0][1]?(r.moveTo(0,g),r.lineTo(targets[curTarget].imgwidth,g)):i==tplines[curTarget][n][0][0]?(r.moveTo(i,tplines[curTarget][n][0][1]),g>tplines[curTarget][n][0][1]?r.lineTo(i,targets[curTarget].imgheight):r.lineTo(i,0)):(c=(g-tplines[curTarget][n][0][1])/((i-tplines[curTarget][n][0][0])*(i-tplines[curTarget][n][0][0])),h=g>tplines[curTarget][n][0][1]?(d=Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][n][0][1])/c)+tplines[curTarget][n][0][0],T=-1*Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][n][0][1])/c)+tplines[curTarget][n][0][0],p=tplines[curTarget][n][0][1]-(targets[curTarget].imgheight-tplines[curTarget][n][0][1]),targets[curTarget].imgheight):(d=Math.sqrt((0-tplines[curTarget][n][0][1])/c)+tplines[curTarget][n][0][0],T=-1*Math.sqrt((0-tplines[curTarget][n][0][1])/c)+tplines[curTarget][n][0][0],p=2*tplines[curTarget][n][0][1],0),w=(m=d+2/3*(tplines[curTarget][n][0][0]-d))+(T-d)/3,f=y=h+2/3*(p-h),r.moveTo(d,h),r.bezierCurveTo(m,y,w,f,T,h)):6.1==tptypes[curTarget][n]&&(i==tplines[curTarget][n][0][0]?(r.moveTo(i,0),r.lineTo(i,targets[curTarget].imgheight)):g==tplines[curTarget][n][0][1]?(r.moveTo(tplines[curTarget][n][0][0],g),i>tplines[curTarget][n][0][0]?r.lineTo(targets[curTarget].imgwidth,g):r.lineTo(0,g)):(c=(i-tplines[curTarget][n][0][0])/((g-tplines[curTarget][n][0][1])*(g-tplines[curTarget][n][0][1])),b=i>tplines[curTarget][n][0][0]?(d=Math.sqrt((targets[curTarget].imgwidth-tplines[curTarget][n][0][0])/c)+tplines[curTarget][n][0][1],T=-1*Math.sqrt((targets[curTarget].imgwidth-tplines[curTarget][n][0][0])/c)+tplines[curTarget][n][0][1],D=tplines[curTarget][n][0][0]-(targets[curTarget].imgwidth-tplines[curTarget][n][0][0]),targets[curTarget].imgwidth):(d=Math.sqrt((0-tplines[curTarget][n][0][0])/c)+tplines[curTarget][n][0][1],T=-1*Math.sqrt((0-tplines[curTarget][n][0][0])/c)+tplines[curTarget][n][0][1],D=2*tplines[curTarget][n][0][0],0),f=(y=d+2/3*(tplines[curTarget][n][0][1]-d))+(T-d)/3,w=m=b+2/3*(D-b),r.moveTo(b,d),r.bezierCurveTo(m,y,w,f,b,T))));else if(6.5==tptypes[curTarget][n]){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&i!=tplines[curTarget][n][0][0])if(g==tplines[curTarget][n][0][1])r.moveTo(tplines[curTarget][n][0][0],g),i>tplines[curTarget][n][0][0]?r.lineTo(targets[curTarget].imgwidth,g):r.lineTo(0,g);else for(W=i<tplines[curTarget][n][0][0]?-1:1,c=(g-tplines[curTarget][n][0][1])/Math.sqrt(W*(i-tplines[curTarget][n][0][0])),r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),x=tplines[curTarget][n][0][0],q=tplines[curTarget][n][0][1];x+=3*W,r.lineTo(x,c*Math.sqrt(W*(x-tplines[curTarget][n][0][0]))+tplines[curTarget][n][0][1]),0<x&&x<targets[curTarget].imgwidth&&0<q&&q<targets[curTarget].imgheight;);}else if(6.3==tptypes[curTarget][n]){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&i!=tplines[curTarget][n][0][0])if(g==tplines[curTarget][n][0][1])r.moveTo(0,g),r.lineTo(targets[curTarget].imgwidth,g);else for(c=(g-tplines[curTarget][n][0][1])/safepow(i-tplines[curTarget][n][0][0],3),x=q=0;x<targets[curTarget].imgwidth+4;x+=1)(q=(q=c*safepow(x-tplines[curTarget][n][0][0],3)+tplines[curTarget][n][0][1])<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),0==x?r.moveTo(x,q):r.lineTo(x,q)}else if(6.6==tptypes[curTarget][n]){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&i!=tplines[curTarget][n][0][0])if(g==tplines[curTarget][n][0][1])r.moveTo(0,g),r.lineTo(targets[curTarget].imgwidth,g);else for(c=(g-tplines[curTarget][n][0][1])/safepow(i-tplines[curTarget][n][0][0],1/3),x=q=0;x<targets[curTarget].imgwidth+4;x+=1)(q=(q=c*safepow(x-tplines[curTarget][n][0][0],1/3)+tplines[curTarget][n][0][1])<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),0==x?r.moveTo(x,q):r.lineTo(x,q)}else if(7<=tptypes[curTarget][n]&&tptypes[curTarget][n]<8){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&(i!=tplines[curTarget][n][0][0]||g!=tplines[curTarget][n][0][1]))if(7==tptypes[curTarget][n])M=Math.sqrt((i-tplines[curTarget][n][0][0])*(i-tplines[curTarget][n][0][0])+(g-tplines[curTarget][n][0][1])*(g-tplines[curTarget][n][0][1])),r.arc(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],M,0,2*Math.PI,!0);else if(7.2==tptypes[curTarget][n])H=Math.abs(i-tplines[curTarget][n][0][0]),I=Math.abs(g-tplines[curTarget][n][0][1]),(curTPcurve==n||null!=dragObj&&dragObj.num==n)&&(r.strokeStyle="rgb(0,255,255)",r.lineWidth=1,r.dashedLine(i,g,i-2*(i-tplines[curTarget][n][0][0]),g,5),r.dashedLine(i,g,i,g-2*(g-tplines[curTarget][n][0][1]),5),r.dashedLine(i,g-2*(g-tplines[curTarget][n][0][1]),i-2*(i-tplines[curTarget][n][0][0]),g-2*(g-tplines[curTarget][n][0][1]),5),r.dashedLine(i-2*(i-tplines[curTarget][n][0][0]),g,i-2*(i-tplines[curTarget][n][0][0]),g-2*(g-tplines[curTarget][n][0][1]),5),r.lineWidth=2),r.strokeStyle="rgb(0,0,255)",r.save(),r.beginPath(),r.translate(tplines[curTarget][n][0][0]-H,tplines[curTarget][n][0][1]-I),r.scale(H,I),r.arc(1,1,1,0,2*Math.PI,!1),r.restore();else if(7.4==tptypes[curTarget][n]){for(O=Math.abs(i-tplines[curTarget][n][0][0]),L=Math.abs(g-tplines[curTarget][n][0][1]),j=Math.abs(L/O),r.strokeStyle=asymcolor,r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],targets[curTarget].imgwidth,tplines[curTarget][n][0][1]+j*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0])),r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],targets[curTarget].imgwidth,tplines[curTarget][n][0][1]-j*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0])),r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],0,tplines[curTarget][n][0][1]-j*tplines[curTarget][n][0][0]),r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],0,tplines[curTarget][n][0][1]+j*tplines[curTarget][n][0][0]),(curTPcurve==n||null!=dragObj&&dragObj.num==n)&&(r.strokeStyle="rgb(0,255,255)",r.lineWidth=1,r.dashedLine(i,g,i-2*(i-tplines[curTarget][n][0][0]),g,5),r.dashedLine(i,g,i,g-2*(g-tplines[curTarget][n][0][1]),5),r.dashedLine(i,g-2*(g-tplines[curTarget][n][0][1]),i-2*(i-tplines[curTarget][n][0][0]),g-2*(g-tplines[curTarget][n][0][1]),5),r.dashedLine(i-2*(i-tplines[curTarget][n][0][0]),g,i-2*(i-tplines[curTarget][n][0][0]),g-2*(g-tplines[curTarget][n][0][1]),5),r.lineWidth=2),r.beginPath(),r.strokeStyle="rgb(0,0,255)",x=0;x<targets[curTarget].imgwidth+4;x+=3)(q=(q=tplines[curTarget][n][0][1]+Math.sqrt((Math.pow(x-tplines[curTarget][n][0][0],2)/(O*O)+1)*L*L))<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),0==x?r.moveTo(x,q):r.lineTo(x,q);for(r.stroke(),r.beginPath(),x=0;x<targets[curTarget].imgwidth+4;x+=3)(q=(q=tplines[curTarget][n][0][1]-Math.sqrt((Math.pow(x-tplines[curTarget][n][0][0],2)/(O*O)+1)*L*L))<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),0==x?r.moveTo(x,q):r.lineTo(x,q)}else if(7.5==tptypes[curTarget][n]){for(L=Math.abs(i-tplines[curTarget][n][0][0]),O=Math.abs(g-tplines[curTarget][n][0][1]),j=Math.abs(O/L),r.strokeStyle=asymcolor,r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],targets[curTarget].imgwidth,tplines[curTarget][n][0][1]+j*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0])),r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],targets[curTarget].imgwidth,tplines[curTarget][n][0][1]-j*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0])),r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],0,tplines[curTarget][n][0][1]-j*tplines[curTarget][n][0][0]),r.dashedLine(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1],0,tplines[curTarget][n][0][1]+j*tplines[curTarget][n][0][0]),(curTPcurve==n||null!=dragObj&&dragObj.num==n)&&(r.strokeStyle="rgb(0,255,255)",r.lineWidth=1,r.dashedLine(i,g,i-2*(i-tplines[curTarget][n][0][0]),g,5),r.dashedLine(i,g,i,g-2*(g-tplines[curTarget][n][0][1]),5),r.dashedLine(i,g-2*(g-tplines[curTarget][n][0][1]),i-2*(i-tplines[curTarget][n][0][0]),g-2*(g-tplines[curTarget][n][0][1]),5),r.dashedLine(i-2*(i-tplines[curTarget][n][0][0]),g,i-2*(i-tplines[curTarget][n][0][0]),g-2*(g-tplines[curTarget][n][0][1]),5),r.lineWidth=2),r.beginPath(),r.strokeStyle="rgb(0,0,255)",q=0;q<targets[curTarget].imgwidth+4;q+=3)(x=(x=tplines[curTarget][n][0][0]+Math.sqrt((Math.pow(q-tplines[curTarget][n][0][1],2)/(O*O)+1)*L*L))<-100?-100:x)>targets[curTarget].imgwidth+100&&(x=targets[curTarget].imgwidth+100),0==q?r.moveTo(x,q):r.lineTo(x,q);for(r.stroke(),r.beginPath(),q=0;q<targets[curTarget].imgwidth+4;q+=3)(x=(x=tplines[curTarget][n][0][0]-Math.sqrt((Math.pow(q-tplines[curTarget][n][0][1],2)/(O*O)+1)*L*L))<-100?-100:x)>targets[curTarget].imgwidth+100&&(x=targets[curTarget].imgwidth+100),0==q?r.moveTo(x,q):r.lineTo(x,q)}}else if(8==tptypes[curTarget][n])g=i=a=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&(i!=tplines[curTarget][n][0][0]&&(a=(g-tplines[curTarget][n][0][1])/(i-tplines[curTarget][n][0][0]),i<tplines[curTarget][n][0][0]&&(a*=-1)),Math.abs(i-tplines[curTarget][n][0][0])<1||100<Math.abs(a)?(r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),g>tplines[curTarget][n][0][1]?r.lineTo(tplines[curTarget][n][0][0],targets[curTarget].imgheight):r.lineTo(tplines[curTarget][n][0][0],0)):(l=tplines[curTarget][n][0][1]+a*tplines[curTarget][n][0][0],o=tplines[curTarget][n][0][1]+a*(targets[curTarget].imgwidth-tplines[curTarget][n][0][0]),r.moveTo(0,l),r.lineTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),r.lineTo(targets[curTarget].imgwidth,o)));else if(8.3==tptypes[curTarget][n]){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&i!=tplines[curTarget][n][0][0])if(g==tplines[curTarget][n][0][1])r.moveTo(0,g),r.lineTo(targets[curTarget].imgwidth,g);else if(0<(H=(R=targets[curTarget].ymax*targets[curTarget].pixpery+targets[curTarget].imgborder)-tplines[curTarget][n][0][1])*(z=R-g)&&i!=tplines[curTarget][n][0][0])for(P=safepow(z/H,1/(i-tplines[curTarget][n][0][0])),c=z/safepow(P,i),r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),x=q=0;x<targets[curTarget].imgwidth+4;x+=3)(q=(q=R-c*safepow(P,x))<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),0==x?r.moveTo(x,q):r.lineTo(x,q)}else if(8.4==tptypes[curTarget][n]){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&i!=tplines[curTarget][n][0][0]&&g!=tplines[curTarget][n][0][1]&&0<(F=(U=-targets[curTarget].xmin*targets[curTarget].pixperx+targets[curTarget].imgborder)-tplines[curTarget][n][0][0])*(Y=U-i)&&g!=tplines[curTarget][n][0][1])for(P=safepow(Y/F,1/(g-tplines[curTarget][n][0][1])),c=Y/safepow(P,g),r.moveTo(tplines[curTarget][n][0][0],tplines[curTarget][n][0][1]),q=q=0;q<targets[curTarget].imgheight+4;q+=3)(x=(x=U-c*safepow(P,q))<-100?-100:x)>targets[curTarget].imgwidth+100&&(x=targets[curTarget].imgwidth+100),0==q?r.moveTo(x,q):r.lineTo(x,q)}else if(8.5==tptypes[curTarget][n]){if(s=u=i=g=null,3==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1],s=tplines[curTarget][n][2][0],u=tplines[curTarget][n][2][1]):2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1],s=e,u=t):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),E=tplines[curTarget][n][0][1],r.strokeStyle=asymcolor,r.dashedLine(5,E,targets[curTarget].imgwidth,E),r.beginPath(),r.strokeStyle="rgb(0,0,255)",null!=s&&s!=i)if(u==g)r.moveTo(0,u),r.lineTo(targets[curTarget].imgwidth,u);else if(0<(z=E-g)*(I=E-u)&&s!=i)for(P=safepow(I/z,1/(s-i)),c=I/safepow(P,s),r.moveTo(i,g),x=q=0;x<targets[curTarget].imgwidth+4;x+=3)(q=(q=E-c*safepow(P,x))<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),0==x?r.moveTo(x,q):r.lineTo(x,q)}else if(8.6==tptypes[curTarget][n]){if(s=u=i=g=null,3==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1],s=tplines[curTarget][n][2][0],u=tplines[curTarget][n][2][1]):2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1],s=e,u=t):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),X=tplines[curTarget][n][0][0],r.strokeStyle=asymcolor,r.dashedLine(X,5,X,targets[curTarget].imgheight),r.beginPath(),r.strokeStyle="rgb(0,0,255)",null!=s&&s!=i&&u!=g&&0<(Y=i-X)*(V=s-X))for(P=safepow(V/Y,1/(u-g)),c=V/safepow(P,u),r.moveTo(i,g),q=x=0;q<targets[curTarget].imgheight+4;q+=3)(x=(x=X+c*safepow(P,q))<-100?-100:x)>targets[curTarget].imgwidth+100&&(x=targets[curTarget].imgwidth+100),0==q?r.moveTo(x,q):r.lineTo(x,q)}else if(8.2==tptypes[curTarget][n]){if(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),r.strokeStyle=asymcolor,r.dashedLine(5,tplines[curTarget][n][0][1],targets[curTarget].imgwidth,tplines[curTarget][n][0][1]),r.dashedLine(tplines[curTarget][n][0][0],5,tplines[curTarget][n][0][0],targets[curTarget].imgheight),r.beginPath(),r.strokeStyle="rgb(0,0,255)",null!=i&&i!=tplines[curTarget][n][0][0]&&g!=tplines[curTarget][n][0][1]){for(c=(g-tplines[curTarget][n][0][1])*(i-tplines[curTarget][n][0][0]),x=tplines[curTarget][n][0][0]-1;-4<x;x-=3)(q=(q=c/(x-tplines[curTarget][n][0][0])+tplines[curTarget][n][0][1])<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),x==tplines[curTarget][n][0][0]-1?r.moveTo(x,q):r.lineTo(x,q);for(x=tplines[curTarget][n][0][0]+1;x<targets[curTarget].imgwidth+4;x+=3)(q=(q=c/(x-tplines[curTarget][n][0][0])+tplines[curTarget][n][0][1])<-100?-100:q)>targets[curTarget].imgheight+100&&(q=targets[curTarget].imgheight+100),x==tplines[curTarget][n][0][0]+1?r.moveTo(x,q):r.lineTo(x,q);r.stroke()}}else if((9==tptypes[curTarget][n]||9.1==tptypes[curTarget][n])&&(i=g=null,2==tplines[curTarget][n].length?(i=tplines[curTarget][n][1][0],g=tplines[curTarget][n][1][1]):curTPcurve==n&&null!=e&&1==tplines[curTarget][n].length&&(i=e,g=t),null!=i&&i!=tplines[curTarget][n][0][0]))if(g==tplines[curTarget][n][0][1])r.moveTo(0,g),r.lineTo(targets[curTarget].imgwidth,g);else for(9==tptypes[curTarget][n]?(G=-1*Math.abs(g-tplines[curTarget][n][0][1])/2,J=(g+tplines[curTarget][n][0][1])/2,c=Math.PI/Math.abs(i-tplines[curTarget][n][0][0]),Q=g<tplines[curTarget][n][0][1]?i:tplines[curTarget][n][0][0]):9.1==tptypes[curTarget][n]&&(G=-1*Math.abs(g-tplines[curTarget][n][0][1]),J=tplines[curTarget][n][0][1],c=.5*Math.PI/Math.abs(i-tplines[curTarget][n][0][0]),Q=g<tplines[curTarget][n][0][1]?i:i+2*Math.abs(i-tplines[curTarget][n][0][0])),x=q=0;x<targets[curTarget].imgwidth+4;x+=3)q=G*Math.cos(c*(x-Q))+J,0==x?r.moveTo(x,q):r.lineTo(x,q);r.stroke(),r.beginPath()}for(null===curTPcurve&&tpHasAsymp.hasOwnProperty(targets[curTarget].mode)&&(r.strokeStyle="rgb(200,200,200)",8.5==targets[curTarget].mode?r.dashedLine(5,t,targets[curTarget].imgwidth,t):8.6==targets[curTarget].mode?r.dashedLine(e,5,e,targets[curTarget].imgwidth):8.2==targets[curTarget].mode?(r.dashedLine(5,t,targets[curTarget].imgwidth,t),r.dashedLine(e,5,e,targets[curTarget].imgheight)):7.4!=targets[curTarget].mode&&7.5!=targets[curTarget].mode||(r.dashedLine(e,t,targets[curTarget].imgwidth,t+(targets[curTarget].imgwidth-e)),r.dashedLine(e,t,targets[curTarget].imgwidth,t-(targets[curTarget].imgwidth-e)),r.dashedLine(e,t,0,t-e),r.dashedLine(e,t,0,t+e)),r.beginPath(),r.strokeStyle="rgb(0,0,255)"),r.fillStyle="rgba(0,0,255,.5)",n=0;n<lines[curTarget].length;n++){for(r.beginPath(),v=0;v<lines[curTarget][n].length;v++)0==v?(r.moveTo(lines[curTarget][n][v][0],lines[curTarget][n][v][1]),_=lines[curTarget][n][v][0],N=lines[curTarget][n][v][1]):(r.lineTo(lines[curTarget][n][v][0],lines[curTarget][n][v][1]),B=lines[curTarget][n][v][0],k=lines[curTarget][n][v][1]);if(n==curLine&&null!=e&&(r.lineTo(e,t),B=e,k=t),$=.02*targets[curTarget].imgwidth,1==drawlocky[curTarget]&&B>.98*targets[curTarget].imgwidth?(r.moveTo(B,k),r.lineTo(B-$,k+$),r.moveTo(B,k),r.lineTo(B-$,k-$)):1==drawlocky[curTarget]&&_>.98*targets[curTarget].imgwidth&&(r.moveTo(_,N),r.lineTo(_-$,N+$),r.moveTo(_,N),r.lineTo(_-$,N-$)),1==drawlocky[curTarget]&&B<.02*targets[curTarget].imgwidth?(r.moveTo(B,k),r.lineTo(B+$,k+$),r.moveTo(B,k),r.lineTo(B+$,k-$)):1==drawlocky[curTarget]&&_<.02*targets[curTarget].imgwidth&&(r.moveTo(_,N),r.lineTo(_+$,N+$),r.moveTo(_,N),r.lineTo(_+$,N-$)),r.stroke(),1<targets[curTarget].dotline&&!(lines[curTarget][n].length-1<1)&&Math.pow(B-_,2)+Math.pow(k-N,2)<25){for(r.moveTo(lines[curTarget][n][0][0],lines[curTarget][n][0][1]),v=1;v<lines[curTarget][n].length;v++)r.lineTo(lines[curTarget][n][v][0],lines[curTarget][n][v][1]);r.closePath(),r.fill()}}for(r.fillStyle="rgb(0,0,255)",r.beginPath(),n=0;n<dots[curTarget].length;n++)r.moveTo(dots[curTarget][n][0]+5,dots[curTarget][n][1]),r.arc(dots[curTarget][n][0],dots[curTarget][n][1],5,0,2*Math.PI,!0);if(r.fill(),0<targets[curTarget].dotline){for(r.beginPath(),n=0;n<lines[curTarget].length;n++)for(v=0;v<lines[curTarget][n].length;v++)(0==v||25<Math.pow(lines[curTarget][n][v][0]-lines[curTarget][n][v-1][0],2)+Math.pow(lines[curTarget][n][v][1]-lines[curTarget][n][v-1][1],2))&&(r.moveTo(lines[curTarget][n][v][0]+5,lines[curTarget][n][v][1]),r.arc(lines[curTarget][n][v][0],lines[curTarget][n][v][1],5,0,2*Math.PI,!0));r.fill()}for(r.fillStyle="rgb(255,255,255)",r.beginPath(),n=0;n<odots[curTarget].length;n++)r.moveTo(odots[curTarget][n][0]+5,odots[curTarget][n][1]),r.arc(odots[curTarget][n][0],odots[curTarget][n][1],4,0,2*Math.PI,!0);for(targets[curTarget].mode<3?r.fill():r.stroke(),r.lineWidth=2,r.beginPath(),n=0;n<odots[curTarget].length;n++)r.moveTo(odots[curTarget][n][0]+5,odots[curTarget][n][1]),r.arc(odots[curTarget][n][0],odots[curTarget][n][1],4,0,2*Math.PI,!0);for(r.stroke(),n=0;n<tplines[curTarget].length;n++)if(tptypes[curTarget][n]==targets[curTarget].mode){for(r.fillStyle="rgb(255,0,0)",v=0;v<tplines[curTarget][n].length;v++)r.fillRect(tplines[curTarget][n][v][0]-3,tplines[curTarget][n][v][1]-3,6,6);tplines[curTarget][n].length<tpModeN[targets[curTarget].mode]&&null!=e&&curTPcurve==n&&r.fillRect(e-3,t-3,6,6),r.fillStyle="rgb(0,0,255)"}!0!==C&&encodeDraw()}function deleteCurve(e,t){1==e?dots[curTarget].splice(t,1):2==e?odots[curTarget].splice(t,1):0<=e&&e<1?lines[curTarget].splice(t,1):5<=e&&e<10?(tplines[curTarget].splice(t,1),tptypes[curTarget].splice(t,1),curTPcurve=null):10<=e&&e<11&&(ineqlines[curTarget].splice(t,1),ineqtypes[curTarget].splice(t,1),curIneqcurve=null),drawTarget()}function encodeDraw(){for(var e,t,r,n,a,i="",s=[],g=0;g<lines[curTarget].length;g++)for(lines[curTarget][g].length,s=0==targets[curTarget].dotline?pathsimplify(lines[curTarget][g]):lines[curTarget][g],0!=g&&(i+=";"),e=0;e<s.length;e++)0!=e&&(i+=","),i+="("+s[e][0]+","+s[e][1]+")";for(i+=";;",g=0;g<dots[curTarget].length;g++)0!=g&&(i+=","),i+="("+dots[curTarget][g][0]+","+dots[curTarget][g][1]+")";for(i+=";;",g=0;g<odots[curTarget].length;g++)0!=g&&(i+=","),i+="("+odots[curTarget][g][0]+","+odots[curTarget][g][1]+")";for(i+=";;",t=[],r="",g=0;g<tplines[curTarget].length;g++)if(tplines[curTarget][g].length==tpModeN[tptypes[curTarget][g]]){for(r="("+tptypes[curTarget][g],e=0;e<tplines[curTarget][g].length;e++)r+=","+tplines[curTarget][g][e][0]+","+tplines[curTarget][g][e][1];t.push(r+")")}for(i=i+t.join(",")+";;",n=[],g=0;g<ineqlines[curTarget].length;g++)2<ineqlines[curTarget][g].length&&n.push("("+ineqtypes[curTarget][g]+","+ineqlines[curTarget][g][0][0]+","+ineqlines[curTarget][g][0][1]+","+ineqlines[curTarget][g][1][0]+","+ineqlines[curTarget][g][1][1]+","+ineqlines[curTarget][g][2][0]+","+ineqlines[curTarget][g][2][1]+")");i+=n.join(","),targetOuts[curTarget].value!=i&&(a=""!=targetOuts[curTarget].value||";;;;;;;;"!=i,targetOuts[curTarget].value=i,a&&$(targetOuts[curTarget]).trigger("input").trigger("change"))}function drawMouseDown(e){var t,r,n,a;if(clickcnt++,clearAllDrawListners(),hasTouch&&1<e.originalEvent.touches.length)return didMultiTouch=!0,$(document).on("touchend.imathasdraw",drawMouseUp),!0;if(hasTouch?(window.clearTimeout(hasTouchTimer),$(document).off("mousemove.imathasdraw"),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(".drawcanvas").on("touchmove.imathasdraw",drawMouseMove),$(document).on("touchend.imathasdraw",drawMouseUp),$(document).on("touchcancel.imathasdraw",drawMouseUp)):($(document).on("mousemove.imathasdraw",drawMouseMove),$(document).on("mouseup.imathasdraw",drawMouseUp)),t=mouseCoords(e),null==curTarget||null==curLine&&null==curTPcurve&&null==curIneqcurve)for(i in targets)if(!$(targets[i].el).is(":hidden")&&"canvas"==targets[i].type&&(r=getPosition(targets[i].el)).x<t.x&&r.x+targets[i].width>t.x&&r.y<t.y&&r.y+targets[i].height>t.y&&e.target==targets[i].el){curTarget=i;break}if(null!=curTarget&&!targetOuts[curTarget].disabled)if(e.preventDefault(),mouseisdown=!0,r=getPosition(targets[curTarget].el),-1<(n={x:t.x-r.x,y:t.y-r.y}).x&&n.x<targets[curTarget].width&&-1<n.y&&n.y<targets[curTarget].height){if(0<targets[curTarget].snaptogridx&&(n=snaptogrid(n,curTarget)),1==drawlocky[curTarget]&&(n.y=targets[curTarget].imgheight/2),null!=(a=findnearpoint(curTarget,n))){if(-1==targets[curTarget].mode)return void deleteCurve(a[0],a[1]);(null!=curLine&&a[0]<1&&curLine!=a[1]||null!=curTPcurve&5<=a[0]&&a[0]<10&&curTPcurve!=a[1]||null!=curIneqcurve&&10<=a[0]&&a[0]<11&&curIneqcurve!=a[1])&&(a=null)}null==a?(setCursor("pendown"),1==targets[curTarget].mode?(dots[curTarget].push([n.x,n.y]),dragObj={mode:1,num:dots[curTarget].length-1}):2==targets[curTarget].mode?(odots[curTarget].push([n.x,n.y]),dragObj={mode:2,num:odots[curTarget].length-1}):0==targets[curTarget].mode||.7==targets[curTarget].mode?null==curLine?(lines[curTarget].push([[n.x,n.y]]),curLine=lines[curTarget].length-1):lines[curTarget][curLine].push([n.x,n.y]):.5==targets[curTarget].mode?null==curLine?(lines[curTarget].push([[n.x,n.y]]),curLine=lines[curTarget].length-1):(lines[curTarget][curLine].push([n.x,n.y]),dragObj=curLine=null):5<=targets[curTarget].mode&&targets[curTarget].mode<10?null==curTPcurve?(tplines[curTarget].push([[n.x,n.y]]),curTPcurve=tplines[curTarget].length-1,tptypes[curTarget][curTPcurve]=targets[curTarget].mode,mouseisdown=!1):(tplines[curTarget][curTPcurve].push([n.x,n.y]),tplines[curTarget][curTPcurve].length==tpModeN[targets[curTarget].mode]?(dragObj={mode:targets[curTarget].mode,num:curTPcurve,subnum:tpModeN[targets[curTarget].mode]-1},curTPcurve=null):mouseisdown=!1):10<=targets[curTarget].mode&&targets[curTarget].mode<11&&(null==curIneqcurve?(ineqlines[curTarget].push([[n.x,n.y]]),curIneqcurve=ineqlines[curTarget].length-1,ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode,mouseisdown=!1):(ineqlines[curTarget][curIneqcurve].push([n.x,n.y]),2==ineqlines[curTarget][curIneqcurve].length?dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:1}:3==ineqlines[curTarget][curIneqcurve].length&&(dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:2},curIneqcurve=null)))):0==a[0]||.5==a[0]?null==curLine?(setCursor("move"),dragObj={mode:targets[curTarget].mode,num:a[1],subnum:a[2]},oldpointpos=lines[curTarget][a[1]][a[2]],a[2]==lines[curTarget][a[1]].length-1&&0==targets[curTarget].mode?curLine=a[1]:0==a[2]&&0==targets[curTarget].mode&&(curLine=a[1],lines[curTarget][curLine].reverse(),dragObj.subnum=lines[curTarget][curLine].length-1),clickmightbenewcurve=!0):a[1]==curLine&&a[2]==lines[curTarget][a[1]].length-1?(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),curLine=null):1<targets[curTarget].dotline&&a[1]==curLine&&0==a[2]?(lines[curTarget][curLine].push(lines[curTarget][curLine][0]),curLine=null):(setCursor("pendown"),lines[curTarget][curLine].push([n.x,n.y])):1==a[0]?(setCursor("move"),dragObj={mode:1,num:a[1]}):2==a[0]?(setCursor("move"),dragObj={mode:2,num:a[1]}):5<=a[0]&&a[0]<10?null==curTPcurve&&(setCursor("move"),dragObj={mode:a[0],num:a[1],subnum:a[2]},oldpointpos=tplines[curTarget][a[1]][a[2]],clickmightbenewcurve=!0):10<=a[0]&&a[0]<11&&null==curIneqcurve&&(setCursor("move"),dragObj={mode:a[0],num:a[1],subnum:a[2]},oldpointpos=ineqlines[curTarget][a[1]][a[2]],clickmightbenewcurve=!0),drawTarget()}else null!=curLine&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),setCursor("pen")),null!=curTPcurve&&(tplines[curTarget][curTPcurve].length<tpModeN[targets[curTarget].mode]&&(tplines[curTarget].splice(curTPcurve,1),tptypes[curTarget].splice(curTPcurve,1)),setCursor("pen")),null!=curIneqcurve&&(ineqlines[curTarget][curIneqcurve].length<3&&(ineqlines[curTarget].splice(curIneqcurve,1),ineqtypes[curTarget].splice(curIneqcurve,1)),setCursor("pen")),dragObj=curIneqcurve=curTPcurve=curLine=null,drawTarget(),curTarget=null}function findnearpoint(e,t){var r,n,a;if(hasTouch?(r=Math.max(15*window.innerWidth/screen.width,15),r*=r):r=-1==targets[e].mode?50:25,0==targets[e].mode||.5==targets[e].mode||-1==targets[e].mode)for(n=lines[e].length-1;0<=n;n--)for(a=lines[e][n].length-1;0<=a;a--)if(Math.pow(lines[e][n][a][0]-t.x,2)+Math.pow(lines[e][n][a][1]-t.y,2)<r)return[-1==targets[e].mode?0:targets[e].mode,n,a];if(1==targets[e].mode||-1==targets[e].mode)for(n=dots[e].length-1;0<=n;n--)if(Math.pow(dots[e][n][0]-t.x,2)+Math.pow(dots[e][n][1]-t.y,2)<r)return[1,n];if(2==targets[e].mode||-1==targets[e].mode)for(n=odots[e].length-1;0<=n;n--)if(Math.pow(odots[e][n][0]-t.x,2)+Math.pow(odots[e][n][1]-t.y,2)<r)return[2,n];if(5<=targets[e].mode&&targets[e].mode<10||-1==targets[e].mode)for(n=tplines[e].length-1;0<=n;n--)for(a=tplines[e][n].length-1;0<=a;a--)if((tptypes[e][n]==targets[e].mode||-1==targets[e].mode)&&Math.pow(tplines[e][n][a][0]-t.x,2)+Math.pow(tplines[e][n][a][1]-t.y,2)<r)return[tptypes[e][n],n,a];if(10<=targets[e].mode&&targets[e].mode<11||-1==targets[e].mode)for(n=ineqlines[e].length-1;0<=n;n--)for(a=ineqlines[e][n].length-1;0<=a;a--)if((ineqtypes[e][n]==targets[e].mode||-1==targets[e].mode)&&Math.pow(ineqlines[e][n][a][0]-t.x,2)+Math.pow(ineqlines[e][n][a][1]-t.y,2)<r)return[ineqtypes[e][n],n,a];return null}function drawMouseUp(e){var t,r,n,a=mouseCoords(e);if(mouseisdown=!1,null!=curTarget){if(targetOuts[curTarget].disabled)return;t=getPosition(targets[curTarget].el),r={x:a.x-t.x,y:a.y-t.y},n=-1<(r=0<targets[curTarget].snaptogridx?snaptogrid(r,curTarget):r).x&&r.x<targets[curTarget].width&&-1<r.y&&r.y<targets[curTarget].height,1==clickmightbenewcurve&&(5<=targets[curTarget].mode&&targets[curTarget].mode<10?(tplines[curTarget].push([[r.x,r.y]]),curTPcurve=tplines[curTarget].length-1,tptypes[curTarget][curTPcurve]=targets[curTarget].mode):10<=targets[curTarget].mode&&targets[curTarget].mode<11&&(ineqlines[curTarget].push([[r.x,r.y]]),curIneqcurve=ineqlines[curTarget].length-1,ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode)),null!=lastdrawmouseup&&a.x==lastdrawmouseup.x&&a.y==lastdrawmouseup.y&&null!=curLine&&null==dragObj&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),dragObj=curLine=null,drawTarget()),null!=curLine&&null==dragObj&&(.5==targets[curTarget].mode&&1<lines[curTarget][curLine].length||.7==targets[curTarget].mode)&&(dragobj=curLine=null,drawTarget()),null!=curTPcurve&&tplines[curTarget][curTPcurve].length<tpModeN[targets[curTarget].mode]&&(didMultiTouch||!n?(tplines[curTarget].splice(curTPcurve,1),tptypes[curTarget].splice(curTPcurve,1),curTPcurve=null,drawTarget()):null==findnearpoint(curTarget,r)&&(tplines[curTarget][curTPcurve].push([r.x,r.y]),tplines[curTarget][curTPcurve].length==tpModeN[targets[curTarget].mode]&&(curTPcurve=null),drawTarget())),null!=curIneqcurve&&1==ineqlines[curTarget][curIneqcurve].length&&(didMultiTouch||!n?(ineqlines[curTarget].splice(curIneqcurve,1),ineqtypes[curTarget].splice(curIneqcurve,1),curIneqcurve=null,drawTarget()):null==findnearpoint(curTarget,r)&&(ineqlines[curTarget][curIneqcurve].push([r.x,r.y]),drawTarget())),setCursor(null==curLine&&null==curTPcurve?"move":"pen"),void 0!==e&&e.preventDefault()}lastdrawmouseup=a,null!=curTarget&&null!=dragObj&&(t=getPosition(targets[curTarget].el),-1<r.x&&r.x<targets[curTarget].width&&-1<r.y&&r.y<targets[curTarget].height?(0==dragObj.mode&&1<targets[curTarget].dotline&&(0!=dragObj.subnum&&dragObj.subnum!=lines[curTarget][dragObj.num].length-1||Math.pow(lines[curTarget][dragObj.num][0][0]-lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0],2)+Math.pow(lines[curTarget][dragObj.num][0][1]-lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1],2)<25&&(0==dragObj.subnum?(lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0]=lines[curTarget][dragObj.num][0][0],lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1]=lines[curTarget][dragObj.num][0][1]):(lines[curTarget][dragObj.num][0][0]=lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0],lines[curTarget][dragObj.num][0][1]=lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1]),curLine=null,drawTarget())),dragObj=null):(1==drawlocky[curTarget]&&(r.y=targets[curTarget].imgheight/2),1==dragObj.mode?dots[curTarget].splice(dragObj.num,1):2==dragObj.mode?odots[curTarget].splice(dragObj.num,1):.5==dragObj.mode?lines[curTarget].splice(dragObj.num,1):0==dragObj.mode?lines[curTarget][dragObj.num][dragObj.subnum]=oldpointpos:5<=dragObj.mode&&dragObj.mode<10?(tplines[curTarget].splice(dragObj.num,1),tptypes[curTarget].splice(dragObj.num,1),curTPcurve=null):10<=dragObj.mode&&dragObj.mode<11&&(ineqlines[curTarget].splice(dragObj.num,1),ineqtypes[curTarget].splice(dragObj.num,1),curIneqcurve=null),dragObj=null,drawTarget())),didMultiTouch=!1,hasTouch?hasTouchTimer=window.setTimeout(function(){hasTouch=!1,clearAllDrawListners(),$(document).on("mousemove.imathasdraw",drawMouseMove),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(document).on("mousedown.imathasdraw",drawMouseDown)},350):(clearAllDrawListners(),$(document).on("mousemove.imathasdraw",drawMouseMove),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(document).on("mousedown.imathasdraw",drawMouseDown))}function drawMouseMove(e){var t,r,n,a,s,g=null;for(i in clickmightbenewcurve=!1,t=mouseCoords(e),targets)if(!$(targets[i].el).is(":hidden")&&"canvas"==targets[i].type&&(r=getPosition(targets[i].el)).x<t.x&&r.x+targets[i].width>t.x&&r.y<t.y&&r.y+targets[i].height>t.y&&e.target==targets[i].el){g=i;break}if(null!=g){if(targetOuts[g].disabled)return;r=getPosition(targets[mouseintarget=g].el),n={x:t.x-r.x,y:t.y-r.y},0<targets[g].snaptogridx&&(n=snaptogrid(n,g)),1==drawlocky[g]&&(n.y=targets[g].imgheight/2),-1<n.x&&n.x<targets[g].width&&-1<n.y&&n.y<targets[g].height&&null==dragObj&&null==curLine&&(null==(a=findnearpoint(g,n))?setCursor("pen",g):-1!=targets[g].mode&&setCursor("move",g))}else null!=mouseintarget&&-1!=mouseintarget&&(null!=curTarget?drawTarget():(curTarget=mouseintarget,drawTarget(),curTarget=null),mouseintarget=-1);if(null!=curTarget){if(e.originalEvent.touches&&1<e.originalEvent.touches.length)return didMultiTouch=!0;if(void 0!==e&&e.preventDefault(),r=getPosition(targets[curTarget].el),n={x:t.x-r.x,y:t.y-r.y},0<targets[curTarget].snaptogridx&&(n=snaptogrid(n,curTarget)),1==drawlocky[curTarget]&&(n.y=targets[curTarget].imgheight/2),-1<n.x&&n.x<targets[curTarget].width&&-1<n.y&&n.y<targets[curTarget].height){if(null==dragObj){if(mouseisdown&&-1==targets[curTarget].mode)return void(null!=(a=findnearpoint(curTarget,n))&&deleteCurve(a[0],a[1]));null!=curLine?!mouseisdown||0!=targets[curTarget].mode&&.7!=targets[curTarget].mode?mouseisdown&&.5==targets[curTarget].mode?0==(s=lines[curTarget][curLine].length-1)?25<Math.pow(lines[curTarget][curLine][s][0]-n.x,2)+Math.pow(lines[curTarget][curLine][s][1]-n.y,2)?(lines[curTarget][curLine].push([n.x,n.y]),drawTarget()):drawTarget(n.x,n.y):(lines[curTarget][curLine][s]=[n.x,n.y],drawTarget()):drawTarget(n.x,n.y):(s=lines[curTarget][curLine].length-1,25<Math.pow(lines[curTarget][curLine][s][0]-n.x,2)+Math.pow(lines[curTarget][curLine][s][1]-n.y,2)?(lines[curTarget][curLine].push([n.x,n.y]),drawTarget()):drawTarget(n.x,n.y)):null!=curTPcurve||null!=curIneqcurve?mouseisdown?drawTarget():drawTarget(n.x,n.y):null==(a=findnearpoint(curTarget,n))?(setCursor("pen"),tpHasAsymp.hasOwnProperty(targets[curTarget].mode)&&null!==g&&drawTarget(n.x,n.y)):(drawTarget(),-1!=targets[curTarget].mode&&setCursor("move"))}else setCursor("move"),0==dragObj.mode||.5==dragObj.mode?lines[curTarget][dragObj.num][dragObj.subnum]=[n.x,n.y]:1==dragObj.mode?dots[curTarget][dragObj.num]=[n.x,n.y]:2==dragObj.mode?odots[curTarget][dragObj.num]=[n.x,n.y]:5<=dragObj.mode&&dragObj.mode<10?tplines[curTarget][dragObj.num][dragObj.subnum]=[n.x,n.y]:10<=dragObj.mode&&dragObj.mode<11&&(ineqlines[curTarget][dragObj.num][dragObj.subnum]=[n.x,n.y]),drawTarget();return!1}null==curIneqcurve||mouseisdown||drawTarget()}else null!=g&&-1!=mouseintarget&&(curTarget=g,tpHasAsymp.hasOwnProperty(targets[curTarget].mode)&&drawTarget(n.x,n.y),curTarget=null)}function setCursor(e,t){targets[t=t||curTarget].cursor!=e&&(targets[t].el.style.cursor="move"==e?e:"url("+staticroot+"/img/"+e+".cur), auto",targets[t].cursor=e)}function mouseCoords(e){var t,r,n;return e=e||window.event,hasTouch?{x:(n=e.originalEvent.changedTouches[0]||e.originalEvent.touches[0]).pageX,y:n.pageY}:e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:(n=document.documentElement,t=document.body,n=n&&(n.scrollTop||n.scrollLeft)?(r=n.scrollLeft,n.scrollTop):t?(r=t.scrollLeft,t.scrollTop):r=0,{x:e.clientX+r,y:e.clientY+n})}function snaptogrid(e,t){var r=e.x-targets[t].imgborder+targets[t].xmin*targets[t].pixperx,e=e.y-targets[t].imgborder-targets[t].ymax*targets[t].pixpery;return{x:Math.round(Math.round(r/(targets[t].pixperx*targets[t].snaptogridx))*targets[t].pixperx*targets[t].snaptogridx+targets[t].imgborder-targets[t].xmin*targets[t].pixperx),y:Math.round(Math.round(e/(targets[t].pixpery*targets[t].snaptogridy))*targets[t].pixpery*targets[t].snaptogridy+targets[t].imgborder+targets[t].ymax*targets[t].pixpery)}}function getMouseOffset(e,t){e=getPosition(e),t=mouseCoords(t);return{x:t.x-e.x,y:t.y-e.y}}function getPosition(e){if(e.className.match(/hidden/))return{x:-1e4,y:-1e4};e=$(e).offset();return{x:e.left,y:e.top}}function clearAllDrawListners(){$(document).off("mousedown.imathasdraw").off("mousemove.imathasdraw").off("mouseup.imathasdraw"),$(document).off("touchstart.imathasdraw").off("touchmove.imathasdraw").off("touchend.imathasdraw").off("touchcancel.imathasdraw"),$(".drawcanvas").off("touchstart.imathasdraw").off("touchmove.imathasdraw").off("touchend.imathasdraw").off("touchcancel.imathasdraw")}function initCanvases(e){var t,r,n,a,i;clearAllDrawListners(),$(document).on("mousemove.imathasdraw",drawMouseMove),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(document).on("mousedown.imathasdraw",drawMouseDown);try{CanvasRenderingContext2D.prototype.dashedLine=function(e,t,r,n,a){var i,s,g,u,l,o;for(null==a&&(a=10),this.beginPath(),this.moveTo(e,t),s=n-t,u=(i=r-e)/(g=Math.sqrt(i*i+s*s)/a),l=s/g,g=Math.floor(g),o=0;o++<g&&-1<t&&t<targets[curTarget].imgheight+1&&-1<e&&e<targets[curTarget].imgwidth+1;)this[o%2==0?"moveTo":"lineTo"](e+=u,t+=l);this[o%2==0?"moveTo":"lineTo"](r,n),this.stroke(),this.closePath()}}catch(e){}for(t in canvases)if(void 0===e||e==t){if((r=null)!=drawla[t]&&2<drawla[t].length){if(lines[canvases[t][0]]=drawla[t][0],dots[canvases[t][0]]=drawla[t][1],odots[canvases[t][0]]=drawla[t][2],tptypes[canvases[t][0]]=[],tplines[canvases[t][0]]=[],3<drawla[t].length&&0<drawla[t][3].length)for(n=0;n<drawla[t][3].length;n++)for(tptypes[canvases[t][0]][n]=drawla[t][3][n][0],tplines[canvases[t][0]][n]=[],a=0;a<tpModeN[tptypes[canvases[t][0]][n]];a++)tplines[canvases[t][0]][n].push(drawla[t][3][n].slice(1+2*a,3+2*a));if(ineqtypes[canvases[t][0]]=[],ineqlines[canvases[t][0]]=[],4<drawla[t].length&&0<drawla[t][4].length)for(n=0;n<drawla[t][4].length;n++)ineqtypes[canvases[t][0]][n]=drawla[t][4][n][0],ineqlines[canvases[t][0]][n]=[drawla[t][4][n].slice(1,3),drawla[t][4][n].slice(3,5),drawla[t][4][n].slice(5)];5<drawla[t].length&&(r=drawla[t][5])}else null!=drawla[t]&&"[[]]"==JSON.stringify(drawla[t])&&clearcanvas(canvases[t][0],!0);i="",canvases[t][1].match(/initPicture/)?i=canvases[t][1]:""!==canvases[t][1]&&(i=imasroot+"/filter/graph/imgs/"+canvases[t][1]),""!==canvases[t][13]?addA11yTarget(canvases[t],r,i):addTarget(canvases[t][0],"canvas"+canvases[t][0],i,"qn"+canvases[t][0],canvases[t][2],canvases[t][3],canvases[t][4],canvases[t][5],canvases[t][6],canvases[t][7],canvases[t][8],canvases[t][9],canvases[t][10],canvases[t][11],canvases[t][12])}}function addnormslider(e,t){-1==arraysearch(e,normslider.idnums)?(normslider.idnums.push(e),!0===t&&slideronpageload(e)):slideronpageload(e)}function slideronpageload(e){for(var t,r=0;r<normslider.idnums.length;r++)void 0!==e&&e!=normslider.idnums[r]||(initnormslider(t=normslider.idnums[r]),$("#slid1"+t).on("touchstart.normslider mousedown.normslider",onsliderstart),$("#slid2"+t).on("touchstart.normslider mousedown.normslider",onsliderstart))}function initnormslider(e){var t,r,n,a=document.getElementById("qn"+e).value,a=(n=a.match(/\(-oo,([\-\d\.]+)\)U\(([\-\d\.]+),oo\)/))?(t=3,r=n[1],n[2]):(n=a.match(/\(-oo,([\-\d\.]+)\)/))?(t=0,r=n[1],2.5):(n=a.match(/\(([\-\d\.]+),oo\)/))?(r=n[t=1],2.5):(n=a.match(/\(([\-\d\.]+),([\-\d\.]+)\)/))?(r=n[1],n[t=2]):(t=0,r=-1.5,2.5);document.getElementById("slid1"+e).style.left=60*r+250-6+"px",document.getElementById("slid2"+e).style.left=60*a+250-6+"px",document.getElementById("shaderegions"+e).selectedIndex=t,normslider.curslider.type=document.getElementById("shaderegions"+e).value,chgnormtype(e)}function onsliderstart(e){(e=e||window.event).originalEvent.touches&&0<e.originalEvent.touches.length?(hasTouch=!0,$(document).on("touchmove.normslider",onsliderchange),$(document).on("touchend.normslider",onsliderstop)):($(document).on("mousemove.normslider",onsliderchange),$(document).on("mouseup.normslider",onsliderstop)),normslider.curslider.el=e.target||e.srcElement,normslider.curslider.id=normslider.curslider.el.id.substring(5),normslider.curslider.type=document.getElementById("shaderegions"+normslider.curslider.id).value,normslider.curslider.outnode=document.getElementById(normslider.outputid),normslider.curslider.startpos=getMouseOffset(normslider.curslider.el,e),normslider.curslider.el.parentNode.style.cursor="pointer";getPosition(normslider.curslider.el.parentNode);return e.preventDefault&&e.preventDefault(),!1}function onsliderchange(e){var t,r=normslider.curslider.id;if(e=e||window.event,!((t=getMouseOffset(normslider.curslider.el.parentNode,e)).x<5||t.x>normslider.curslider.el.parentNode.offsetWidth-5||t.y<5||t.y>normslider.curslider.el.parentNode.offsetHeight-5))return t=6*Math.round((t.x-normslider.curslider.startpos.x-10)/6)+10,normslider.curslider.el.style.left=t+"px",normupdatevalues(r),e.preventDefault&&e.preventDefault(),!1}function onsliderstop(e){null!==normslider.curslider.el&&(hasTouch=!1,$(document).off("touchmove.normslider touchend.normslider"),$(document).off("mousemove.normslider mouseup.normslider"),normslider.curslider.el.parentNode.style.cursor="",normslider.curslider.el=null)}function normupdatevalues(e){var t,r,n=parseInt(document.getElementById("slid1"+e).style.left)+6,a=parseInt(document.getElementById("slid2"+e).style.left)+6,i=Math.min(n,a),s=Math.max(n,a);"2O"==normslider.curslider.type?document.getElementById("normleft"+e).style.width=i+1+"px":"1L"==normslider.curslider.type?document.getElementById("normleft"+e).style.width=n+1+"px":"2B"==normslider.curslider.type&&(document.getElementById("normleft"+e).style.left=i+"px",document.getElementById("normleft"+e).style.width=s-i+1+"px"),"2O"==normslider.curslider.type?document.getElementById("normright"+e).style.width=500-s+"px":"1R"==normslider.curslider.type&&(document.getElementById("normright"+e).style.width=500-n+"px"),i=((n-10)/60-4).toFixed(1),s=((a-10)/60-4).toFixed(1),(t=document.getElementById("slid1txt"+e)).innerHTML=i,t.style.left=n-6+"px",(t=document.getElementById("slid2txt"+e)).innerHTML=s,t.style.left=a-6+"px",n=Math.min(i,s),t=Math.max(i,s),"2O"==normslider.curslider.type?r="(-oo,"+n+")U("+t+",oo)":"2B"==normslider.curslider.type?r="("+n+","+t+")":"1L"==normslider.curslider.type?r="(-oo,"+i+")":"1R"==normslider.curslider.type&&(r="("+i+",oo)"),document.getElementById("qn"+e).value=r,$("#qn"+e).trigger("input").trigger("change")}function chgnormtype(e){var t,r,n,a=document.getElementById("shaderegions"+e).value;normslider.curslider.type=a,t=parseInt(document.getElementById("slid1"+e).style.left)+6,n=parseInt(document.getElementById("slid2"+e).style.left)+6,r=Math.min(t,n),n=Math.max(t,n),"1R"==a||"1L"==a?(document.getElementById("slid2"+e).style.display="none",document.getElementById("slid2txt"+e).style.display="none","1R"==a?(document.getElementById("normleft"+e).style.display="none",document.getElementById("normright"+e).style.display="",document.getElementById("normright"+e).style.right="0px",document.getElementById("normright"+e).style.width=500-t+"px"):(document.getElementById("normright"+e).style.display="none",document.getElementById("normleft"+e).style.display="",document.getElementById("normleft"+e).style.left="0px",document.getElementById("normleft"+e).style.width=t+"px")):"2O"==a?(document.getElementById("slid2"+e).style.display="",document.getElementById("slid2txt"+e).style.display="",document.getElementById("normleft"+e).style.display="",document.getElementById("normright"+e).style.display="",document.getElementById("normright"+e).style.right="0px",document.getElementById("normleft"+e).style.left="0px",document.getElementById("normright"+e).style.width=500-n+"px",document.getElementById("normleft"+e).style.width=r+"px"):"2B"==a&&(document.getElementById("slid2"+e).style.display="",document.getElementById("slid2txt"+e).style.display="",document.getElementById("normleft"+e).style.display="",document.getElementById("normright"+e).style.display="none",document.getElementById("normleft"+e).style.left=r+"px",document.getElementById("normleft"+e).style.width=n-r+"px"),normupdatevalues(e)}function dashedParabola(e,t,r,n,a,i,s){var g,u,l,o,c,d,T,p,h;if(a==r)e.moveTo(0,a),e.dashedLine(0,a,i,a);else{for(l=0,r<a&&(l=s),g=(a-r)/((n-t)*(n-t)),c=(-(u=-2*g*t)-(s=Math.sqrt(u*u-4*g*(o=g*t*t+r-l))))/(2*g),o+=l,(d=(-u+s)/(2*g))<c&&(a=c,c=d,d=a),T=t,p=r,h=0;c-5<T&&-5<T;)h%2==0?e.moveTo(T,p):e.lineTo(T,p),p=g*(T-=Math.min(Math.sqrt(64/(1+Math.pow(2*g*(T-t),2))),Math.sqrt(8/Math.abs(g))))*T+u*T+o,h++;for(T=t,p=r,h=0;T<d+5&&T<i+5;)h%2==0?e.moveTo(T,p):e.lineTo(T,p),p=g*(T+=Math.min(Math.sqrt(64/(1+Math.pow(2*g*(T-t),2))),Math.sqrt(8/Math.abs(g))))*T+u*T+o,h++}e.stroke()}function shadeParabola(e,t,r,n,a,i,s,g,u){var l,o,c,d,T,p;e.beginPath(),a==r?(e.moveTo(0,a),e.lineTo(g,a),s<r?(e.lineTo(g,0),e.lineTo(0,0)):(e.lineTo(g,u),e.lineTo(0,u))):(o=r<a?u:0,o=(a=(a-r)/((n-t)*(n-t)))*(l=(-(n=-2*a*t)-(c=Math.sqrt(n*n-4*a*(r=a*t*t+r-o))))/(2*a))*l+n*l+(r+=o),(c=(-n+c)/(2*a))<l&&(T=l,l=c,c=T),T=(T=2*a*(l-t))*(d=((p=(t=o)-T*l)-(t-(d=-T)*c))/(d-T))+p,a<0&&s<a*i*i+n*i+r||0<a&&a*i*i+n*i+r<s?(e.moveTo(l,o),e.quadraticCurveTo(d,T,c,t)):(p=u,Math.abs(o-u)<2&&(p=0),e.moveTo(0,o),e.lineTo(l,o),e.quadraticCurveTo(d,T,c,t),e.lineTo(g,t),e.lineTo(g,p),e.lineTo(0,p))),e.closePath()}return clickcnt=0,lastdrawmouseup=null,mouseintarget=-1,"undefined"!=typeof initstack?initstack.push(initCanvases):$(function(){initCanvases()}),normslider={idnums:[],curslider:{el:null,startpos:[0,0],outnode:null}},"undefined"!=typeof initstack&&initstack.push(slideronpageload),drawexport={reset:reset,initCanvases:initCanvases,clearcanvas:clearcanvas,clearlastline:clearlastline,settool:settool,addnormslider:addnormslider,chgnormtype:chgnormtype,adda11ydraw:adda11ydraw,changea11ydraw:changea11ydraw,encodea11ydraw:encodea11ydraw,updatea11ydraw:updatea11ydraw,removea11ydraw:removea11ydraw},drawexport}(jQuery);!function(){"use strict";function n(e,t){var r=e.length-1,n=[e[0]];return function e(t,r,n,a,i){for(var s,g,u,l,o,c,d,T,p=a,h=r+1;h<n;h++)g=t[h],u=t[r],l=t[n],T=d=c=o=void 0,c=u[0],u=u[1],d=l[0]-c,T=l[1]-u,0===d&&0===T||(1<(o=((g[0]-c)*d+(g[1]-u)*T)/(d*d+T*T))?(c=l[0],u=l[1]):0<o&&(c+=d*o,u+=T*o)),p<(l=(d=g[0]-c)*d+(T=g[1]-u)*T)&&(s=h,p=l);a<p&&(1<s-r&&e(t,r,s,a,i),i.push(t[s]),1<n-s&&e(t,s,n,a,i))}(e,0,r,t,n),n.push(e[r]),n}window.pathsimplify=function(e,t,r){return e.length<=2?e:(t=void 0!==t?t*t:1,e=n(e=r?e:function(e,t){for(var r,n,a,i,s=e[0],g=[s],u=1,l=e.length;u<l;u++)r=e[u],a=s,i=void 0,i=(n=r)[0]-a[0],n=n[1]-a[1],t<i*i+n*n&&(g.push(r),s=r);return s!==r&&g.push(r),g}(e,t),t))}}();