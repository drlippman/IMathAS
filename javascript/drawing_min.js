var canvases=new Array,drawla=new Array,imathasDraw=function($){var clickcnt,lastdrawmouseup,mouseintarget,normslider,drawexport,mouseisdown=!1,targets=new Array,imgs=new Array,targetOuts=new Array,lines=new Array,dots=new Array,odots=new Array,tplines=new Array,tptypes=new Array,ineqlines=new Array,ineqtypes=new Array,curLine=null,drawstyle=[],drawlocky=[],curTPcurve=null,curIneqcurve=null,ineqcolors=["rgb(0,0,255)","rgb(255,0,0)","rgb(0,255,0)"],ineqacolors=["rgba(0,0,255,.4)","rgba(255,0,0,.4)","rgba(0,255,0,.4)"],asymcolor="rgb(0,200,0)",dragObj=null,oldpointpos=null,curTarget=null,curCursor=null,nocanvaswarning=!1,hasTouch=!1,didMultiTouch=!1,clickmightbenewcurve=!1,hasTouchTimer=null,tpModeN={5:2,5.2:2,5.3:2,5.4:2,6:2,6.1:2,6.3:2,6.5:2,6.6:2,7:2,7.2:2,7.4:2,7.5:2,8:2,8.2:2,8.3:2,8.4:2,8.5:3,8.6:3,9:2,9.1:2,10:3,10.2:3,10.3:3,10.4:3},tpHasAsymp={7.4:1,7.5:1,8.2:1,8.5:1,8.6:1};function reset(){clearAllDrawListners(),targets.length=0,imgs.length=0,targetOuts.length=0,lines.length=0,dots.length=0,odots.length=0,tplines.length=0,tptypes.length=0,ineqlines.length=0,ineqtypes.length=0,drawstyle.length=0,drawlocky.length=0,curIneqcurve=curTPcurve=dragObj=curLine=curTarget=null}function clearcanvas(e,t){targetOuts[e]&&targetOuts[e].disabled&&!t||lines.hasOwnProperty(e)&&(lines[e].length=0,dots[e].length=0,odots[e].length=0,tplines[e].length=0,tptypes[e].length=0,ineqlines[e].length=0,ineqtypes[e].length=0,"canvas"==targets[curTarget=e].type&&drawTarget(),dragObj=curLine=curTarget=null)}function clearlastline(e){0<lines[e].length&&(lines[e].length=lines[e].length-1),curTarget=e,drawTarget(),dragObj=curLine=curTarget=null}function addA11yTarget(e,t,r){var n,a,i,s,g,u,l,o,c,d,T,p,h,m,y,w,f,v,b,q,x=e[0],M=e[13].split(","),O=!0;for("noprev"==M[M.length-1]&&(O=!1,M.pop()),n=e[2],a=e[3],(i=e[4])==(s=e[5])&&(i=-1,s=1),g=e[6],u=e[7],l=e[8],null==(o=document.getElementById("a11ydraw"+x))&&(c=document.getElementById("canvas"+x))&&!O&&(d=$("<div>").append($("<p>",{text:_("Drawn Elements:")})),(o=document.createElement("ul")).setAttribute("id","allydraw"+x),d.append(o),$(c).replaceWith(d)),targetOuts[x]=document.getElementById("qn"+x),T=!!document.getElementById("a11ydrawnew"+x),targetOuts[x].disabled&&(T&&(document.getElementById("a11ydrawnew"+x).disabled=!0),$(".a11ydrawadd[data-qn="+x+"]").prop("disabled",!0)),targets[x]={type:"a11y",el:o,vispreview:O,xmin:n,xmax:a,ymin:i,ymax:s,imgborder:g,imgwidth:u,imgheight:l},O&&(targets[x].canv=document.getElementById("canvas"+x)),targets[x].pixperx=(u-2*g)/(a-n),targets[x].pixpery=i==s?1:(l-2*g)/(s-i),"inequality"==M[0]?(p=M.shift(),0==M.length?M=["line"]:"both"==M[0]&&(M=["line","parab"])):"twopoint"==M[0]?(p=M.shift(),0==M.length&&(M=["line","parab","abs","circle","dot"])):"numberline"==M[0]?(p="basic",M.shift()):p="basic",targets[x].afgroup=p,h={inequality:{line:[{mode:10,descr:_("Linear inequality with solid line"),inN:3,input:_("Enter 2 points on the line, then a third point in the shaded region")},{mode:10.2,descr:_("Linear inequality with dashed line"),inN:3,input:_("Enter 2 points on the line, then a third point in the shaded region")}],parab:[{mode:10.3,descr:_("Parabolic inequality with solid line"),inN:3,input:_("Enter the vertex, then another point on the parabola, then a third point in the shaded region")},{mode:10.4,descr:_("Parabolic inequality with dashed line"),inN:3,input:_("Enter the vertex, then another point on the parabola, then a third point in the shaded region")}],abs:[{mode:10.5,descr:_("Absolute value inequality with solid line"),inN:3,input:_("Enter the corner point of the absolute value, then another point on the graph, then a third point in the shaded region")},{mode:10.6,descr:_("Absolute value inequality with dashed line"),inN:3,input:_("Enter the corner point of the absolute value, then another point on the graph, then a third point in the shaded region")}]},twopoint:{line:[{mode:5,descr:_("Line"),inN:2,input:_("Enter two points on the line")}],lineseg:[{mode:5.3,descr:_("Line segment"),inN:2,input:_("Enter the starting and ending point of the line segment")}],ray:[{mode:5.2,descr:_("Ray"),inN:2,input:_("Enter the starting point of the ray and another point on the ray")}],parab:[{mode:6,descr:_("Parabola"),inN:2,input:_("Enter the vertex, then another point on the parabola")}],horizparab:[{mode:6.1,descr:_("Parabola opening right or left"),inN:2,input:_("Enter the vertex, then another point on the parabola")}],cubic:[{mode:6.3,descr:_("Cubic"),inN:2,input:_("Enter the inflection point, then another point on the cubic")}],cuberoot:[{mode:6.6,descr:_("Cube root"),inN:2,input:_("Enter the inflection point of the cube root, then another point on the graph")}],abs:[{mode:8,descr:_("Absolute value"),inN:2,input:_("Enter the corner point of the absolute value, then another point on the graph")}],rational:[{mode:8.2,descr:_("Rational"),inN:2,input:_("Enter the point where the vertical and horizontal asymptote cross, then a point on the graph")}],exp:[{mode:8.3,descr:_("Exponential"),inN:2,input:_("Enter two points on the graph")}],log:[{mode:8.4,descr:_("Logarithm"),inN:2,input:_("Enter two points on the graph")}],genexp:[{mode:8.5,descr:_("Shifted Exponential"),inN:3,input:_("Enter a point on the asymptote, then enter two points on the graph")}],genlog:[{mode:8.6,descr:_("Shifted Logarithm"),inN:3,input:_("Enter a point on the asymptote, then enter two points on the graph")}],circle:[{mode:7,descr:_("Circle"),inN:2,input:_("Enter the center point of the circle, then a point on the graph")}],ellipse:[{mode:7.2,descr:_("Ellipse"),inN:2,input:_("Enter the center point of the ellipse, then a point offset from the center by the horizontal radius and vertical radius")}],hyperbola:[{mode:7.4,descr:_("Vertical hyperbola"),inN:2,input:_("Enter the center point of the hyperbola, then a point (x,y) where x is the x-coordinate of the co-vertex and y is the y-coordinate of the vertex")},{mode:7.5,descr:_("Horizontal hyperbola"),inN:2,input:_("Enter the center point of the hyperbola, then a point (x,y) where x is the x-coordinate of the vertex and y is the y-coordinate of the co-vertex")}],dot:[{mode:1,descr:_("Solid dot"),inN:1,input:_("Enter the coordinates of the dot")}],opendot:[{mode:2,descr:_("Open dot"),inN:1,input:_("Enter the coordinates of the dot")}],trig:[{mode:9,descr:_("Cosine"),inN:2,input:_("Enter a point at the start of a phase, then a point half a phase further")},{mode:9.1,descr:_("Sine"),inN:2,input:_("Enter a point at the start of a phase, then a point a quarter phase further")}],vector:[{mode:5.4,descr:_("Vector"),inN:2,input:_("Enter the starting and ending point of the vector")}]},basic:{line:[{mode:0,descr:_("Lines"),inN:"list",input:_("Enter a list of points to connect with lines")}],lineseg:[{mode:.5,descr:_("Line segment"),inN:2,input:_("Enter the starting and ending point of the line segment")}],freehand:[{mode:.7,descr:_("Freehand"),inN:"list",input:_("Enter a list of points to connect with lines")}],dot:[{mode:1,descr:_("Solid dot"),inN:1,input:_("Enter the coordinates of the dot")}],opendot:[{mode:2,descr:_("Open dot"),inN:1,input:_("Enter the coordinates of the dot")}],polygon:[{mode:0,descr:_("Polygon"),inN:"list",input:_("Enter a list of points for dots to connect with lines"),dotline:1}],closedpolygon:[{mode:0,descr:_("Polygon"),inN:"list",input:_("Enter a list of points for dots to connect with lines"),dotline:2}]}},null==lines[x]&&(lines[x]=new Array),null==dots[x]&&(dots[x]=new Array),null==odots[x]&&(odots[x]=new Array),null==tplines[x]&&(tplines[x]=new Array),null==tptypes[x]&&(tptypes[x]=new Array),null==ineqlines[x]&&(ineqlines[x]=new Array),null==ineqtypes[x]&&(ineqtypes[x]=new Array),y=[],w=[],f=[],b=0;b<M.length;b++)if(h[p].hasOwnProperty(M[b]))for(0==b&&(m=h[p][M[b]][0].mode),q=0;q<h[p][M[b]].length;q++)f[h[p][M[b]][q].mode]=h[p][M[b]][q],y.push(h[p][M[b]][q].mode),v='<option value="'+h[p][M[b]][q].mode+'"',v+=' data-af="'+M[b]+'">'+h[p][M[b]][q].descr+"</option>",w.push(v);if(T&&(document.getElementById("a11ydrawnew"+x).innerHTML=w),targets[x].defmode=m,targets[x].inputmodes=y,targets[x].selects=w,targets[x].moderef=f,T||!O)if(null==t&&lines.hasOwnProperty(x)){for(b=0;b<lines[x].length;b++)adda11ydraw(x,0,pixcoordstopointlist(lines[x][b],x));for(b=0;b<dots[x].length;b++)adda11ydraw(x,1,pixcoordstopointlist(dots[x][b],x));for(b=0;b<odots[x].length;b++)adda11ydraw(x,2,pixcoordstopointlist(odots[x][b],x));for(b=0;b<tplines[x].length;b++)adda11ydraw(x,tptypes[x][b],pixcoordstopointlist(tplines[x][b][0],x)+","+pixcoordstopointlist(tplines[x][b][1],x));for(b=0;b<ineqlines[x].length;b++)adda11ydraw(x,ineqtypes[x][b],pixcoordstopointlist(ineqlines[x][b][0],x)+","+pixcoordstopointlist(ineqlines[x][b][1],x)+","+pixcoordstopointlist(ineqlines[x][b][2],x))}else if(null!=t)for(b=0;b<t.length;b++)adda11ydraw(x,t[b][0],t[b][1].replace(/\[/g,"(").replace(/\]/g,")"));O&&initBackground(targets[x].canv,x,r,u,l,!0)}function adda11ydraw(e,t,r){var n,a=targets[e],i=t||document.getElementById("a11ydrawnew"+e).value,s=r||"",g=(a.afgroup,a.el.getElementsByTagName("li").length+1),u=targetOuts[e].disabled?" disabled ":"",l='<span class="sr-only draweln">'+_("Drawing element ")+g+"</span>";html=l,html+=a.moderef[i].descr+".<br/>",html+='<label><span class="a11ydrawinstr"></span><br/>',html+='<input type="text" value="'+s+'" data-n="'+a.moderef[i].inN+'" '+u,html+='onblur="imathasDraw.updatea11ydraw(this)"/></label>',html+='<button type="button" class="imgbutton" onclick="imathasDraw.removea11ydraw(this)"'+u+">",html+=_("Remove")+" "+l+"</button>",n=$("<li>",{class:"a11ydrawrow","data-mode":i}).html(html),$(a.el).append(n),n.find(".a11ydrawinstr").text(a.moderef[i].input),r||n.find("input").focus()}function removea11ydraw(e){setariastatus(_("Removed drawing element"));var t=$(e).closest("ul");$(e).parent().remove(),t.find("li").each(function(e,t){var r=_("Drawing element ")+(e+1);$(t).find(".draweln").html(r)}),t.prev().focus(),encodea11ydraw(t.attr("id").substring(8))}function changea11ydraw(e,t){var r=$(e).val(),n=targets[t].moderef[r];$(e).closest("li").find(".a11ydrawinstr").text(n.input),encodea11ydraw()}function updatea11ydraw(e){var t,r,n,a,i,s,g=0,u=e.value.trim();for("("==u.charAt(0)&&")"==u.slice(-1)||(g|=1),t=u.slice(1,-1).split(/\)\s*,\s*\(/),(r=e.getAttribute("data-n")).match(/\d/)&&t.length!=parseInt(r)&&(g|=2),n=0;n<t.length;n++)for(2!=(a=t[n].split(/,/)).length&&(g|=1),i=0;i<a.length;i++)0==a[i].trim().length&&(g|=1);"noticetext"==e.parentNode.parentNode.lastChild.className&&e.parentNode.parentNode.removeChild(e.parentNode.parentNode.lastChild),g?(e.setAttribute("aria-invalid",!0),(s=document.createElement("span")).id=uniqid("a11ydrawerr"),s.className="noticetext",1==(1&g)?(s.innerHTML="<br>"+_("Error: Invalid format for points. Give points as open parenthesis number comma number close parenthesis. Separate points with a comma."),setariastatus(_("Error: Invalid format for points"))):(s.innerHTML="<br>"+_("Error: Incorrect number of points. Expecting ")+r,setariastatus(_("Error: Incorrect number of points"))),e.parentNode.parentNode.appendChild(s),e.setAttribute("aria-describedby",s.id)):(e.removeAttribute("aria-invalid"),e.removeAttribute("aria-describedby"),setariastatus("")),encodea11ydraw(parseInt($(e).closest(".a11ydraw").attr("id").substring(8)))}function pixcoordstopointlist(e,t){var r=targets[t],n=(e[0]-r.imgborder)/r.pixperx+r.xmin,a=(r.imgheight-e[1]-r.imgborder)/r.pixpery+r.ymin;return"("+(n=Math.round(100*n)/100)+","+(a=Math.round(100*a)/100)+")"}function encodea11ydraw(qn){var tarnum,thistarg,enclines,encdots,encodots,enctplines,enctpineq,saveinput,afgroup;for(tarnum in void 0===qn&&(qn=-1),targets)-1<qn&&qn!=tarnum||(thistarg=targets[tarnum],"a11y"==thistarg.type&&(-1<qn&&qn==tarnum&&(curTarget=tarnum),lines[tarnum].length=0,dots[tarnum].length=0,odots[tarnum].length=0,tplines[tarnum].length=0,tptypes[tarnum].length=0,ineqlines[tarnum].length=0,ineqtypes[tarnum].length=0,enclines=[],encdots=[],encodots=[],enctplines=[],enctpineq=[],saveinput=[],afgroup=targets[tarnum].afgroup,$("#a11ydraw"+tarnum).find(".a11ydrawrow").each(function(i,el){var outpts,outptsraw,input=$(el).find("input").val(),mode=el.getAttribute("data-mode");for(saveinput.push("["+mode+',"'+input+'"]'),input=input.replace(/[\(\)]/g,"").split(/\s*,\s*/),outpts=[],outptsraw=[],i=1;i<input.length;i+=2){try{input[i-1]=eval(prepWithMath(mathjs(input[i-1])))}catch(e){input[i-1]=NaN}try{input[i]=eval(prepWithMath(mathjs(input[i])))}catch(e){input[i]=NaN}input[i-1]=(input[i-1]-thistarg.xmin)*thistarg.pixperx+thistarg.imgborder,input[i]=thistarg.imgheight-(input[i]-thistarg.ymin)*thistarg.pixpery-thistarg.imgborder,outpts.push(Math.round(input[i-1])+","+Math.round(input[i])),outptsraw.push([input[i-1],input[i]])}1==mode?(encdots.push("("+outpts.join("),(")+")"),dots[tarnum].push(outptsraw)):2==mode?(encodots.push("("+outpts.join("),(")+")"),odots[tarnum].push(outptsraw)):mode<1?(enclines.push("("+outpts.join("),(")+")"),lines[tarnum].push(outptsraw)):5<=mode&&mode<10&&2==outpts.length?(enctplines.push("("+mode+","+outpts.join(",")+")"),tplines[tarnum].push(outptsraw),tptypes[tarnum].push(mode)):10<=mode&&3==outpts.length&&(enctpineq.push("("+mode+","+outpts.join(",")+")"),ineqlines[tarnum].push(outptsraw),ineqtypes[tarnum].push(mode))}),targetOuts[tarnum].value=enclines.join(";")+";;"+encdots.join(",")+";;"+encodots.join(",")+";;"+enctplines.join(",")+";;"+enctpineq.join(",")+";;"+saveinput.join(","),$(targetOuts[tarnum]).trigger("input").trigger("change")));-1<qn&&targets[qn].vispreview&&drawTarget(null,null,!0),curTarget=null}function addTarget(e,t,r,n,a,i,s,g,u,l,o,c,d,T,p){var h,m=document.getElementById(t);$(m).is(":hidden")&&$(m).on("mouseover.imathasdrawwait touchstart.imathasdrawwait",function(){$(m).off("mouseover.imathasdrawwait touchstart.imathasdrawwait"),initCanvases(e)}),m.style.userSelect="none",m.style.webkitUserSelect="none",m.style.MozUserSelect="none",h=getPosition(m),targets[e]={type:"canvas",el:m,left:h.x,top:h.y,width:m.offsetWidth,height:m.offsetHeight,xmin:a,xmax:i,ymin:s,ymax:g,imgborder:u,imgwidth:l,imgheight:o,mode:c,dotline:d},"string"==typeof p&&-1!=p.indexOf(":")?(p=p.split(":"),targets[e].snaptogridx=1*p[0],targets[e].snaptogridy=1*p[1]):(targets[e].snaptogridx=1*p,targets[e].snaptogridy=1*p),targets[e].pixperx=(l-2*u)/(i-a),targets[e].pixpery=s==g?1:(o-2*u)/(g-s),targetOuts[e]=document.getElementById(n),null==lines[e]&&(lines[e]=new Array),null==dots[e]&&(dots[e]=new Array),null==odots[e]&&(odots[e]=new Array),null==tplines[e]&&(tplines[e]=new Array),null==tptypes[e]&&(tptypes[e]=new Array),null==ineqlines[e]&&(ineqlines[e]=new Array),null==ineqtypes[e]&&(ineqtypes[e]=new Array),drawstyle[e]=5<=c?1:0,drawlocky[e]=T,initBackground(m,e,r,l,o,!1)}function initBackground(e,t,r,n,a,i){var s;r.match(/initPicture/)?(0==$(e).closest(".drawcanvasholder").length&&($(e).removeClass("drawcanvas").wrap($("<div>",{class:"drawcanvas",style:"position:relative;width:"+n+"px;height:"+a+"px"})).wrap($("<div>",{class:"drawcanvasholder",style:"position:absolute;top:0;left:0;z-index:2"})),$(e).closest(".drawcanvas").prepend($("<div>",{class:"canvasbg",style:"position:absolute;top:0;left:0"}).append($("<embed>",{"data-nomag":1,type:"image/svg+xml",align:"middle",width:n,height:a,script:r}).attr("width",n).attr("height",a)))),imgs[t]=null,s=curTarget,curTarget=t,drawTarget(null,null,i),setTimeout(function(){window.drawPics($(e).closest(".drawcanvas")[0])},30),curTarget=s):""!==r?(imgs[t]=new Image,imgs[t].onload=function(){var e=curTarget;curTarget=t,drawTarget(null,null,i),curTarget=e},imgs[t].src=r):(imgs[t]=null,s=curTarget,curTarget=t,drawTarget(null,null,i),curTarget=s)}function settool(e,t,r){var n,a=document.getElementById("drawtools"+t),i=a.getElementsByTagName("span");for(n=0;n<i.length;n++)i[n].className="";for(i=a.getElementsByTagName("img"),n=0;n<i.length;n++)i[n].className="";e.className="sel",setDrawMode(t,r),curTarget=t,drawTarget()}function setDrawMode(e,t){targets[e].mode=t}function setDotLine(e,t){targets[e].dotline=t}function drawTarget(e,t,r){var n,a,i,s,g,u,l,o,c,d,T,p,h,m,y,w,f,v,b,q,x,M,O,L,j,P,E,I,_,N,B,k,$,C,A,S,D,W,R,H,z,U,F,Y,X,V,G,J,Q,K,Z,ee,te,re;try{n=targets[curTarget].canv?targets[curTarget].canv.getContext("2d"):targets[curTarget].el.getContext("2d")}catch(e){nocanvaswarning||(nocanvaswarning=!0,alert("Your browser does not support drawing answer entry.  Please try again using Internet Explorer 6+ (Windows), FireFox 1.5+ (Win/Mac), Safari 1.3+ (Mac), Opera 9+ (Win/Mac), or Camino (Mac)"))}for(n.fillStyle="rgb(0,0,255)",n.lineWidth=2,n.strokeStyle="rgb(0,0,255)",n.clearRect(0,0,targets[curTarget].imgwidth,targets[curTarget].imgheight),null!==imgs[curTarget]&&n.drawImage(imgs[curTarget],0,0),n.beginPath(),a=0;a<ineqlines[curTarget].length;a++){if(i=a%3,n.strokeStyle=ineqcolors[i],n.fillStyle=ineqcolors[i],o=l=u=g=s=null,3==ineqlines[curTarget][a].length?(g=ineqlines[curTarget][a][1][0],l=ineqlines[curTarget][a][1][1],u=ineqlines[curTarget][a][2][0],o=ineqlines[curTarget][a][2][1]):2==ineqlines[curTarget][a].length?(g=ineqlines[curTarget][a][1][0],l=ineqlines[curTarget][a][1][1],u=e,o=t):curIneqcurve==a&&null!=e&&1==ineqlines[curTarget][a].length&&(g=e,l=t),null!=u&&(n.save(),n.fillStyle=ineqacolors[i],n.beginPath(),ineqtypes[curTarget][a]<=10.2?(g!=ineqlines[curTarget][a][0][0]&&(s=(l-ineqlines[curTarget][a][0][1])/(g-ineqlines[curTarget][a][0][0])),Math.abs(g-ineqlines[curTarget][a][0][0])<1||100<Math.abs(s)?(n.moveTo(ineqlines[curTarget][a][0][0],0),n.lineTo(ineqlines[curTarget][a][0][0],targets[curTarget].imgheight),g<u?(n.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),n.lineTo(targets[curTarget].imgwidth,0)):(n.lineTo(0,targets[curTarget].imgheight),n.lineTo(0,0))):(c=s*(u-g)+l,d=ineqlines[curTarget][a][0][1]-s*ineqlines[curTarget][a][0][0],T=ineqlines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-ineqlines[curTarget][a][0][0]),n.moveTo(0,d),n.lineTo(targets[curTarget].imgwidth,T),c<o?(n.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),n.lineTo(0,targets[curTarget].imgheight)):(n.lineTo(targets[curTarget].imgwidth,0),n.lineTo(0,0))),n.closePath()):ineqtypes[curTarget][a]<=10.4?shadeParabola(n,ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],g,l,u,o,targets[curTarget].imgwidth,targets[curTarget].imgheight):1<Math.abs(g-ineqlines[curTarget][a][0][0])&&(s=(l-ineqlines[curTarget][a][0][1])/(g-ineqlines[curTarget][a][0][0]),g<ineqlines[curTarget][a][0][0]&&(s*=-1),c=s*Math.abs(u-ineqlines[curTarget][a][0][0])+ineqlines[curTarget][a][0][1],d=ineqlines[curTarget][a][0][1]+s*ineqlines[curTarget][a][0][0],T=ineqlines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-ineqlines[curTarget][a][0][0]),c<o?(n.moveTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),n.lineTo(0,targets[curTarget].imgheight)):(n.moveTo(targets[curTarget].imgwidth,0),n.lineTo(0,0)),n.lineTo(0,d),n.lineTo(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1]),n.lineTo(targets[curTarget].imgwidth,T)),n.fill(),n.restore()),n.beginPath(),null!=g&&(ineqtypes[curTarget][a]<=10.2?(g!=ineqlines[curTarget][a][0][0]&&(s=(l-ineqlines[curTarget][a][0][1])/(g-ineqlines[curTarget][a][0][0])),Math.abs(g-ineqlines[curTarget][a][0][0])<1||100<Math.abs(s)?10.2==ineqtypes[curTarget][a]?null!=dragObj&&10<=dragObj.mode&&dragObj.mode<11&&dragObj.num==a&&0==dragObj.subnum?(n.dashedLine(ineqlines[curTarget][a][1][0],ineqlines[curTarget][a][1][1],ineqlines[curTarget][a][1][0],targets[curTarget].imgheight),n.dashedLine(ineqlines[curTarget][a][1][0],ineqlines[curTarget][a][1][1],ineqlines[curTarget][a][1][0],0)):(n.dashedLine(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],ineqlines[curTarget][a][0][0],targets[curTarget].imgheight),n.dashedLine(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],ineqlines[curTarget][a][0][0],0)):(n.moveTo(ineqlines[curTarget][a][0][0],0),n.lineTo(ineqlines[curTarget][a][0][0],targets[curTarget].imgheight),n.stroke()):(d=ineqlines[curTarget][a][0][1]-s*ineqlines[curTarget][a][0][0],T=ineqlines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-ineqlines[curTarget][a][0][0]),10.2==ineqtypes[curTarget][a]?null!=dragObj&&10<=dragObj.mode&&dragObj.mode<11&&dragObj.num==a&&0==dragObj.subnum?(n.dashedLine(ineqlines[curTarget][a][1][0],ineqlines[curTarget][a][1][1],targets[curTarget].imgwidth,T),n.dashedLine(ineqlines[curTarget][a][1][0],ineqlines[curTarget][a][1][1],0,d)):(n.dashedLine(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],targets[curTarget].imgwidth,T),n.dashedLine(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],0,d)):(n.moveTo(0,d),n.lineTo(targets[curTarget].imgwidth,T),n.stroke()))):ineqtypes[curTarget][a]<=10.4?10.3==ineqtypes[curTarget][a]?(g!=ineqlines[curTarget][a][0][0]&&(l==ineqlines[curTarget][a][0][1]?(n.moveTo(0,l),n.lineTo(targets[curTarget].imgwidth,l)):(p=(l-ineqlines[curTarget][a][0][1])/((g-ineqlines[curTarget][a][0][0])*(g-ineqlines[curTarget][a][0][0])),w=l>ineqlines[curTarget][a][0][1]?(h=Math.sqrt((targets[curTarget].imgheight-ineqlines[curTarget][a][0][1])/p)+ineqlines[curTarget][a][0][0],m=-1*Math.sqrt((targets[curTarget].imgheight-ineqlines[curTarget][a][0][1])/p)+ineqlines[curTarget][a][0][0],y=ineqlines[curTarget][a][0][1]-(targets[curTarget].imgheight-ineqlines[curTarget][a][0][1]),targets[curTarget].imgheight):(h=Math.sqrt((0-ineqlines[curTarget][a][0][1])/p)+ineqlines[curTarget][a][0][0],m=-1*Math.sqrt((0-ineqlines[curTarget][a][0][1])/p)+ineqlines[curTarget][a][0][0],y=2*ineqlines[curTarget][a][0][1],0),b=(f=h+2/3*(ineqlines[curTarget][a][0][0]-h))+(m-h)/3,q=v=w+2/3*(y-w),n.moveTo(h,w),n.bezierCurveTo(f,v,b,q,m,w))),n.stroke()):g!=ineqlines[curTarget][a][0][0]&&dashedParabola(n,ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],g,l,targets[curTarget].imgwidth,targets[curTarget].imgheight):g!=ineqlines[curTarget][a][0][0]&&(s=(l-ineqlines[curTarget][a][0][1])/(g-ineqlines[curTarget][a][0][0]),g<ineqlines[curTarget][a][0][0]&&(s*=-1),d=ineqlines[curTarget][a][0][1]+s*ineqlines[curTarget][a][0][0],T=ineqlines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-ineqlines[curTarget][a][0][0]),10.6==ineqtypes[curTarget][a]?(null!=dragObj&&10<=dragObj.mode&&dragObj.mode<11&&dragObj.num==a&&dragObj.subnum,n.dashedLine(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],targets[curTarget].imgwidth,T),n.dashedLine(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1],0,d)):(n.moveTo(0,d),n.lineTo(ineqlines[curTarget][a][0][0],ineqlines[curTarget][a][0][1]),n.lineTo(targets[curTarget].imgwidth,T),n.stroke()))),ineqtypes[curTarget][a]==targets[curTarget].mode){for(n.beginPath(),x=0;x<ineqlines[curTarget][a].length;x++)2==x?(n.arc(ineqlines[curTarget][a][x][0],ineqlines[curTarget][a][x][1],4,0,2*Math.PI,!0),n.fill()):n.fillRect(ineqlines[curTarget][a][x][0]-3,ineqlines[curTarget][a][x][1]-3,6,6);1==ineqlines[curTarget][a].length&&null!=g&&n.fillRect(g-3,l-3,6,6)}n.beginPath()}for(n.fillStyle="rgb(0,0,255)",1==drawlocky[curTarget]?n.lineWidth=4:n.lineWidth=2,n.strokeStyle="rgb(0,0,255)",a=0;a<tplines[curTarget].length;a++){if(5<=tptypes[curTarget][a]&&tptypes[curTarget][a]<6)l=g=s=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&(5.3==tptypes[curTarget][a]||5.4==tptypes[curTarget][a]?(n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),n.lineTo(g,l),5.4==tptypes[curTarget][a]&&(M=[g-tplines[curTarget][a][0][0],l-tplines[curTarget][a][0][1]],1e-4<(L=Math.sqrt(M[0]*M[0]+M[1]*M[1]))&&(O=[-(M=[M[0]/L,M[1]/L])[1],M[0]],n.moveTo(g-15*M[0]-4*O[0],l-15*M[1]-5*O[1]),n.lineTo(g,l),n.moveTo(g-15*M[0]+4*O[0],l-15*M[1]+5*O[1]),n.lineTo(g,l)))):(g!=tplines[curTarget][a][0][0]&&(s=(l-tplines[curTarget][a][0][1])/(g-tplines[curTarget][a][0][0])),Math.abs(g-tplines[curTarget][a][0][0])<1||100<Math.abs(s)?5.2==tptypes[curTarget][a]?(n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),l>tplines[curTarget][a][0][1]?n.lineTo(tplines[curTarget][a][0][0],targets[curTarget].imgheight):n.lineTo(tplines[curTarget][a][0][0],0)):(n.moveTo(tplines[curTarget][a][0][0],0),n.lineTo(tplines[curTarget][a][0][0],targets[curTarget].imgheight)):(d=tplines[curTarget][a][0][1]-s*tplines[curTarget][a][0][0],T=tplines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]),d=tplines[curTarget][a][0][1]-s*tplines[curTarget][a][0][0],T=tplines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]),5.2==tptypes[curTarget][a]?(n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),g>tplines[curTarget][a][0][0]?n.lineTo(targets[curTarget].imgwidth,T):n.lineTo(0,d)):(n.moveTo(0,d),n.lineTo(targets[curTarget].imgwidth,T)))));else if(6==tptypes[curTarget][a]||6.1==tptypes[curTarget][a])g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&(6==tptypes[curTarget][a]?l==tplines[curTarget][a][0][1]?(n.moveTo(0,l),n.lineTo(targets[curTarget].imgwidth,l)):g==tplines[curTarget][a][0][0]?(n.moveTo(g,tplines[curTarget][a][0][1]),l>tplines[curTarget][a][0][1]?n.lineTo(g,targets[curTarget].imgheight):n.lineTo(g,0)):(p=(l-tplines[curTarget][a][0][1])/((g-tplines[curTarget][a][0][0])*(g-tplines[curTarget][a][0][0])),w=l>tplines[curTarget][a][0][1]?(h=Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][a][0][1])/p)+tplines[curTarget][a][0][0],m=-1*Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][a][0][1])/p)+tplines[curTarget][a][0][0],y=tplines[curTarget][a][0][1]-(targets[curTarget].imgheight-tplines[curTarget][a][0][1]),targets[curTarget].imgheight):(h=Math.sqrt((0-tplines[curTarget][a][0][1])/p)+tplines[curTarget][a][0][0],m=-1*Math.sqrt((0-tplines[curTarget][a][0][1])/p)+tplines[curTarget][a][0][0],y=2*tplines[curTarget][a][0][1],0),b=(f=h+2/3*(tplines[curTarget][a][0][0]-h))+(m-h)/3,q=v=w+2/3*(y-w),n.moveTo(h,w),n.bezierCurveTo(f,v,b,q,m,w)):6.1==tptypes[curTarget][a]&&(g==tplines[curTarget][a][0][0]?(n.moveTo(g,0),n.lineTo(g,targets[curTarget].imgheight)):l==tplines[curTarget][a][0][1]?(n.moveTo(tplines[curTarget][a][0][0],l),g>tplines[curTarget][a][0][0]?n.lineTo(targets[curTarget].imgwidth,l):n.lineTo(0,l)):(p=(g-tplines[curTarget][a][0][0])/((l-tplines[curTarget][a][0][1])*(l-tplines[curTarget][a][0][1])),P=g>tplines[curTarget][a][0][0]?(h=Math.sqrt((targets[curTarget].imgwidth-tplines[curTarget][a][0][0])/p)+tplines[curTarget][a][0][1],m=-1*Math.sqrt((targets[curTarget].imgwidth-tplines[curTarget][a][0][0])/p)+tplines[curTarget][a][0][1],j=tplines[curTarget][a][0][0]-(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]),targets[curTarget].imgwidth):(h=Math.sqrt((0-tplines[curTarget][a][0][0])/p)+tplines[curTarget][a][0][1],m=-1*Math.sqrt((0-tplines[curTarget][a][0][0])/p)+tplines[curTarget][a][0][1],j=2*tplines[curTarget][a][0][0],0),q=(v=h+2/3*(tplines[curTarget][a][0][1]-h))+(m-h)/3,b=f=P+2/3*(j-P),n.moveTo(P,h),n.bezierCurveTo(f,v,b,q,P,m))));else if(6.5==tptypes[curTarget][a]){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&g!=tplines[curTarget][a][0][0])if(l==tplines[curTarget][a][0][1])n.moveTo(tplines[curTarget][a][0][0],l),g>tplines[curTarget][a][0][0]?n.lineTo(targets[curTarget].imgwidth,l):n.lineTo(0,l);else for(E=g<tplines[curTarget][a][0][0]?-1:1,p=(l-tplines[curTarget][a][0][1])/Math.sqrt(E*(g-tplines[curTarget][a][0][0])),n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),_=tplines[curTarget][a][0][0],I=tplines[curTarget][a][0][1];_+=3*E,n.lineTo(_,p*Math.sqrt(E*(_-tplines[curTarget][a][0][0]))+tplines[curTarget][a][0][1]),0<_&&_<targets[curTarget].imgwidth&&0<I&&I<targets[curTarget].imgheight;);}else if(6.3==tptypes[curTarget][a]){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&g!=tplines[curTarget][a][0][0])if(l==tplines[curTarget][a][0][1])n.moveTo(0,l),n.lineTo(targets[curTarget].imgwidth,l);else for(p=(l-tplines[curTarget][a][0][1])/safepow(g-tplines[curTarget][a][0][0],3),_=I=0;_<targets[curTarget].imgwidth+4;_+=1)(I=p*safepow(_-tplines[curTarget][a][0][0],3)+tplines[curTarget][a][0][1])<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),0==_?n.moveTo(_,I):n.lineTo(_,I)}else if(6.6==tptypes[curTarget][a]){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&g!=tplines[curTarget][a][0][0])if(l==tplines[curTarget][a][0][1])n.moveTo(0,l),n.lineTo(targets[curTarget].imgwidth,l);else for(p=(l-tplines[curTarget][a][0][1])/safepow(g-tplines[curTarget][a][0][0],1/3),_=I=0;_<targets[curTarget].imgwidth+4;_+=1)(I=p*safepow(_-tplines[curTarget][a][0][0],1/3)+tplines[curTarget][a][0][1])<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),0==_?n.moveTo(_,I):n.lineTo(_,I)}else if(7<=tptypes[curTarget][a]&&tptypes[curTarget][a]<8){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&(g!=tplines[curTarget][a][0][0]||l!=tplines[curTarget][a][0][1]))if(7==tptypes[curTarget][a])N=Math.sqrt((g-tplines[curTarget][a][0][0])*(g-tplines[curTarget][a][0][0])+(l-tplines[curTarget][a][0][1])*(l-tplines[curTarget][a][0][1])),n.arc(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],N,0,2*Math.PI,!0);else if(7.2==tptypes[curTarget][a])B=Math.abs(g-tplines[curTarget][a][0][0]),k=Math.abs(l-tplines[curTarget][a][0][1]),(curTPcurve==a||null!=dragObj&&dragObj.num==a)&&(n.strokeStyle="rgb(0,255,255)",n.lineWidth=1,n.dashedLine(g,l,g-2*(g-tplines[curTarget][a][0][0]),l,5),n.dashedLine(g,l,g,l-2*(l-tplines[curTarget][a][0][1]),5),n.dashedLine(g,l-2*(l-tplines[curTarget][a][0][1]),g-2*(g-tplines[curTarget][a][0][0]),l-2*(l-tplines[curTarget][a][0][1]),5),n.dashedLine(g-2*(g-tplines[curTarget][a][0][0]),l,g-2*(g-tplines[curTarget][a][0][0]),l-2*(l-tplines[curTarget][a][0][1]),5),n.lineWidth=2),n.strokeStyle="rgb(0,0,255)",n.save(),n.beginPath(),n.translate(tplines[curTarget][a][0][0]-B,tplines[curTarget][a][0][1]-k),n.scale(B,k),n.arc(1,1,1,0,2*Math.PI,!1),n.restore();else if(7.4==tptypes[curTarget][a]){for($=Math.abs(g-tplines[curTarget][a][0][0]),C=Math.abs(l-tplines[curTarget][a][0][1]),A=Math.abs(C/$),n.strokeStyle=asymcolor,n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],targets[curTarget].imgwidth,tplines[curTarget][a][0][1]+A*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0])),n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],targets[curTarget].imgwidth,tplines[curTarget][a][0][1]-A*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0])),n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],0,tplines[curTarget][a][0][1]-A*tplines[curTarget][a][0][0]),n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],0,tplines[curTarget][a][0][1]+A*tplines[curTarget][a][0][0]),(curTPcurve==a||null!=dragObj&&dragObj.num==a)&&(n.strokeStyle="rgb(0,255,255)",n.lineWidth=1,n.dashedLine(g,l,g-2*(g-tplines[curTarget][a][0][0]),l,5),n.dashedLine(g,l,g,l-2*(l-tplines[curTarget][a][0][1]),5),n.dashedLine(g,l-2*(l-tplines[curTarget][a][0][1]),g-2*(g-tplines[curTarget][a][0][0]),l-2*(l-tplines[curTarget][a][0][1]),5),n.dashedLine(g-2*(g-tplines[curTarget][a][0][0]),l,g-2*(g-tplines[curTarget][a][0][0]),l-2*(l-tplines[curTarget][a][0][1]),5),n.lineWidth=2),n.beginPath(),n.strokeStyle="rgb(0,0,255)",_=0;_<targets[curTarget].imgwidth+4;_+=3)(I=tplines[curTarget][a][0][1]+Math.sqrt((Math.pow(_-tplines[curTarget][a][0][0],2)/($*$)+1)*C*C))<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),0==_?n.moveTo(_,I):n.lineTo(_,I);for(n.stroke(),n.beginPath(),_=0;_<targets[curTarget].imgwidth+4;_+=3)(I=tplines[curTarget][a][0][1]-Math.sqrt((Math.pow(_-tplines[curTarget][a][0][0],2)/($*$)+1)*C*C))<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),0==_?n.moveTo(_,I):n.lineTo(_,I)}else if(7.5==tptypes[curTarget][a]){for(C=Math.abs(g-tplines[curTarget][a][0][0]),$=Math.abs(l-tplines[curTarget][a][0][1]),A=Math.abs($/C),n.strokeStyle=asymcolor,n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],targets[curTarget].imgwidth,tplines[curTarget][a][0][1]+A*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0])),n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],targets[curTarget].imgwidth,tplines[curTarget][a][0][1]-A*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0])),n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],0,tplines[curTarget][a][0][1]-A*tplines[curTarget][a][0][0]),n.dashedLine(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],0,tplines[curTarget][a][0][1]+A*tplines[curTarget][a][0][0]),(curTPcurve==a||null!=dragObj&&dragObj.num==a)&&(n.strokeStyle="rgb(0,255,255)",n.lineWidth=1,n.dashedLine(g,l,g-2*(g-tplines[curTarget][a][0][0]),l,5),n.dashedLine(g,l,g,l-2*(l-tplines[curTarget][a][0][1]),5),n.dashedLine(g,l-2*(l-tplines[curTarget][a][0][1]),g-2*(g-tplines[curTarget][a][0][0]),l-2*(l-tplines[curTarget][a][0][1]),5),n.dashedLine(g-2*(g-tplines[curTarget][a][0][0]),l,g-2*(g-tplines[curTarget][a][0][0]),l-2*(l-tplines[curTarget][a][0][1]),5),n.lineWidth=2),n.beginPath(),n.strokeStyle="rgb(0,0,255)",I=0;I<targets[curTarget].imgwidth+4;I+=3)(_=tplines[curTarget][a][0][0]+Math.sqrt((Math.pow(I-tplines[curTarget][a][0][1],2)/($*$)+1)*C*C))<-100&&(_=-100),_>targets[curTarget].imgwidth+100&&(_=targets[curTarget].imgwidth+100),0==I?n.moveTo(_,I):n.lineTo(_,I);for(n.stroke(),n.beginPath(),I=0;I<targets[curTarget].imgwidth+4;I+=3)(_=tplines[curTarget][a][0][0]-Math.sqrt((Math.pow(I-tplines[curTarget][a][0][1],2)/($*$)+1)*C*C))<-100&&(_=-100),_>targets[curTarget].imgwidth+100&&(_=targets[curTarget].imgwidth+100),0==I?n.moveTo(_,I):n.lineTo(_,I)}}else if(8==tptypes[curTarget][a])l=g=s=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&(g!=tplines[curTarget][a][0][0]&&(s=(l-tplines[curTarget][a][0][1])/(g-tplines[curTarget][a][0][0]),g<tplines[curTarget][a][0][0]&&(s*=-1)),Math.abs(g-tplines[curTarget][a][0][0])<1||100<Math.abs(s)?(n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),l>tplines[curTarget][a][0][1]?n.lineTo(tplines[curTarget][a][0][0],targets[curTarget].imgheight):n.lineTo(tplines[curTarget][a][0][0],0)):(d=tplines[curTarget][a][0][1]+s*tplines[curTarget][a][0][0],T=tplines[curTarget][a][0][1]+s*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]),n.moveTo(0,d),n.lineTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),n.lineTo(targets[curTarget].imgwidth,T)));else if(8.3==tptypes[curTarget][a]){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&g!=tplines[curTarget][a][0][0])if(l==tplines[curTarget][a][0][1])n.moveTo(0,l),n.lineTo(targets[curTarget].imgwidth,l);else if(0<(D=(S=targets[curTarget].ymax*targets[curTarget].pixpery+targets[curTarget].imgborder)-tplines[curTarget][a][0][1])*(W=S-l)&&g!=tplines[curTarget][a][0][0])for(R=safepow(W/D,1/(g-tplines[curTarget][a][0][0])),p=W/safepow(R,g),n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),_=I=0;_<targets[curTarget].imgwidth+4;_+=3)(I=S-p*safepow(R,_))<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),0==_?n.moveTo(_,I):n.lineTo(_,I)}else if(8.4==tptypes[curTarget][a]){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&g!=tplines[curTarget][a][0][0]&&l!=tplines[curTarget][a][0][1]&&0<(z=(H=-targets[curTarget].xmin*targets[curTarget].pixperx+targets[curTarget].imgborder)-tplines[curTarget][a][0][0])*(U=H-g)&&l!=tplines[curTarget][a][0][1])for(R=safepow(U/z,1/(l-tplines[curTarget][a][0][1])),p=U/safepow(R,l),n.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]),I=I=0;I<targets[curTarget].imgheight+4;I+=3)(_=H-p*safepow(R,I))<-100&&(_=-100),_>targets[curTarget].imgwidth+100&&(_=targets[curTarget].imgwidth+100),0==I?n.moveTo(_,I):n.lineTo(_,I)}else if(8.5==tptypes[curTarget][a]){if(u=o=g=l=null,3==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1],u=tplines[curTarget][a][2][0],o=tplines[curTarget][a][2][1]):2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1],u=e,o=t):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),F=tplines[curTarget][a][0][1],n.strokeStyle=asymcolor,n.dashedLine(5,F,targets[curTarget].imgwidth,F),n.beginPath(),n.strokeStyle="rgb(0,0,255)",null!=u&&u!=g)if(o==l)n.moveTo(0,o),n.lineTo(targets[curTarget].imgwidth,o);else if(0<(W=F-l)*(Y=F-o)&&u!=g)for(R=safepow(Y/W,1/(u-g)),p=Y/safepow(R,u),n.moveTo(g,l),_=I=0;_<targets[curTarget].imgwidth+4;_+=3)(I=F-p*safepow(R,_))<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),0==_?n.moveTo(_,I):n.lineTo(_,I)}else if(8.6==tptypes[curTarget][a]){if(u=o=g=l=null,3==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1],u=tplines[curTarget][a][2][0],o=tplines[curTarget][a][2][1]):2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1],u=e,o=t):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),X=tplines[curTarget][a][0][0],n.strokeStyle=asymcolor,n.dashedLine(X,5,X,targets[curTarget].imgheight),n.beginPath(),n.strokeStyle="rgb(0,0,255)",null!=u&&u!=g&&o!=l&&0<(U=g-X)*(V=u-X))for(R=safepow(V/U,1/(o-l)),p=V/safepow(R,o),n.moveTo(g,l),I=_=0;I<targets[curTarget].imgheight+4;I+=3)(_=X+p*safepow(R,I))<-100&&(_=-100),_>targets[curTarget].imgwidth+100&&(_=targets[curTarget].imgwidth+100),0==I?n.moveTo(_,I):n.lineTo(_,I)}else if(8.2==tptypes[curTarget][a]){if(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),n.strokeStyle=asymcolor,n.dashedLine(5,tplines[curTarget][a][0][1],targets[curTarget].imgwidth,tplines[curTarget][a][0][1]),n.dashedLine(tplines[curTarget][a][0][0],5,tplines[curTarget][a][0][0],targets[curTarget].imgheight),n.beginPath(),n.strokeStyle="rgb(0,0,255)",null!=g&&g!=tplines[curTarget][a][0][0]&&l!=tplines[curTarget][a][0][1]){for(p=(l-tplines[curTarget][a][0][1])*(g-tplines[curTarget][a][0][0]),_=tplines[curTarget][a][0][0]-1;-4<_;_-=3)(I=p/(_-tplines[curTarget][a][0][0])+tplines[curTarget][a][0][1])<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),_==tplines[curTarget][a][0][0]-1?n.moveTo(_,I):n.lineTo(_,I);for(_=tplines[curTarget][a][0][0]+1;_<targets[curTarget].imgwidth+4;_+=3)(I=p/(_-tplines[curTarget][a][0][0])+tplines[curTarget][a][0][1])<-100&&(I=-100),I>targets[curTarget].imgheight+100&&(I=targets[curTarget].imgheight+100),_==tplines[curTarget][a][0][0]+1?n.moveTo(_,I):n.lineTo(_,I);n.stroke()}}else if((9==tptypes[curTarget][a]||9.1==tptypes[curTarget][a])&&(g=l=null,2==tplines[curTarget][a].length?(g=tplines[curTarget][a][1][0],l=tplines[curTarget][a][1][1]):curTPcurve==a&&null!=e&&1==tplines[curTarget][a].length&&(g=e,l=t),null!=g&&g!=tplines[curTarget][a][0][0]))if(l==tplines[curTarget][a][0][1])n.moveTo(0,l),n.lineTo(targets[curTarget].imgwidth,l);else for(9==tptypes[curTarget][a]?(G=-1*Math.abs(l-tplines[curTarget][a][0][1])/2,J=(l+tplines[curTarget][a][0][1])/2,p=Math.PI/Math.abs(g-tplines[curTarget][a][0][0]),Q=l<tplines[curTarget][a][0][1]?g:tplines[curTarget][a][0][0]):9.1==tptypes[curTarget][a]&&(G=-1*Math.abs(l-tplines[curTarget][a][0][1]),J=tplines[curTarget][a][0][1],p=.5*Math.PI/Math.abs(g-tplines[curTarget][a][0][0]),Q=l<tplines[curTarget][a][0][1]?g:g+2*Math.abs(g-tplines[curTarget][a][0][0])),_=I=0;_<targets[curTarget].imgwidth+4;_+=3)I=G*Math.cos(p*(_-Q))+J,0==_?n.moveTo(_,I):n.lineTo(_,I);n.stroke(),n.beginPath()}for(null===curTPcurve&&tpHasAsymp.hasOwnProperty(targets[curTarget].mode)&&(n.strokeStyle="rgb(200,200,200)",8.5==targets[curTarget].mode?n.dashedLine(5,t,targets[curTarget].imgwidth,t):8.6==targets[curTarget].mode?n.dashedLine(e,5,e,targets[curTarget].imgwidth):8.2==targets[curTarget].mode?(n.dashedLine(5,t,targets[curTarget].imgwidth,t),n.dashedLine(e,5,e,targets[curTarget].imgheight)):7.4!=targets[curTarget].mode&&7.5!=targets[curTarget].mode||(n.dashedLine(e,t,targets[curTarget].imgwidth,t+(targets[curTarget].imgwidth-e)),n.dashedLine(e,t,targets[curTarget].imgwidth,t-(targets[curTarget].imgwidth-e)),n.dashedLine(e,t,0,t-e),n.dashedLine(e,t,0,t+e)),n.beginPath(),n.strokeStyle="rgb(0,0,255)"),n.fillStyle="rgba(0,0,255,.5)",a=0;a<lines[curTarget].length;a++){for(n.beginPath(),x=0;x<lines[curTarget][a].length;x++)0==x?(n.moveTo(lines[curTarget][a][x][0],lines[curTarget][a][x][1]),K=lines[curTarget][a][x][0],Z=lines[curTarget][a][x][1]):(n.lineTo(lines[curTarget][a][x][0],lines[curTarget][a][x][1]),ee=lines[curTarget][a][x][0],te=lines[curTarget][a][x][1]);if(a==curLine&&null!=e&&(n.lineTo(e,t),ee=e,te=t),re=.02*targets[curTarget].imgwidth,1==drawlocky[curTarget]&&ee>.98*targets[curTarget].imgwidth?(n.moveTo(ee,te),n.lineTo(ee-re,te+re),n.moveTo(ee,te),n.lineTo(ee-re,te-re)):1==drawlocky[curTarget]&&K>.98*targets[curTarget].imgwidth&&(n.moveTo(K,Z),n.lineTo(K-re,Z+re),n.moveTo(K,Z),n.lineTo(K-re,Z-re)),1==drawlocky[curTarget]&&ee<.02*targets[curTarget].imgwidth?(n.moveTo(ee,te),n.lineTo(ee+re,te+re),n.moveTo(ee,te),n.lineTo(ee+re,te-re)):1==drawlocky[curTarget]&&K<.02*targets[curTarget].imgwidth&&(n.moveTo(K,Z),n.lineTo(K+re,Z+re),n.moveTo(K,Z),n.lineTo(K+re,Z-re)),n.stroke(),1<targets[curTarget].dotline){if(lines[curTarget][a].length-1<1)continue;if(Math.pow(ee-K,2)+Math.pow(te-Z,2)<25){for(n.moveTo(lines[curTarget][a][0][0],lines[curTarget][a][0][1]),x=1;x<lines[curTarget][a].length;x++)n.lineTo(lines[curTarget][a][x][0],lines[curTarget][a][x][1]);n.closePath(),n.fill()}}}for(n.fillStyle="rgb(0,0,255)",n.beginPath(),a=0;a<dots[curTarget].length;a++)n.moveTo(dots[curTarget][a][0]+5,dots[curTarget][a][1]),n.arc(dots[curTarget][a][0],dots[curTarget][a][1],5,0,2*Math.PI,!0);if(n.fill(),0<targets[curTarget].dotline){for(n.beginPath(),a=0;a<lines[curTarget].length;a++)for(x=0;x<lines[curTarget][a].length;x++)(0==x||25<Math.pow(lines[curTarget][a][x][0]-lines[curTarget][a][x-1][0],2)+Math.pow(lines[curTarget][a][x][1]-lines[curTarget][a][x-1][1],2))&&(n.moveTo(lines[curTarget][a][x][0]+5,lines[curTarget][a][x][1]),n.arc(lines[curTarget][a][x][0],lines[curTarget][a][x][1],5,0,2*Math.PI,!0));n.fill()}for(n.fillStyle="rgb(255,255,255)",n.beginPath(),a=0;a<odots[curTarget].length;a++)n.moveTo(odots[curTarget][a][0]+5,odots[curTarget][a][1]),n.arc(odots[curTarget][a][0],odots[curTarget][a][1],4,0,2*Math.PI,!0);for(targets[curTarget].mode<3?n.fill():n.stroke(),n.lineWidth=2,n.beginPath(),a=0;a<odots[curTarget].length;a++)n.moveTo(odots[curTarget][a][0]+5,odots[curTarget][a][1]),n.arc(odots[curTarget][a][0],odots[curTarget][a][1],4,0,2*Math.PI,!0);for(n.stroke(),a=0;a<tplines[curTarget].length;a++)if(tptypes[curTarget][a]==targets[curTarget].mode){for(n.fillStyle="rgb(255,0,0)",x=0;x<tplines[curTarget][a].length;x++)n.fillRect(tplines[curTarget][a][x][0]-3,tplines[curTarget][a][x][1]-3,6,6);tplines[curTarget][a].length<tpModeN[targets[curTarget].mode]&&null!=e&&curTPcurve==a&&n.fillRect(e-3,t-3,6,6),n.fillStyle="rgb(0,0,255)"}!0!==r&&encodeDraw()}function deleteCurve(e,t){1==e?dots[curTarget].splice(t,1):2==e?odots[curTarget].splice(t,1):0<=e&&e<1?lines[curTarget].splice(t,1):5<=e&&e<10?(tplines[curTarget].splice(t,1),tptypes[curTarget].splice(t,1),curTPcurve=null):10<=e&&e<11&&(ineqlines[curTarget].splice(t,1),ineqtypes[curTarget].splice(t,1),curIneqcurve=null),drawTarget()}function encodeDraw(){var e,t,r,n,a,i,s="",g=[];for(e=0;e<lines[curTarget].length;e++)for(lines[curTarget][e].length,g=0==targets[curTarget].dotline?pathsimplify(lines[curTarget][e]):lines[curTarget][e],0!=e&&(s+=";"),t=0;t<g.length;t++)0!=t&&(s+=","),s+="("+g[t][0]+","+g[t][1]+")";for(s+=";;",e=0;e<dots[curTarget].length;e++)0!=e&&(s+=","),s+="("+dots[curTarget][e][0]+","+dots[curTarget][e][1]+")";for(s+=";;",e=0;e<odots[curTarget].length;e++)0!=e&&(s+=","),s+="("+odots[curTarget][e][0]+","+odots[curTarget][e][1]+")";for(s+=";;",r=[],n="",e=0;e<tplines[curTarget].length;e++)if(tplines[curTarget][e].length==tpModeN[tptypes[curTarget][e]]){for(n="("+tptypes[curTarget][e],t=0;t<tplines[curTarget][e].length;t++)n+=","+tplines[curTarget][e][t][0]+","+tplines[curTarget][e][t][1];r.push(n+")")}for(s+=r.join(","),s+=";;",a=[],e=0;e<ineqlines[curTarget].length;e++)2<ineqlines[curTarget][e].length&&a.push("("+ineqtypes[curTarget][e]+","+ineqlines[curTarget][e][0][0]+","+ineqlines[curTarget][e][0][1]+","+ineqlines[curTarget][e][1][0]+","+ineqlines[curTarget][e][1][1]+","+ineqlines[curTarget][e][2][0]+","+ineqlines[curTarget][e][2][1]+")");s+=a.join(","),targetOuts[curTarget].value!=s&&(i=""!=targetOuts[curTarget].value||";;;;;;;;"!=s,targetOuts[curTarget].value=s,i&&$(targetOuts[curTarget]).trigger("input").trigger("change"))}function drawMouseDown(e){var t,r,n,a;if(clickcnt++,clearAllDrawListners(),hasTouch&&1<e.originalEvent.touches.length)return didMultiTouch=!0,$(document).on("touchend.imathasdraw",drawMouseUp),!0;if(hasTouch?(window.clearTimeout(hasTouchTimer),$(document).off("mousemove.imathasdraw"),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(".drawcanvas").on("touchmove.imathasdraw",drawMouseMove),$(document).on("touchend.imathasdraw",drawMouseUp),$(document).on("touchcancel.imathasdraw",drawMouseUp)):($(document).on("mousemove.imathasdraw",drawMouseMove),$(document).on("mouseup.imathasdraw",drawMouseUp)),t=mouseCoords(e),null==curTarget||null==curLine&&null==curTPcurve&&null==curIneqcurve)for(i in targets)if(!$(targets[i].el).is(":hidden")&&"canvas"==targets[i].type&&(r=getPosition(targets[i].el)).x<t.x&&r.x+targets[i].width>t.x&&r.y<t.y&&r.y+targets[i].height>t.y&&e.target==targets[i].el){curTarget=i;break}if(null!=curTarget){if(targetOuts[curTarget].disabled)return;if(e.preventDefault(),mouseisdown=!0,r=getPosition(targets[curTarget].el),-1<(n={x:t.x-r.x,y:t.y-r.y}).x&&n.x<targets[curTarget].width&&-1<n.y&&n.y<targets[curTarget].height){if(0<targets[curTarget].snaptogridx&&(n=snaptogrid(n,curTarget)),1==drawlocky[curTarget]&&(n.y=targets[curTarget].imgheight/2),null!=(a=findnearpoint(curTarget,n))){if(-1==targets[curTarget].mode)return void deleteCurve(a[0],a[1]);null!=curLine&&a[0]<1&&curLine!=a[1]?a=null:null!=curTPcurve&5<=a[0]&&a[0]<10&&curTPcurve!=a[1]?a=null:null!=curIneqcurve&&10<=a[0]&&a[0]<11&&curIneqcurve!=a[1]&&(a=null)}null==a?(setCursor("pendown"),1==targets[curTarget].mode?(dots[curTarget].push([n.x,n.y]),dragObj={mode:1,num:dots[curTarget].length-1}):2==targets[curTarget].mode?(odots[curTarget].push([n.x,n.y]),dragObj={mode:2,num:odots[curTarget].length-1}):0==targets[curTarget].mode||.7==targets[curTarget].mode?null==curLine?(lines[curTarget].push([[n.x,n.y]]),curLine=lines[curTarget].length-1):lines[curTarget][curLine].push([n.x,n.y]):.5==targets[curTarget].mode?null==curLine?(lines[curTarget].push([[n.x,n.y]]),curLine=lines[curTarget].length-1):(lines[curTarget][curLine].push([n.x,n.y]),dragObj=curLine=null):5<=targets[curTarget].mode&&targets[curTarget].mode<10?null==curTPcurve?(tplines[curTarget].push([[n.x,n.y]]),curTPcurve=tplines[curTarget].length-1,tptypes[curTarget][curTPcurve]=targets[curTarget].mode,mouseisdown=!1):(tplines[curTarget][curTPcurve].push([n.x,n.y]),tplines[curTarget][curTPcurve].length==tpModeN[targets[curTarget].mode]?(dragObj={mode:targets[curTarget].mode,num:curTPcurve,subnum:tpModeN[targets[curTarget].mode]-1},curTPcurve=null):mouseisdown=!1):10<=targets[curTarget].mode&&targets[curTarget].mode<11&&(null==curIneqcurve?(ineqlines[curTarget].push([[n.x,n.y]]),curIneqcurve=ineqlines[curTarget].length-1,ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode,mouseisdown=!1):(ineqlines[curTarget][curIneqcurve].push([n.x,n.y]),2==ineqlines[curTarget][curIneqcurve].length?dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:1}:3==ineqlines[curTarget][curIneqcurve].length&&(dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:2},curIneqcurve=null)))):0==a[0]||.5==a[0]?null==curLine?(setCursor("move"),dragObj={mode:targets[curTarget].mode,num:a[1],subnum:a[2]},oldpointpos=lines[curTarget][a[1]][a[2]],a[2]==lines[curTarget][a[1]].length-1&&0==targets[curTarget].mode?curLine=a[1]:0==a[2]&&0==targets[curTarget].mode&&(curLine=a[1],lines[curTarget][curLine].reverse(),dragObj.subnum=lines[curTarget][curLine].length-1),clickmightbenewcurve=!0):a[1]==curLine&&a[2]==lines[curTarget][a[1]].length-1?(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),curLine=null):1<targets[curTarget].dotline&&a[1]==curLine&&0==a[2]?(lines[curTarget][curLine].push(lines[curTarget][curLine][0]),curLine=null):(setCursor("pendown"),lines[curTarget][curLine].push([n.x,n.y])):1==a[0]?(setCursor("move"),dragObj={mode:1,num:a[1]}):2==a[0]?(setCursor("move"),dragObj={mode:2,num:a[1]}):5<=a[0]&&a[0]<10?null==curTPcurve&&(setCursor("move"),dragObj={mode:a[0],num:a[1],subnum:a[2]},oldpointpos=tplines[curTarget][a[1]][a[2]],clickmightbenewcurve=!0):10<=a[0]&&a[0]<11&&null==curIneqcurve&&(setCursor("move"),dragObj={mode:a[0],num:a[1],subnum:a[2]},oldpointpos=ineqlines[curTarget][a[1]][a[2]],clickmightbenewcurve=!0),drawTarget()}else null!=curLine&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),setCursor("pen")),null!=curTPcurve&&(tplines[curTarget][curTPcurve].length<tpModeN[targets[curTarget].mode]&&(tplines[curTarget].splice(curTPcurve,1),tptypes[curTarget].splice(curTPcurve,1)),setCursor("pen")),null!=curIneqcurve&&(ineqlines[curTarget][curIneqcurve].length<3&&(ineqlines[curTarget].splice(curIneqcurve,1),ineqtypes[curTarget].splice(curIneqcurve,1)),setCursor("pen")),dragObj=curIneqcurve=curTPcurve=curLine=null,drawTarget(),curTarget=null}}function findnearpoint(e,t){var r,n,a;if(hasTouch?(r=Math.max(15*window.innerWidth/screen.width,15),r*=r):r=-1==targets[e].mode?50:25,0==targets[e].mode||.5==targets[e].mode||-1==targets[e].mode)for(n=lines[e].length-1;0<=n;n--)for(a=lines[e][n].length-1;0<=a;a--)if(Math.pow(lines[e][n][a][0]-t.x,2)+Math.pow(lines[e][n][a][1]-t.y,2)<r)return[-1==targets[e].mode?0:targets[e].mode,n,a];if(1==targets[e].mode||-1==targets[e].mode)for(n=dots[e].length-1;0<=n;n--)if(Math.pow(dots[e][n][0]-t.x,2)+Math.pow(dots[e][n][1]-t.y,2)<r)return[1,n];if(2==targets[e].mode||-1==targets[e].mode)for(n=odots[e].length-1;0<=n;n--)if(Math.pow(odots[e][n][0]-t.x,2)+Math.pow(odots[e][n][1]-t.y,2)<r)return[2,n];if(5<=targets[e].mode&&targets[e].mode<10||-1==targets[e].mode)for(n=tplines[e].length-1;0<=n;n--)for(a=tplines[e][n].length-1;0<=a;a--)if((tptypes[e][n]==targets[e].mode||-1==targets[e].mode)&&Math.pow(tplines[e][n][a][0]-t.x,2)+Math.pow(tplines[e][n][a][1]-t.y,2)<r)return[tptypes[e][n],n,a];if(10<=targets[e].mode&&targets[e].mode<11||-1==targets[e].mode)for(n=ineqlines[e].length-1;0<=n;n--)for(a=ineqlines[e][n].length-1;0<=a;a--)if((ineqtypes[e][n]==targets[e].mode||-1==targets[e].mode)&&Math.pow(ineqlines[e][n][a][0]-t.x,2)+Math.pow(ineqlines[e][n][a][1]-t.y,2)<r)return[ineqtypes[e][n],n,a];return null}function drawMouseUp(e){var t,r,n,a=mouseCoords(e);if(mouseisdown=!1,null!=curTarget){if(targetOuts[curTarget].disabled)return;t=getPosition(targets[curTarget].el),r={x:a.x-t.x,y:a.y-t.y},0<targets[curTarget].snaptogridx&&(r=snaptogrid(r,curTarget)),n=-1<r.x&&r.x<targets[curTarget].width&&-1<r.y&&r.y<targets[curTarget].height,1==clickmightbenewcurve&&(5<=targets[curTarget].mode&&targets[curTarget].mode<10?(tplines[curTarget].push([[r.x,r.y]]),curTPcurve=tplines[curTarget].length-1,tptypes[curTarget][curTPcurve]=targets[curTarget].mode):10<=targets[curTarget].mode&&targets[curTarget].mode<11&&(ineqlines[curTarget].push([[r.x,r.y]]),curIneqcurve=ineqlines[curTarget].length-1,ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode)),null!=lastdrawmouseup&&a.x==lastdrawmouseup.x&&a.y==lastdrawmouseup.y&&null!=curLine&&null==dragObj&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),dragObj=curLine=null,drawTarget()),null!=curLine&&null==dragObj&&(.5==targets[curTarget].mode&&1<lines[curTarget][curLine].length?(curLine=null,dragobj=null,drawTarget()):.7==targets[curTarget].mode&&(curLine=null,dragobj=null,drawTarget())),null!=curTPcurve&&tplines[curTarget][curTPcurve].length<tpModeN[targets[curTarget].mode]&&(didMultiTouch||!n?(tplines[curTarget].splice(curTPcurve,1),tptypes[curTarget].splice(curTPcurve,1),curTPcurve=null,drawTarget()):null==findnearpoint(curTarget,r)&&(tplines[curTarget][curTPcurve].push([r.x,r.y]),tplines[curTarget][curTPcurve].length==tpModeN[targets[curTarget].mode]&&(curTPcurve=null),drawTarget())),null!=curIneqcurve&&1==ineqlines[curTarget][curIneqcurve].length&&(didMultiTouch||!n?(ineqlines[curTarget].splice(curIneqcurve,1),ineqtypes[curTarget].splice(curIneqcurve,1),curIneqcurve=null,drawTarget()):null==findnearpoint(curTarget,r)&&(ineqlines[curTarget][curIneqcurve].push([r.x,r.y]),drawTarget())),setCursor(null==curLine&&null==curTPcurve?"move":"pen"),void 0!==e&&e.preventDefault()}lastdrawmouseup=a,null!=curTarget&&null!=dragObj&&(t=getPosition(targets[curTarget].el),-1<r.x&&r.x<targets[curTarget].width&&-1<r.y&&r.y<targets[curTarget].height?(0==dragObj.mode&&1<targets[curTarget].dotline&&(0!=dragObj.subnum&&dragObj.subnum!=lines[curTarget][dragObj.num].length-1||Math.pow(lines[curTarget][dragObj.num][0][0]-lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0],2)+Math.pow(lines[curTarget][dragObj.num][0][1]-lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1],2)<25&&(0==dragObj.subnum?(lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0]=lines[curTarget][dragObj.num][0][0],lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1]=lines[curTarget][dragObj.num][0][1]):(lines[curTarget][dragObj.num][0][0]=lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0],lines[curTarget][dragObj.num][0][1]=lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1]),curLine=null,drawTarget())),dragObj=null):(1==drawlocky[curTarget]&&(r.y=targets[curTarget].imgheight/2),1==dragObj.mode?dots[curTarget].splice(dragObj.num,1):2==dragObj.mode?odots[curTarget].splice(dragObj.num,1):.5==dragObj.mode?lines[curTarget].splice(dragObj.num,1):0==dragObj.mode?lines[curTarget][dragObj.num][dragObj.subnum]=oldpointpos:5<=dragObj.mode&&dragObj.mode<10?(tplines[curTarget].splice(dragObj.num,1),tptypes[curTarget].splice(dragObj.num,1),curTPcurve=null):10<=dragObj.mode&&dragObj.mode<11&&(ineqlines[curTarget].splice(dragObj.num,1),ineqtypes[curTarget].splice(dragObj.num,1),curIneqcurve=null),dragObj=null,drawTarget())),didMultiTouch=!1,hasTouch?hasTouchTimer=window.setTimeout(function(){hasTouch=!1,clearAllDrawListners(),$(document).on("mousemove.imathasdraw",drawMouseMove),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(document).on("mousedown.imathasdraw",drawMouseDown)},350):(clearAllDrawListners(),$(document).on("mousemove.imathasdraw",drawMouseMove),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(document).on("mousedown.imathasdraw",drawMouseDown))}function drawMouseMove(e){var t,r,n,a,s,g=null;for(i in clickmightbenewcurve=!1,t=mouseCoords(e),targets)if(!$(targets[i].el).is(":hidden")&&"canvas"==targets[i].type&&(r=getPosition(targets[i].el)).x<t.x&&r.x+targets[i].width>t.x&&r.y<t.y&&r.y+targets[i].height>t.y&&e.target==targets[i].el){g=i;break}if(null!=g){if(targetOuts[g].disabled)return;r=getPosition(targets[mouseintarget=g].el),n={x:t.x-r.x,y:t.y-r.y},0<targets[g].snaptogridx&&(n=snaptogrid(n,g)),1==drawlocky[g]&&(n.y=targets[g].imgheight/2),-1<n.x&&n.x<targets[g].width&&-1<n.y&&n.y<targets[g].height&&null==dragObj&&null==curLine&&(null==(a=findnearpoint(g,n))?setCursor("pen",g):-1!=targets[g].mode&&setCursor("move",g))}else null!=mouseintarget&&-1!=mouseintarget&&(null!=curTarget?drawTarget():(curTarget=mouseintarget,drawTarget(),curTarget=null),mouseintarget=-1);if(null!=curTarget){if(e.originalEvent.touches&&1<e.originalEvent.touches.length)return didMultiTouch=!0;if(void 0!==e&&e.preventDefault(),r=getPosition(targets[curTarget].el),n={x:t.x-r.x,y:t.y-r.y},0<targets[curTarget].snaptogridx&&(n=snaptogrid(n,curTarget)),1==drawlocky[curTarget]&&(n.y=targets[curTarget].imgheight/2),-1<n.x&&n.x<targets[curTarget].width&&-1<n.y&&n.y<targets[curTarget].height){if(null==dragObj){if(mouseisdown&&-1==targets[curTarget].mode)return void(null!=(a=findnearpoint(curTarget,n))&&deleteCurve(a[0],a[1]));null!=curLine?!mouseisdown||0!=targets[curTarget].mode&&.7!=targets[curTarget].mode?mouseisdown&&.5==targets[curTarget].mode?0==(s=lines[curTarget][curLine].length-1)?25<Math.pow(lines[curTarget][curLine][s][0]-n.x,2)+Math.pow(lines[curTarget][curLine][s][1]-n.y,2)?(lines[curTarget][curLine].push([n.x,n.y]),drawTarget()):drawTarget(n.x,n.y):(lines[curTarget][curLine][s]=[n.x,n.y],drawTarget()):drawTarget(n.x,n.y):(s=lines[curTarget][curLine].length-1,25<Math.pow(lines[curTarget][curLine][s][0]-n.x,2)+Math.pow(lines[curTarget][curLine][s][1]-n.y,2)?(lines[curTarget][curLine].push([n.x,n.y]),drawTarget()):drawTarget(n.x,n.y)):null!=curTPcurve?mouseisdown?drawTarget():drawTarget(n.x,n.y):null!=curIneqcurve?mouseisdown?drawTarget():drawTarget(n.x,n.y):null==(a=findnearpoint(curTarget,n))?(setCursor("pen"),tpHasAsymp.hasOwnProperty(targets[curTarget].mode)&&null!==g&&drawTarget(n.x,n.y)):(drawTarget(),-1!=targets[curTarget].mode&&setCursor("move"))}else setCursor("move"),0==dragObj.mode||.5==dragObj.mode?lines[curTarget][dragObj.num][dragObj.subnum]=[n.x,n.y]:1==dragObj.mode?dots[curTarget][dragObj.num]=[n.x,n.y]:2==dragObj.mode?odots[curTarget][dragObj.num]=[n.x,n.y]:5<=dragObj.mode&&dragObj.mode<10?tplines[curTarget][dragObj.num][dragObj.subnum]=[n.x,n.y]:10<=dragObj.mode&&dragObj.mode<11&&(ineqlines[curTarget][dragObj.num][dragObj.subnum]=[n.x,n.y]),drawTarget();return!1}null==curIneqcurve||mouseisdown||drawTarget()}else null!=g&&-1!=mouseintarget&&(curTarget=g,tpHasAsymp.hasOwnProperty(targets[curTarget].mode)&&drawTarget(n.x,n.y),curTarget=null)}function setCursor(e,t){targets[t=t||curTarget].cursor!=e&&(targets[t].el.style.cursor="move"==e?e:"url("+staticroot+"/img/"+e+".cur), auto",targets[t].cursor=e)}function mouseCoords(e){var t,r,n,a,i;return e=e||window.event,hasTouch?{x:(t=e.originalEvent.changedTouches[0]||e.originalEvent.touches[0]).pageX,y:t.pageY}:e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:(r=document.documentElement,n=document.body,i=r&&(r.scrollTop||r.scrollLeft)?(a=r.scrollLeft,r.scrollTop):n?(a=n.scrollLeft,n.scrollTop):a=0,{x:e.clientX+a,y:e.clientY+i})}function snaptogrid(e,t){var r=e.x-targets[t].imgborder+targets[t].xmin*targets[t].pixperx,n=e.y-targets[t].imgborder-targets[t].ymax*targets[t].pixpery;return{x:r=Math.round(Math.round(r/(targets[t].pixperx*targets[t].snaptogridx))*targets[t].pixperx*targets[t].snaptogridx+targets[t].imgborder-targets[t].xmin*targets[t].pixperx),y:n=Math.round(Math.round(n/(targets[t].pixpery*targets[t].snaptogridy))*targets[t].pixpery*targets[t].snaptogridy+targets[t].imgborder+targets[t].ymax*targets[t].pixpery)}}function getMouseOffset(e,t){var r=getPosition(e),n=mouseCoords(t);return{x:n.x-r.x,y:n.y-r.y}}function getPosition(e){if(e.className.match(/hidden/))return{x:-1e4,y:-1e4};var t=$(e).offset();return{x:t.left,y:t.top}}function clearAllDrawListners(){$(document).off("mousedown.imathasdraw").off("mousemove.imathasdraw").off("mouseup.imathasdraw"),$(document).off("touchstart.imathasdraw").off("touchmove.imathasdraw").off("touchend.imathasdraw").off("touchcancel.imathasdraw"),$(".drawcanvas").off("touchstart.imathasdraw").off("touchmove.imathasdraw").off("touchend.imathasdraw").off("touchcancel.imathasdraw")}function initCanvases(e){var t,r,n,a,i;clearAllDrawListners(),$(document).on("mousemove.imathasdraw",drawMouseMove),$(".drawcanvas").on("touchstart.imathasdraw",function(e){hasTouch=!0,drawMouseDown(e)}),$(document).on("mousedown.imathasdraw",drawMouseDown);try{CanvasRenderingContext2D.prototype.dashedLine=function(e,t,r,n,a){var i,s,g,u,l,o;for(null==a&&(a=10),this.beginPath(),this.moveTo(e,t),s=n-t,u=(i=r-e)/(g=Math.sqrt(i*i+s*s)/a),l=s/g,g=Math.floor(g),o=0;o++<g&&-1<t&&t<targets[curTarget].imgheight+1&&-1<e&&e<targets[curTarget].imgwidth+1;)e+=u,t+=l,this[o%2==0?"moveTo":"lineTo"](e,t);this[o%2==0?"moveTo":"lineTo"](r,n),this.stroke(),this.closePath()}}catch(e){}for(t in canvases)if(void 0===e||e==t){if((r=null)!=drawla[t]&&2<drawla[t].length){if(lines[canvases[t][0]]=drawla[t][0],dots[canvases[t][0]]=drawla[t][1],odots[canvases[t][0]]=drawla[t][2],tptypes[canvases[t][0]]=[],tplines[canvases[t][0]]=[],3<drawla[t].length&&0<drawla[t][3].length)for(n=0;n<drawla[t][3].length;n++)for(tptypes[canvases[t][0]][n]=drawla[t][3][n][0],tplines[canvases[t][0]][n]=[],a=0;a<tpModeN[tptypes[canvases[t][0]][n]];a++)tplines[canvases[t][0]][n].push(drawla[t][3][n].slice(1+2*a,3+2*a));if(ineqtypes[canvases[t][0]]=[],ineqlines[canvases[t][0]]=[],4<drawla[t].length&&0<drawla[t][4].length)for(n=0;n<drawla[t][4].length;n++)ineqtypes[canvases[t][0]][n]=drawla[t][4][n][0],ineqlines[canvases[t][0]][n]=[drawla[t][4][n].slice(1,3),drawla[t][4][n].slice(3,5),drawla[t][4][n].slice(5)];5<drawla[t].length&&(r=drawla[t][5])}else null!=drawla[t]&&"[[]]"==JSON.stringify(drawla[t])&&clearcanvas(canvases[t][0],!0);i="",canvases[t][1].match(/initPicture/)?i=canvases[t][1]:""!==canvases[t][1]&&(i=imasroot+"/filter/graph/imgs/"+canvases[t][1]),""!==canvases[t][13]?addA11yTarget(canvases[t],r,i):addTarget(canvases[t][0],"canvas"+canvases[t][0],i,"qn"+canvases[t][0],canvases[t][2],canvases[t][3],canvases[t][4],canvases[t][5],canvases[t][6],canvases[t][7],canvases[t][8],canvases[t][9],canvases[t][10],canvases[t][11],canvases[t][12])}}function addnormslider(e,t){-1==arraysearch(e,normslider.idnums)?(normslider.idnums.push(e),!0===t&&slideronpageload(e)):slideronpageload(e)}function slideronpageload(e){var t,r;for(r=0;r<normslider.idnums.length;r++)void 0!==e&&e!=normslider.idnums[r]||(initnormslider(t=normslider.idnums[r]),$("#slid1"+t).on("touchstart.normslider mousedown.normslider",onsliderstart),$("#slid2"+t).on("touchstart.normslider mousedown.normslider",onsliderstart))}function initnormslider(e){var t,r,n,a,i=document.getElementById("qn"+e).value;n=(a=i.match(/\(-oo,([\-\d\.]+)\)U\(([\-\d\.]+),oo\)/))?(t=3,r=a[1],a[2]):(a=i.match(/\(-oo,([\-\d\.]+)\)/))?(t=0,r=a[1],2.5):(a=i.match(/\(([\-\d\.]+),oo\)/))?(r=a[t=1],2.5):(a=i.match(/\(([\-\d\.]+),([\-\d\.]+)\)/))?(t=2,r=a[1],a[2]):(t=0,r=-1.5,2.5),document.getElementById("slid1"+e).style.left=60*r+250-6+"px",document.getElementById("slid2"+e).style.left=60*n+250-6+"px",document.getElementById("shaderegions"+e).selectedIndex=t,normslider.curslider.type=document.getElementById("shaderegions"+e).value,chgnormtype(e)}function onsliderstart(e){(e=e||window.event).originalEvent.touches&&0<e.originalEvent.touches.length?(hasTouch=!0,$(document).on("touchmove.normslider",onsliderchange),$(document).on("touchend.normslider",onsliderstop)):($(document).on("mousemove.normslider",onsliderchange),$(document).on("mouseup.normslider",onsliderstop)),normslider.curslider.el=e.target||e.srcElement,normslider.curslider.id=normslider.curslider.el.id.substring(5),normslider.curslider.type=document.getElementById("shaderegions"+normslider.curslider.id).value,normslider.curslider.outnode=document.getElementById(normslider.outputid),normslider.curslider.startpos=getMouseOffset(normslider.curslider.el,e),normslider.curslider.el.parentNode.style.cursor="pointer";getPosition(normslider.curslider.el.parentNode);return e.preventDefault&&e.preventDefault(),!1}function onsliderchange(e){var t,r,n=normslider.curslider.id;if(e=e||window.event,!((t=getMouseOffset(normslider.curslider.el.parentNode,e)).x<5||t.x>normslider.curslider.el.parentNode.offsetWidth-5||t.y<5||t.y>normslider.curslider.el.parentNode.offsetHeight-5))return r=6*Math.round((t.x-normslider.curslider.startpos.x-10)/6)+10,normslider.curslider.el.style.left=r+"px",normupdatevalues(n),e.preventDefault&&e.preventDefault(),!1}function onsliderstop(e){null!==normslider.curslider.el&&(hasTouch=!1,$(document).off("touchmove.normslider touchend.normslider"),$(document).off("mousemove.normslider mouseup.normslider"),normslider.curslider.el.parentNode.style.cursor="",normslider.curslider.el=null)}function normupdatevalues(e){var t,r,n,a,i,s,g,u=parseInt(document.getElementById("slid1"+e).style.left)+6,l=parseInt(document.getElementById("slid2"+e).style.left)+6,o=Math.min(u,l),c=Math.max(u,l);"2O"==normslider.curslider.type?document.getElementById("normleft"+e).style.width=o+1+"px":"1L"==normslider.curslider.type?document.getElementById("normleft"+e).style.width=u+1+"px":"2B"==normslider.curslider.type&&(document.getElementById("normleft"+e).style.left=o+"px",document.getElementById("normleft"+e).style.width=c-o+1+"px"),"2O"==normslider.curslider.type?document.getElementById("normright"+e).style.width=500-c+"px":"1R"==normslider.curslider.type&&(document.getElementById("normright"+e).style.width=500-u+"px"),t=((u-10)/60-4).toFixed(1),r=((l-10)/60-4).toFixed(1),(n=document.getElementById("slid1txt"+e)).innerHTML=t,n.style.left=u-6+"px",(a=document.getElementById("slid2txt"+e)).innerHTML=r,a.style.left=l-6+"px",i=Math.min(t,r),s=Math.max(t,r),"2O"==normslider.curslider.type?g="(-oo,"+i+")U("+s+",oo)":"2B"==normslider.curslider.type?g="("+i+","+s+")":"1L"==normslider.curslider.type?g="(-oo,"+t+")":"1R"==normslider.curslider.type&&(g="("+t+",oo)"),document.getElementById("qn"+e).value=g,$("#qn"+e).trigger("input").trigger("change")}function chgnormtype(e){var t,r,n,a,i=document.getElementById("shaderegions"+e).value;normslider.curslider.type=i,t=parseInt(document.getElementById("slid1"+e).style.left)+6,r=parseInt(document.getElementById("slid2"+e).style.left)+6,n=Math.min(t,r),a=Math.max(t,r),"1R"==i||"1L"==i?(document.getElementById("slid2"+e).style.display="none",document.getElementById("slid2txt"+e).style.display="none","1R"==i?(document.getElementById("normleft"+e).style.display="none",document.getElementById("normright"+e).style.display="",document.getElementById("normright"+e).style.right="0px",document.getElementById("normright"+e).style.width=500-t+"px"):(document.getElementById("normright"+e).style.display="none",document.getElementById("normleft"+e).style.display="",document.getElementById("normleft"+e).style.left="0px",document.getElementById("normleft"+e).style.width=t+"px")):"2O"==i?(document.getElementById("slid2"+e).style.display="",document.getElementById("slid2txt"+e).style.display="",document.getElementById("normleft"+e).style.display="",document.getElementById("normright"+e).style.display="",document.getElementById("normright"+e).style.right="0px",document.getElementById("normleft"+e).style.left="0px",document.getElementById("normright"+e).style.width=500-a+"px",document.getElementById("normleft"+e).style.width=n+"px"):"2B"==i&&(document.getElementById("slid2"+e).style.display="",document.getElementById("slid2txt"+e).style.display="",document.getElementById("normleft"+e).style.display="",document.getElementById("normright"+e).style.display="none",document.getElementById("normleft"+e).style.left=n+"px",document.getElementById("normleft"+e).style.width=a-n+"px"),normupdatevalues(e)}function dashedParabola(e,t,r,n,a,i,s){var g,u,l,o,c,d,T,p,h,m,y,w,f;if(a==r)e.moveTo(0,a),e.dashedLine(0,a,i,a);else{for(l=0,r<a&&(l=s),o=(g=(a-r)/((n-t)*(n-t)))*t*t+r-l,g*(d=(-(u=-2*g*t)-(c=Math.sqrt(u*u-4*g*o)))/(2*g))*d+u*d+(o+=l),(T=(-u+c)/(2*g))<d&&(p=d,d=T,T=p),m=(h=8)*h,T-d,y=t,w=r,f=0;d-5<y&&-5<y;)f%2==0?e.moveTo(y,w):e.lineTo(y,w),w=g*(y-=Math.min(Math.sqrt(m/(1+Math.pow(2*g*(y-t),2))),Math.sqrt(h/Math.abs(g))))*y+u*y+o,f++;for(y=t,w=r,f=0;y<T+5&&y<i+5;)f%2==0?e.moveTo(y,w):e.lineTo(y,w),w=g*(y+=Math.min(Math.sqrt(m/(1+Math.pow(2*g*(y-t),2))),Math.sqrt(h/Math.abs(g))))*y+u*y+o,f++}e.stroke()}function shadeParabola(e,t,r,n,a,i,s,g,u){var l,o,c,d,T,p,h,m,y,w,f,v,b,q,x,M;e.beginPath(),a==r?(e.moveTo(0,a),e.lineTo(g,a),s<r?(e.lineTo(g,0),e.lineTo(0,0)):(e.lineTo(g,u),e.lineTo(0,u))):(c=0,r<a&&(c=u),d=(l=(a-r)/((n-t)*(n-t)))*t*t+r-c,h=l*(p=(-(o=-2*l*t)-(T=Math.sqrt(o*o-4*l*d)))/(2*l))*p+o*p+(d+=c),(m=(-o+T)/(2*l))<p&&(w=p,p=m,m=w),x=(f=2*l*(p-t))*(q=((v=(y=h)-f*p)-(y-(b=-f)*m))/(b-f))+v,l<0&&s<l*i*i+o*i+d||0<l&&l*i*i+o*i+d<s?(e.moveTo(p,h),e.quadraticCurveTo(q,x,m,y)):(M=u,Math.abs(h-u)<2&&(M=0),e.moveTo(0,h),e.lineTo(p,h),e.quadraticCurveTo(q,x,m,y),e.lineTo(g,y),e.lineTo(g,M),e.lineTo(0,M))),e.closePath()}return clickcnt=0,lastdrawmouseup=null,mouseintarget=-1,"undefined"!=typeof initstack?initstack.push(initCanvases):$(function(){initCanvases()}),normslider={idnums:[],curslider:{el:null,startpos:[0,0],outnode:null}},"undefined"!=typeof initstack&&initstack.push(slideronpageload),drawexport={reset:reset,initCanvases:initCanvases,clearcanvas:clearcanvas,clearlastline:clearlastline,settool:settool,addnormslider:addnormslider,chgnormtype:chgnormtype,adda11ydraw:adda11ydraw,changea11ydraw:changea11ydraw,encodea11ydraw:encodea11ydraw,updatea11ydraw:updatea11ydraw,removea11ydraw:removea11ydraw},drawexport}(jQuery);!function(){"use strict";function a(e,t){var r=e.length-1,n=[e[0]];return function e(t,r,n,a,i){var s,g,u,l,o,c,d,T,p,h,m,y=a;for(g=r+1;g<n;g++)l=t[g],o=t[r],c=t[n],m=h=p=T=d=void 0,T=o[0],p=o[1],h=c[0]-T,m=c[1]-p,0===h&&0===m||(1<(d=((l[0]-T)*h+(l[1]-p)*m)/(h*h+m*m))?(T=c[0],p=c[1]):0<d&&(T+=h*d,p+=m*d)),y<(u=(h=l[0]-T)*h+(m=l[1]-p)*m)&&(s=g,y=u);a<y&&(1<s-r&&e(t,r,s,a,i),i.push(t[s]),1<n-s&&e(t,s,n,a,i))}(e,0,r,t,n),n.push(e[r]),n}window.pathsimplify=function(e,t,r){if(e.length<=2)return e;var n=void 0!==t?t*t:1;return e=a(e=r?e:function(e,t){var r,n,a,i,s,g,u,l=e[0],o=[l];for(n=1,a=e.length;n<a;n++)r=e[n],s=l,g=(i=r)[0]-s[0],u=i[1]-s[1],t<g*g+u*u&&(o.push(r),l=r);return l!==r&&o.push(r),o}(e,n),n)}}();
