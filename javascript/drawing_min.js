/* 
   Canvas-based function drawing script
   (c) David Lippman, part of www.imathas.com
   GNU 2 Licensed - see license in IMathAS distribution
   */
var canvases=[],drawla=[],imathasDraw=function(n){function ci(n){e[n].length=0,p[n].length=0,a[n].length=0,u[n].length=0,l[n].length=0,f[n].length=0,w[n].length=0,t=n,v(),t=null,s=null,o=null}function pi(n,i,o,s,h,c,y,b,g,nt,tt,it,rt,ut,ft){var et=document.getElementById(i),ot;et.style.userSelect="none",et.style.webkitUserSelect="none",et.style.MozUserSelect="none",ot=d(et),r[n]={el:et,left:ot.x,top:ot.y,width:et.offsetWidth,height:et.offsetHeight,xmin:h,xmax:c,ymin:y,ymax:b,imgborder:g,imgwidth:nt,imgheight:tt,mode:it,dotline:rt},typeof ft=="string"&&ft.indexOf(":")!=-1?(ft=ft.split(":"),r[n].snaptogridx=1*ft[0],r[n].snaptogridy=1*ft[1]):(r[n].snaptogridx=ft,r[n].snaptogridy=ft),r[n].pixperx=(nt-2*g)/(c-h),r[n].pixpery=y==b?1:(tt-2*g)/(b-y),ui[n]=document.getElementById(s),e[n]==null&&(e[n]=[]),p[n]==null&&(p[n]=[]),a[n]==null&&(a[n]=[]),u[n]==null&&(u[n]=[]),l[n]==null&&(l[n]=[]),f[n]==null&&(f[n]=[]),w[n]==null&&(w[n]=[]),at[n]=it>=5?1:0,k[n]=ut,st[n]=new Image,st[n].onload=function(){var i=t;t=n,v(),t=i},st[n].src=o}function oi(n,i,r){for(var e=document.getElementById("drawtools"+i),f=e.getElementsByTagName("span"),u=0;u<f.length;u++)f[u].className="";for(f=e.getElementsByTagName("img"),u=0;u<f.length;u++)f[u].className="";n.className="sel",ei(i,r),t=i,v()}function ei(n,t){r[n].mode=t}function v(n,i){var v,bt,ft,ui,kt,li,it,lt,at,hi,rt,d,b,tt,nt,ot,ct,et,ht,ut,yi,h,g;try{v=r[t].el.getContext("2d")}catch(tr){ii||(ii=!0,alert("Your browser does not support drawing answer entry.  Please try again using Internet Explorer 6+ (Windows), FireFox 1.5+ (Win/Mac), Safari 1.3+ (Mac), Opera 9+ (Win/Mac), or Camino (Mac)"))}for(v.fillStyle="rgb(0,0,255)",v.lineWidth=2,v.strokeStyle="rgb(0,0,255)",v.clearRect(0,0,r[t].imgwidth,r[t].imgheight),v.drawImage(st[t],0,0),v.beginPath(),h=0;h<f[t].length;h++){bt=h%3,v.strokeStyle=ri[bt],v.fillStyle=ri[bt];var it=null,b=null,pt=null,d=null,dt=null;if(f[t][h].length==3?(b=f[t][h][1][0],d=f[t][h][1][1],pt=f[t][h][2][0],dt=f[t][h][2][1]):f[t][h].length==2?(b=f[t][h][1][0],d=f[t][h][1][1],pt=n,dt=i):y==h&&n!=null&&f[t][h].length==1&&(b=n,d=i),pt!=null){if(v.save(),v.fillStyle=ai[bt],v.beginPath(),w[t][h]<=10.2)if(b!=f[t][h][0][0]&&(it=(d-f[t][h][0][1])/(b-f[t][h][0][0])),Math.abs(b-f[t][h][0][0])<1||Math.abs(it)>100)v.moveTo(f[t][h][0][0],0),v.lineTo(f[t][h][0][0],r[t].imgheight),pt>b?(v.lineTo(r[t].imgwidth,r[t].imgheight),v.lineTo(r[t].imgwidth,0),v.closePath()):(v.lineTo(0,r[t].imgheight),v.lineTo(0,0),v.closePath());else{var nr=it*(pt-b)+d,lt=f[t][h][0][1]-it*f[t][h][0][0],at=f[t][h][0][1]+it*(r[t].imgwidth-f[t][h][0][0]);v.moveTo(0,lt),v.lineTo(r[t].imgwidth,at),dt>nr?(v.lineTo(r[t].imgwidth,r[t].imgheight),v.lineTo(0,r[t].imgheight),v.closePath()):(v.lineTo(r[t].imgwidth,0),v.lineTo(0,0),v.closePath())}else si(v,f[t][h][0][0],f[t][h][0][1],b,d,pt,dt,r[t].imgwidth,r[t].imgheight);v.fill(),v.restore()}if(v.beginPath(),b!=null)if(w[t][h]<=10.2)b!=f[t][h][0][0]&&(it=(d-f[t][h][0][1])/(b-f[t][h][0][0])),Math.abs(b-f[t][h][0][0])<1||Math.abs(it)>100?w[t][h]==10.2?o!=null&&o.mode>=10&&o.mode<11&&o.num==h&&o.subnum==0?(v.dashedLine(f[t][h][1][0],f[t][h][1][1],f[t][h][1][0],r[t].imgheight),v.dashedLine(f[t][h][1][0],f[t][h][1][1],f[t][h][1][0],0)):(v.dashedLine(f[t][h][0][0],f[t][h][0][1],f[t][h][0][0],r[t].imgheight),v.dashedLine(f[t][h][0][0],f[t][h][0][1],f[t][h][0][0],0)):(v.moveTo(f[t][h][0][0],0),v.lineTo(f[t][h][0][0],r[t].imgheight),v.stroke()):(lt=f[t][h][0][1]-it*f[t][h][0][0],at=f[t][h][0][1]+it*(r[t].imgwidth-f[t][h][0][0]),w[t][h]==10.2?o!=null&&o.mode>=10&&o.mode<11&&o.num==h&&o.subnum==0?(v.dashedLine(f[t][h][1][0],f[t][h][1][1],r[t].imgwidth,at),v.dashedLine(f[t][h][1][0],f[t][h][1][1],0,lt)):(v.dashedLine(f[t][h][0][0],f[t][h][0][1],r[t].imgwidth,at),v.dashedLine(f[t][h][0][0],f[t][h][0][1],0,lt)):(v.moveTo(0,lt),v.lineTo(r[t].imgwidth,at),v.stroke()));else if(w[t][h]==10.3){if(b!=f[t][h][0][0])if(d==f[t][h][0][1])v.moveTo(0,d),v.lineTo(r[t].imgwidth,d);else{if(rt=(d-f[t][h][0][1])/((b-f[t][h][0][0])*(b-f[t][h][0][0])),d>f[t][h][0][1])var yt=Math.sqrt((r[t].imgheight-f[t][h][0][1])/rt)+f[t][h][0][0],gt=-1*Math.sqrt((r[t].imgheight-f[t][h][0][1])/rt)+f[t][h][0][0],wi=f[t][h][0][1]-(r[t].imgheight-f[t][h][0][1]),vt=r[t].imgheight;else var yt=Math.sqrt((0-f[t][h][0][1])/rt)+f[t][h][0][0],gt=-1*Math.sqrt((0-f[t][h][0][1])/rt)+f[t][h][0][0],wi=2*f[t][h][0][1],vt=0;var ti=yt+2/3*(f[t][h][0][0]-yt),ni=vt+2/3*(wi-vt),pi=ti+(gt-yt)/3,ci=ni;v.moveTo(yt,vt),v.bezierCurveTo(ti,ni,pi,ci,gt,vt)}v.stroke()}else b!=f[t][h][0][0]&&vi(v,f[t][h][0][0],f[t][h][0][1],b,d,r[t].imgwidth,r[t].imgheight);for(v.beginPath(),g=0;g<f[t][h].length;g++)g==2?(v.arc(f[t][h][g][0],f[t][h][g][1],4,0,Math.PI*2,!0),v.fill()):v.fillRect(f[t][h][g][0]-3,f[t][h][g][1]-3,6,6);f[t][h].length==1&&b!=null&&v.fillRect(b-3,d-3,6,6),v.beginPath()}for(v.fillStyle="rgb(0,0,255)",v.lineWidth=k[t]==1?4:2,v.strokeStyle="rgb(0,0,255)",h=0;h<u[t].length;h++){if(l[t][h]>=5&&l[t][h]<6){var it=null,b=null,d=null,ft,wt;if(u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null)if(l[t][h]==5.3||l[t][h]==5.4)v.moveTo(u[t][h][0][0],u[t][h][0][1]),v.lineTo(b,d),l[t][h]==5.4&&(ft=[b-u[t][h][0][0],d-u[t][h][0][1]],ui=Math.sqrt(ft[0]*ft[0]+ft[1]*ft[1]),ui>.0001&&(ft=[ft[0]/ui,ft[1]/ui],wt=[-ft[1],ft[0]],v.moveTo(b-15*ft[0]-4*wt[0],d-15*ft[1]-5*wt[1]),v.lineTo(b,d),v.moveTo(b-15*ft[0]+4*wt[0],d-15*ft[1]+5*wt[1]),v.lineTo(b,d)));else if(b!=u[t][h][0][0]&&(it=(d-u[t][h][0][1])/(b-u[t][h][0][0])),Math.abs(b-u[t][h][0][0])<1||Math.abs(it)>100)l[t][h]==5.2?(v.moveTo(u[t][h][0][0],u[t][h][0][1]),d>u[t][h][0][1]?v.lineTo(u[t][h][0][0],r[t].imgheight):v.lineTo(u[t][h][0][0],0)):(v.moveTo(u[t][h][0][0],0),v.lineTo(u[t][h][0][0],r[t].imgheight));else{var lt=u[t][h][0][1]-it*u[t][h][0][0],at=u[t][h][0][1]+it*(r[t].imgwidth-u[t][h][0][0]),lt=u[t][h][0][1]-it*u[t][h][0][0],at=u[t][h][0][1]+it*(r[t].imgwidth-u[t][h][0][0]);l[t][h]==5.2?(v.moveTo(u[t][h][0][0],u[t][h][0][1]),b>u[t][h][0][0]?v.lineTo(r[t].imgwidth,at):v.lineTo(0,lt)):(v.moveTo(0,lt),v.lineTo(r[t].imgwidth,at))}}else if(l[t][h]==6){if(d=null,b=null,u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null&&b!=u[t][h][0][0])if(d==u[t][h][0][1])v.moveTo(0,d),v.lineTo(r[t].imgwidth,d);else{if(rt=(d-u[t][h][0][1])/((b-u[t][h][0][0])*(b-u[t][h][0][0])),d>u[t][h][0][1])var yt=Math.sqrt((r[t].imgheight-u[t][h][0][1])/rt)+u[t][h][0][0],gt=-1*Math.sqrt((r[t].imgheight-u[t][h][0][1])/rt)+u[t][h][0][0],wi=u[t][h][0][1]-(r[t].imgheight-u[t][h][0][1]),vt=r[t].imgheight;else var yt=Math.sqrt((0-u[t][h][0][1])/rt)+u[t][h][0][0],gt=-1*Math.sqrt((0-u[t][h][0][1])/rt)+u[t][h][0][0],wi=2*u[t][h][0][1],vt=0;var ti=yt+2/3*(u[t][h][0][0]-yt),ni=vt+2/3*(wi-vt),pi=ti+(gt-yt)/3,ci=ni;v.moveTo(yt,vt),v.bezierCurveTo(ti,ni,pi,ci,gt,vt)}}else if(l[t][h]==6.5){if(d=null,b=null,u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null&&b!=u[t][h][0][0])if(d==u[t][h][0][1])v.moveTo(u[t][h][0][0],d),b>u[t][h][0][0]?v.lineTo(r[t].imgwidth,d):v.lineTo(0,d);else{kt=b<u[t][h][0][0]?-1:1,rt=(d-u[t][h][0][1])/Math.sqrt(kt*(b-u[t][h][0][0])),v.moveTo(u[t][h][0][0],u[t][h][0][1]),nt=u[t][h][0][0],tt=u[t][h][0][1];do nt+=kt*3,v.lineTo(nt,rt*Math.sqrt(kt*(nt-u[t][h][0][0]))+u[t][h][0][1]);while(nt>0&&nt<r[t].imgwidth&&tt>0&&tt<r[t].imgheight)}}else if(l[t][h]==7)u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null&&(b!=u[t][h][0][0]||d!=u[t][h][0][1])&&(li=Math.sqrt((b-u[t][h][0][0])*(b-u[t][h][0][0])+(d-u[t][h][0][1])*(d-u[t][h][0][1])),v.arc(u[t][h][0][0],u[t][h][0][1],li,0,2*Math.PI,!0));else if(l[t][h]==8){var it=null,b=null,d=null;u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null&&(b!=u[t][h][0][0]&&(it=(d-u[t][h][0][1])/(b-u[t][h][0][0]),b<u[t][h][0][0]&&(it*=-1)),Math.abs(b-u[t][h][0][0])<1||Math.abs(it)>100?(v.moveTo(u[t][h][0][0],u[t][h][0][1]),d>u[t][h][0][1]?v.lineTo(u[t][h][0][0],r[t].imgheight):v.lineTo(u[t][h][0][0],0)):(lt=u[t][h][0][1]+it*u[t][h][0][0],at=u[t][h][0][1]+it*(r[t].imgwidth-u[t][h][0][0]),v.moveTo(0,lt),v.lineTo(u[t][h][0][0],u[t][h][0][1]),v.lineTo(r[t].imgwidth,at)))}else if(l[t][h]==8.3){if(d=null,b=null,u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null&&b!=u[t][h][0][0])if(d==u[t][h][0][1])v.moveTo(0,d),v.lineTo(r[t].imgwidth,d);else{var ei=r[t].ymax*r[t].pixpery+r[t].imgborder,bi=ei-u[t][h][0][1],oi=ei-d;if(bi*oi>0&&b!=u[t][h][0][0])for(hi=safepow(oi/bi,1/(b-u[t][h][0][0])),rt=oi/safepow(hi,b),v.moveTo(u[t][h][0][0],u[t][h][0][1]),tt=0,nt=0;nt<r[t].imgwidth+4;nt+=3)tt=ei-rt*safepow(hi,nt),tt<-100&&(tt=-100),tt>r[t].imgheight+100&&(tt=r[t].imgheight+100),nt==0?v.moveTo(nt,tt):v.lineTo(nt,tt)}}else if(l[t][h]==8.2){if(d=null,b=null,u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),v.strokeStyle="rgb(0,255,0)",v.dashedLine(5,u[t][h][0][1],r[t].imgwidth,u[t][h][0][1]),v.dashedLine(u[t][h][0][0],5,u[t][h][0][0],r[t].imgheight),v.beginPath(),v.strokeStyle="rgb(0,0,255)",b!=null&&b!=u[t][h][0][0]&&d!=u[t][h][0][1]){for(rt=(d-u[t][h][0][1])*(b-u[t][h][0][0]),nt=u[t][h][0][0]-1;nt>-4;nt-=3)tt=rt/(nt-u[t][h][0][0])+u[t][h][0][1],tt<-100&&(tt=-100),tt>r[t].imgheight+100&&(tt=r[t].imgheight+100),nt==u[t][h][0][0]-1?v.moveTo(nt,tt):v.lineTo(nt,tt);for(nt=u[t][h][0][0]+1;nt<r[t].imgwidth+4;nt+=3)tt=rt/(nt-u[t][h][0][0])+u[t][h][0][1],tt<-100&&(tt=-100),tt>r[t].imgheight+100&&(tt=r[t].imgheight+100),nt==u[t][h][0][0]+1?v.moveTo(nt,tt):v.lineTo(nt,tt);v.stroke()}}else if((l[t][h]==9||l[t][h]==9.1)&&(d=null,b=null,u[t][h].length==2?(b=u[t][h][1][0],d=u[t][h][1][1]):c==h&&n!=null&&u[t][h].length==1&&(b=n,d=i),b!=null&&b!=u[t][h][0][0]))if(d==u[t][h][0][1])v.moveTo(0,d),v.lineTo(r[t].imgwidth,d);else{if(l[t][h]==9)var ki=Math.abs(d-u[t][h][0][1])/-2,di=(d+u[t][h][0][1])/2,rt=Math.PI/Math.abs(b-u[t][h][0][0]),gi=d<u[t][h][0][1]?b:u[t][h][0][0];else if(l[t][h]==9.1)var ki=-1*Math.abs(d-u[t][h][0][1]),di=u[t][h][0][1],rt=.5*Math.PI/Math.abs(b-u[t][h][0][0]),gi=d<u[t][h][0][1]?b:b+2*Math.abs(b-u[t][h][0][0]);for(tt=0,nt=0;nt<r[t].imgwidth+4;nt+=3)tt=ki*Math.cos(rt*(nt-gi))+di,nt==0?v.moveTo(nt,tt):v.lineTo(nt,tt)}v.stroke(),v.beginPath()}for(v.fillStyle="rgba(0,0,255,.5)",h=0;h<e[t].length;h++){for(v.beginPath(),g=0;g<e[t][h].length;g++)g==0?(v.moveTo(e[t][h][g][0],e[t][h][g][1]),ot=e[t][h][g][0],ct=e[t][h][g][1]):(v.lineTo(e[t][h][g][0],e[t][h][g][1]),et=e[t][h][g][0],ht=e[t][h][g][1]);if(h==s&&n!=null&&(v.lineTo(n,i),et=n,ht=i),ut=r[t].imgwidth*.02,k[t]==1&&et>r[t].imgwidth*.98?(v.moveTo(et,ht),v.lineTo(et-ut,ht+ut),v.moveTo(et,ht),v.lineTo(et-ut,ht-ut)):k[t]==1&&ot>r[t].imgwidth*.98&&(v.moveTo(ot,ct),v.lineTo(ot-ut,ct+ut),v.moveTo(ot,ct),v.lineTo(ot-ut,ct-ut)),k[t]==1&&et<r[t].imgwidth*.02?(v.moveTo(et,ht),v.lineTo(et+ut,ht+ut),v.moveTo(et,ht),v.lineTo(et+ut,ht-ut)):k[t]==1&&ot<r[t].imgwidth*.02&&(v.moveTo(ot,ct),v.lineTo(ot+ut,ct+ut),v.moveTo(ot,ct),v.lineTo(ot+ut,ct-ut)),v.stroke(),r[t].dotline>1){if(yi=e[t][h].length-1,yi<1)continue;if(Math.pow(et-ot,2)+Math.pow(ht-ct,2)<25){for(v.moveTo(e[t][h][0][0],e[t][h][0][1]),g=1;g<e[t][h].length;g++)v.lineTo(e[t][h][g][0],e[t][h][g][1]);v.closePath(),v.fill()}}}for(v.fillStyle="rgb(0,0,255)",v.beginPath(),h=0;h<p[t].length;h++)v.moveTo(p[t][h][0]+5,p[t][h][1]),v.arc(p[t][h][0],p[t][h][1],5,0,Math.PI*2,!0);if(v.fill(),r[t].dotline>0){for(v.beginPath(),h=0;h<e[t].length;h++)for(g=0;g<e[t][h].length;g++)(g==0||Math.pow(e[t][h][g][0]-e[t][h][g-1][0],2)+Math.pow(e[t][h][g][1]-e[t][h][g-1][1],2)>25)&&(v.moveTo(e[t][h][g][0]+5,e[t][h][g][1]),v.arc(e[t][h][g][0],e[t][h][g][1],5,0,Math.PI*2,!0));v.fill()}for(v.fillStyle="rgb(255,255,255)",v.beginPath(),h=0;h<a[t].length;h++)v.moveTo(a[t][h][0]+5,a[t][h][1]),v.arc(a[t][h][0],a[t][h][1],4,0,Math.PI*2,!0);for(r[t].mode<3?v.fill():v.stroke(),v.lineWidth=2,v.beginPath(),h=0;h<a[t].length;h++)v.moveTo(a[t][h][0]+5,a[t][h][1]),v.arc(a[t][h][0],a[t][h][1],4,0,Math.PI*2,!0);for(v.stroke(),h=0;h<u[t].length;h++)if(l[t][h]==r[t].mode){for(v.fillStyle="rgb(255,0,0)",g=0;g<u[t][h].length;g++)v.fillRect(u[t][h][g][0]-3,u[t][h][g][1]-3,6,6);u[t][h].length==1&&n!=null&&c==h&&v.fillRect(n-3,i-3,6,6),v.fillStyle="rgb(0,0,255)"}fi()}function fi(){for(var i="",r,n=0;n<e[t].length;n++)for(n!=0&&(i+=";"),r=0;r<e[t][n].length;r++)r!=0&&(i+=","),i+="("+e[t][n][r][0]+","+e[t][n][r][1]+")";for(i+=";;",n=0;n<p[t].length;n++)n!=0&&(i+=","),i+="("+p[t][n][0]+","+p[t][n][1]+")";for(i+=";;",n=0;n<a[t].length;n++)n!=0&&(i+=","),i+="("+a[t][n][0]+","+a[t][n][1]+")";for(i+=";;",n=0;n<u[t].length;n++)n!=0&&(i+=","),u[t][n].length>1&&(i+="("+l[t][n]+","+u[t][n][0][0]+","+u[t][n][0][1]+","+u[t][n][1][0]+","+u[t][n][1][1]+")");for(i+=";;",n=0;n<f[t].length;n++)n!=0&&(i+=","),f[t][n].length>2&&(i+="("+w[t][n]+","+f[t][n][0][0]+","+f[t][n][0][1]+","+f[t][n][1][0]+","+f[t][n][1][1]+","+f[t][n][2][0]+","+f[t][n][2][1]+")");ui[t].value=i}function nt(h){var at,lt,st,ut;if(yi++,ft(),b&&h.originalEvent.touches.length>1){tt=!0;n(document).on("touchend.imathasdraw",vt);return!0}if(b){window.clearTimeout(ti);n(document).on("touchstart.imathasdraw",function(n){b=!0,nt(n)});n(document).on("touchmove.imathasdraw",it);n(document).on("touchend.imathasdraw",vt)}else{n(document).on("mousemove.imathasdraw",it);n(document).on("mouseup.imathasdraw",vt)}if(at=ot(h),t==null||s==null&&c==null&&y==null)for(i in r)if(lt=d(r[i].el),lt.x<at.x&&lt.x+r[i].width>at.x&&lt.y<at.y&&lt.y+r[i].height>at.y){t=i;break}t!=null&&(g=!0,lt=d(r[t].el),st={x:at.x-lt.x,y:at.y-lt.y},st.x>-1&&st.x<r[t].width&&st.y>-1&&st.y<r[t].height?(navigator.userAgent.match(/Android/i),r[t].snaptogridx>0&&(st=ht(st,t)),k[t]==1&&(st.y=r[t].imgheight/2),ut=rt(t,st),ut!=null&&(s!=null&&ut[0]<1&&s!=ut[1]?ut=null:c!=null&ut[0]>=5&&ut[0]<10&&c!=ut[1]?ut=null:y!=null&&ut[0]>=10&&ut[0]<11&&y!=ut[1]&&(ut=null)),ut==null?(r[t].el.style.cursor="url("+imasroot+"/img/pendown.cur), default",r[t].mode==1?(p[t].push([st.x,st.y]),o={mode:1,num:p[t].length-1}):r[t].mode==2?(a[t].push([st.x,st.y]),o={mode:2,num:a[t].length-1}):r[t].mode==0||r[t].mode==.7?s==null?(e[t].push([[st.x,st.y]]),s=e[t].length-1):e[t][s].push([st.x,st.y]):r[t].mode==.5?s==null?(e[t].push([[st.x,st.y]]),s=e[t].length-1):(e[t][s].push([st.x,st.y]),s=null,o=null):r[t].mode>=5&&r[t].mode<10?c==null?(u[t].push([[st.x,st.y]]),c=u[t].length-1,l[t][c]=r[t].mode,g=!1):(u[t][c].push([st.x,st.y]),u[t][c].length==2&&(o={mode:r[t].mode,num:c,subnum:1},c=null)):r[t].mode>=10&&r[t].mode<11&&(y==null?(f[t].push([[st.x,st.y]]),y=f[t].length-1,w[t][y]=r[t].mode,g=!1):(f[t][y].push([st.x,st.y]),f[t][y].length==3&&(o={mode:r[t].mode,num:y,subnum:1},y=null)))):(ut[0]==0||ut[0]==.5?s==null?(r[t].el.style.cursor="move",o={mode:r[t].mode,num:ut[1],subnum:ut[2]},et=e[t][ut[1]][ut[2]],ut[2]==e[t][ut[1]].length-1&&r[t].mode==0?s=ut[1]:ut[2]==0&&r[t].mode==0&&(s=ut[1],e[t][s].reverse(),o.subnum=e[t][s].length-1)):ut[1]==s&&ut[2]==e[t][ut[1]].length-1?(e[t][s].length<2&&e[t].splice(s,1),s=null):r[t].dotline>1&&ut[1]==s&&ut[2]==0?(e[t][s].push(e[t][s][0]),s=null):(r[t].el.style.cursor="url("+imasroot+"/img/pendown.cur), default",e[t][s].push([st.x,st.y])):ut[0]==1?(r[t].el.style.cursor="move",o={mode:1,num:ut[1]}):ut[0]==2?(r[t].el.style.cursor="move",o={mode:2,num:ut[1]}):ut[0]>=5&&ut[0]<10?(r[t].el.style.cursor="move",o={mode:ut[0],num:ut[1],subnum:ut[2]},et=u[t][ut[1]][ut[2]]):ut[0]>=10&&ut[0]<11&&(r[t].el.style.cursor="move",o={mode:ut[0],num:ut[1],subnum:ut[2]},et=f[t][ut[1]][ut[2]]),ct=!0),v()):(s!=null&&(e[t][s].length<2&&e[t].splice(s,1),r[t].el.style.cursor="url("+imasroot+"/img/pen.cur), default"),c!=null&&(u[t][c].length<2&&u[t].splice(c,1),r[t].el.style.cursor="url("+imasroot+"/img/pen.cur), default"),y!=null&&(f[t][y].length<3&&f[t].splice(y,1),r[t].el.style.cursor="url("+imasroot+"/img/pen.cur), default"),s=null,c=null,y=null,o=null,v(),t=null))}function rt(n,t){var s,i,o,h;if(b?(s=Math.max(15*window.innerWidth/screen.width,15),s*=s):s=25,at[n]==0){if(r[n].mode==0||r[n].mode==.5){for(i=0;i<e[n].length;i++)for(o=e[n][i].length-1;o>=0;o--)if(h=Math.pow(e[n][i][o][0]-t.x,2)+Math.pow(e[n][i][o][1]-t.y,2),h<s)return[r[n].mode,i,o]}else if(r[n].mode==1){for(i=0;i<p[n].length;i++)if(Math.pow(p[n][i][0]-t.x,2)+Math.pow(p[n][i][1]-t.y,2)<s)return[1,i]}else if(r[n].mode==2){for(i=0;i<a[n].length;i++)if(Math.pow(a[n][i][0]-t.x,2)+Math.pow(a[n][i][1]-t.y,2)<s)return[2,i]}else if(r[n].mode>=5&&r[n].mode<10){for(i=0;i<u[n].length;i++)if(l[n][i]==r[n].mode)for(o=u[n][i].length-1;o>=0;o--)if(h=Math.pow(u[n][i][o][0]-t.x,2)+Math.pow(u[n][i][o][1]-t.y,2),h<s)return[l[n][i],i,o]}else if(r[n].mode>=10&&r[n].mode<11)for(i=0;i<f[n].length;i++)for(o=f[n][i].length-1;o>=0;o--)if(h=Math.pow(f[n][i][o][0]-t.x,2)+Math.pow(f[n][i][o][1]-t.y,2),h<s)return[w[n][i],i,o]}else if(r[n].mode==1){for(i=0;i<p[n].length;i++)if(Math.pow(p[n][i][0]-t.x,2)+Math.pow(p[n][i][1]-t.y,2)<s)return[1,i]}else if(r[n].mode==2){for(i=0;i<a[n].length;i++)if(Math.pow(a[n][i][0]-t.x,2)+Math.pow(a[n][i][1]-t.y,2)<s)return[2,i]}else if(r[n].mode>=5&&r[n].mode<10){for(i=0;i<u[n].length;i++)for(o=u[n][i].length-1;o>=0;o--)if(l[n][i]==r[n].mode&&(h=Math.pow(u[n][i][o][0]-t.x,2)+Math.pow(u[n][i][o][1]-t.y,2),h<s))return[l[n][i],i,o]}else if(r[n].mode>=10&&r[n].mode<11)for(i=0;i<f[n].length;i++)for(o=f[n][i].length-1;o>=0;o--)if(h=Math.pow(f[n][i][o][0]-t.x,2)+Math.pow(f[n][i][o][1]-t.y,2),h<s)return[w[n][i],i,o];return null}function vt(i){var st=ot(i),h,at,lt;if(g=!1,t!=null&&(lt=d(r[t].el),h={x:st.x-lt.x,y:st.y-lt.y},r[t].snaptogridx>0&&(h=ht(h,t)),at=h.x>-1&&h.x<r[t].width&&h.y>-1&&h.y<r[t].height,ct==!0&&(r[t].mode>=5&&r[t].mode<10?(u[t].push([[h.x,h.y]]),c=u[t].length-1,l[t][c]=r[t].mode):r[t].mode>=10&&r[t].mode<11&&(f[t].push([[h.x,h.y]]),y=f[t].length-1,w[t][y]=r[t].mode)),ut!=null&&st.x==ut.x&&st.y==ut.y&&s!=null&&o==null&&(e[t][s].length<2&&e[t].splice(s,1),s=null,o=null,v()),s!=null&&o==null&&(r[t].mode==.5&&e[t][s].length>1?(s=null,dragobj=null,v()):r[t].mode==.7&&(s=null,dragobj=null,v())),c!=null&&u[t][c].length==1&&(tt||!at?(u[t].splice(c,1),c=null,v()):rt(t,h)==null&&(u[t][c].push([h.x,h.y]),c=null,v())),y!=null&&f[t][y].length==1&&(tt||!at?(f[t].splice(y,1),y=null,v()):rt(t,h)==null&&(f[t][y].push([h.x,h.y]),v())),r[t].el.style.cursor=s==null&&c==null?"move":"url("+imasroot+"/img/pen.cur), default",typeof i!="undefined"&&i.preventDefault()),ut=st,t!=null&&o!=null&&(lt=d(r[t].el),h.x>-1&&h.x<r[t].width&&h.y>-1&&h.y<r[t].height?(o.mode==0&&r[t].dotline>1&&(o.subnum==0||o.subnum==e[t][o.num].length-1)&&Math.pow(e[t][o.num][0][0]-e[t][o.num][e[t][o.num].length-1][0],2)+Math.pow(e[t][o.num][0][1]-e[t][o.num][e[t][o.num].length-1][1],2)<25&&(o.subnum==0?(e[t][o.num][e[t][o.num].length-1][0]=e[t][o.num][0][0],e[t][o.num][e[t][o.num].length-1][1]=e[t][o.num][0][1]):(e[t][o.num][0][0]=e[t][o.num][e[t][o.num].length-1][0],e[t][o.num][0][1]=e[t][o.num][e[t][o.num].length-1][1]),s=null,v()),o=null):(k[t]==1&&(h.y=r[t].imgheight/2),o.mode==1?p[t].splice(o.num,1):o.mode==2?a[t].splice(o.num,1):o.mode==.5?e[t].splice(o.num,1):o.mode==0?e[t][o.num][o.subnum]=et:o.mode>=5&&o.mode<10?(u[t].splice(o.num,1),c=null):o.mode>=10&&o.mode<11&&(f[t].splice(o.num,1),y=null),o=null,v())),tt=!1,b)ti=window.setTimeout(function(){b=!1,ft();n(document).on("mousemove.imathasdraw",it);n(document).on("touchstart.imathasdraw",function(n){b=!0,nt(n)});n(document).on("mousedown.imathasdraw",nt)},350);else{ft();n(document).on("mousemove.imathasdraw",it);n(document).on("touchstart.imathasdraw",function(n){b=!0,nt(n)});n(document).on("mousedown.imathasdraw",nt)}}function it(n){var l=null,b,w,h,nt,ut,it;ct=!1,b=ot(n);for(i in r)if(w=d(r[i].el),w.x<b.x&&w.x+r[i].width>b.x&&w.y<b.y&&w.y+r[i].height>b.y){l=i;break}if(l!=null&&(w=d(r[l].el),h={x:b.x-w.x,y:b.y-w.y},r[l].snaptogridx>0&&(h=ht(h,l)),k[l]==1&&(h.y=r[l].imgheight/2),h.x>-1&&h.x<r[l].width&&h.y>-1&&h.y<r[l].height&&o==null&&s==null&&(it=rt(l,h),r[l].el.style.cursor=it==null?"url("+imasroot+"/img/pen.cur), default":"move")),t!=null){if(n.originalEvent.touches&&n.originalEvent.touches.length>1)return tt=!0,!0;if(typeof n!="undefined"&&n.preventDefault(),w=d(r[t].el),h={x:b.x-w.x,y:b.y-w.y},r[t].snaptogridx>0&&(h=ht(h,t)),k[t]==1&&(h.y=r[t].imgheight/2),h.x>-1&&h.x<r[t].width&&h.y>-1&&h.y<r[t].height)return o==null?s!=null?g&&(r[t].mode==0||r[t].mode==.7)?(nt=e[t][s].length-1,ut=Math.pow(e[t][s][nt][0]-h.x,2)+Math.pow(e[t][s][nt][1]-h.y,2),ut>25?(e[t][s].push([h.x,h.y]),v()):v(h.x,h.y)):g&&r[t].mode==.5?(nt=e[t][s].length-1,nt==0?(ut=Math.pow(e[t][s][nt][0]-h.x,2)+Math.pow(e[t][s][nt][1]-h.y,2),ut>25?(e[t][s].push([h.x,h.y]),v()):v(h.x,h.y)):(e[t][s][nt]=[h.x,h.y],v())):v(h.x,h.y):c!=null?g?v():v(h.x,h.y):y!=null?g?v():v(h.x,h.y):(it=rt(t,h),r[t].el.style.cursor=it==null?"url("+imasroot+"/img/pen.cur), default":"move"):(r[t].el.style.cursor="move",o.mode==0||o.mode==.5?e[t][o.num][o.subnum]=[h.x,h.y]:o.mode==1?p[t][o.num]=[h.x,h.y]:o.mode==2?a[t][o.num]=[h.x,h.y]:o.mode>=5&&o.mode<10?u[t][o.num][o.subnum]=[h.x,h.y]:o.mode>=10&&o.mode<11&&(f[t][o.num][o.subnum]=[h.x,h.y]),v()),!1}}function ot(n){var f,t,i,r,u;return(n=n||window.event,b)?(f=n.originalEvent.changedTouches[0]||n.originalEvent.touches[0],{x:f.pageX,y:f.pageY}):n.pageX||n.pageY?{x:n.pageX,y:n.pageY}:(t=document.documentElement,i=document.body,t&&(t.scrollTop||t.scrollLeft)?(r=t.scrollLeft,u=t.scrollTop):i?(r=i.scrollLeft,u=i.scrollTop):(r=0,u=0),{x:n.clientX+r,y:n.clientY+u})}function ht(n,t){var i=n.x-r[t].imgborder+r[t].xmin*r[t].pixperx,u=n.y-r[t].imgborder-r[t].ymax*r[t].pixpery;return i=Math.round(Math.round(i/(r[t].pixperx*r[t].snaptogridx))*r[t].pixperx*r[t].snaptogridx+r[t].imgborder-r[t].xmin*r[t].pixperx),u=Math.round(Math.round(u/(r[t].pixpery*r[t].snaptogridy))*r[t].pixpery*r[t].snaptogridy+r[t].imgborder+r[t].ymax*r[t].pixpery),{x:i,y:u}}function bt(n,t){var i=d(n),r=ot(t);return{x:r.x-i.x,y:r.y-i.y}}function d(n){for(var t=0,i=0;n.offsetParent;)t+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;return t+=n.offsetLeft,i+=n.offsetTop,{x:t,y:i}}function ft(){n(document).off("mousedown.imathasdraw").off("mousemove.imathasdraw").off("mouseup.imathasdraw"),n(document).off("touchstart.imathasdraw").off("touchmove.imathasdraw").off("touchend.imathasdraw")}function lt(i){var o,s;ft();n(document).on("mousemove.imathasdraw",it);n(document).on("touchstart.imathasdraw",function(n){b=!0,nt(n)});n(document).on("mousedown.imathasdraw",nt);try{CanvasRenderingContext2D.prototype.dashedLine=function(n,i,u,f,e){var s;e==undefined&&(e=10),this.beginPath(),this.moveTo(n,i);var h=u-n,c=f-i,o=Math.sqrt(h*h+c*c)/e,l=h/o,a=c/o;for(o=Math.round(o),s=0;s++<o&&i>-1&&i<r[t].imgheight+1&&n>-1&&n<r[t].imgwidth+1;)n+=l,i+=a,this[s%2==0?"moveTo":"lineTo"](n,i);this[s%2==0?"moveTo":"lineTo"](u,f),this.stroke(),this.closePath()}}catch(h){}for(o in canvases)if(typeof i=="undefined"||i==o){if(drawla[o]!=null&&drawla[o].length>2){if(e[canvases[o][0]]=drawla[o][0],p[canvases[o][0]]=drawla[o][1],a[canvases[o][0]]=drawla[o][2],l[canvases[o][0]]=[],u[canvases[o][0]]=[],drawla[o].length>3&&drawla[o][3].length>0)for(s=0;s<drawla[o][3].length;s++)l[canvases[o][0]][s]=drawla[o][3][s][0],u[canvases[o][0]][s]=[drawla[o][3][s].slice(1,3),drawla[o][3][s].slice(3)];if(w[canvases[o][0]]=[],f[canvases[o][0]]=[],drawla[o].length>4&&drawla[o][4].length>0)for(s=0;s<drawla[o][4].length;s++)w[canvases[o][0]][s]=drawla[o][4][s][0],f[canvases[o][0]][s]=[drawla[o][4][s].slice(1,3),drawla[o][4][s].slice(3,5),drawla[o][4][s].slice(5)]}pi(canvases[o][0],"canvas"+canvases[o][0],imasroot+"/filter/graph/imgs/"+canvases[o][1],"qn"+canvases[o][0],canvases[o][2],canvases[o][3],canvases[o][4],canvases[o][5],canvases[o][6],canvases[o][7],canvases[o][8],canvases[o][9],canvases[o][10],canvases[o][11],canvases[o][12])}}function hi(n){arraysearch(n,h.idnums)==-1?h.idnums.push(n):yt(n)}function yt(t){for(var u,r,i=0;i<h.idnums.length;i++)if(typeof t=="undefined"||t==h.idnums[i]){r=h.idnums[i],li(r);n("#slid1"+r).on("touchstart.normslider mousedown.normslider",gt);n("#slid2"+r).on("touchstart.normslider mousedown.normslider",gt)}}function li(n){var i,r,u,t,f=document.getElementById("qn"+n).value;(t=f.match(/\(-oo,([\-\d\.]+)\)U\(([\-\d\.]+),oo\)/))?(i=3,r=t[1],u=t[2]):(t=f.match(/\(-oo,([\-\d\.]+)\)/))?(i=0,r=t[1],u=2.5):(t=f.match(/\(([\-\d\.]+),oo\)/))?(i=1,r=t[1],u=2.5):(t=f.match(/\(([\-\d\.]+),([\-\d\.]+)\)/))?(i=2,r=t[1],u=t[2]):(i=0,r=-1.5,u=2.5),document.getElementById("slid1"+n).style.left=r*60+250-6+"px",document.getElementById("slid2"+n).style.left=u*60+250-6+"px",document.getElementById("shaderegions"+n).selectedIndex=i,h.curslider.type=document.getElementById("shaderegions"+n).value,dt(n)}function gt(t){if(t=t||window.event,t.originalEvent.touches&&t.originalEvent.touches.length>0){b=!0;n(document).on("touchmove.normslider",pt);n(document).on("touchend.normslider",wt)}else{n(document).on("mousemove.normslider",pt);n(document).on("mouseup.normslider",wt)}h.curslider.el=t.target||t.srcElement,h.curslider.id=h.curslider.el.id.substring(5),h.curslider.type=document.getElementById("shaderegions"+h.curslider.id).value,h.curslider.outnode=document.getElementById(h.outputid),h.curslider.startpos=bt(h.curslider.el,t),h.curslider.el.parentNode.style.cursor="pointer";var i=d(h.curslider.el.parentNode);return t.preventDefault&&t.preventDefault(),!1}function pt(n){var r=h.curslider.id,t,i;if(n=n||window.event,t=bt(h.curslider.el.parentNode,n),!(t.x<5)&&!(t.x>h.curslider.el.parentNode.offsetWidth-5)&&!(t.y<5)&&!(t.y>h.curslider.el.parentNode.offsetHeight-5))return i=Math.round((t.x-h.curslider.startpos.x-10)/6)*6+10,h.curslider.el.style.left=i+"px",kt(r),n.preventDefault&&n.preventDefault(),!1}function wt(){h.curslider.el!==null&&(b=!1,n(document).off("touchmove.normslider touchend.normslider"),n(document).off("mousemove.normslider mouseup.normslider"),h.curslider.el.parentNode.style.cursor="",h.curslider.el=null)}function kt(n){var t=parseInt(document.getElementById("slid1"+n).style.left)+6,u=parseInt(document.getElementById("slid2"+n).style.left)+6,f=Math.min(t,u),l=Math.max(t,u),o,s,c,r;h.curslider.type=="2O"?document.getElementById("normleft"+n).style.width=f+1+"px":h.curslider.type=="1L"?document.getElementById("normleft"+n).style.width=t+1+"px":h.curslider.type=="2B"&&(document.getElementById("normleft"+n).style.left=f+"px",document.getElementById("normleft"+n).style.width=l-f+1+"px"),h.curslider.type=="2O"?document.getElementById("normright"+n).style.width=500-l+"px":h.curslider.type=="1R"&&(document.getElementById("normright"+n).style.width=500-t+"px");var i=(-4+(t-10)/60).toFixed(1),e=(-4+(u-10)/60).toFixed(1),a=document.getElementById("slid1txt"+n);a.innerHTML=i,a.style.left=t-6+"px",o=document.getElementById("slid2txt"+n),o.innerHTML=e,o.style.left=u-6+"px",s=Math.min(i,e),c=Math.max(i,e),h.curslider.type=="2O"?r="(-oo,"+s+")U("+c+",oo)":h.curslider.type=="2B"?r="("+s+","+c+")":h.curslider.type=="1L"?r="(-oo,"+i+")":h.curslider.type=="1R"&&(r="("+i+",oo)"),document.getElementById("qn"+n).value=r}function dt(n){var t=document.getElementById("shaderegions"+n).value;h.curslider.type=t;var i=parseInt(document.getElementById("slid1"+n).style.left)+6,u=parseInt(document.getElementById("slid2"+n).style.left)+6,r=Math.min(i,u),f=Math.max(i,u);t=="1R"||t=="1L"?(document.getElementById("slid2"+n).style.display="none",document.getElementById("slid2txt"+n).style.display="none",t=="1R"?(document.getElementById("normleft"+n).style.display="none",document.getElementById("normright"+n).style.display="",document.getElementById("normright"+n).style.right="0px",document.getElementById("normright"+n).style.width=500-i+"px"):(document.getElementById("normright"+n).style.display="none",document.getElementById("normleft"+n).style.display="",document.getElementById("normleft"+n).style.left="0px",document.getElementById("normleft"+n).style.width=i+"px")):t=="2O"?(document.getElementById("slid2"+n).style.display="",document.getElementById("slid2txt"+n).style.display="",document.getElementById("normleft"+n).style.display="",document.getElementById("normright"+n).style.display="",document.getElementById("normright"+n).style.right="0px",document.getElementById("normleft"+n).style.left="0px",document.getElementById("normright"+n).style.width=500-f+"px",document.getElementById("normleft"+n).style.width=r+"px"):t=="2B"&&(document.getElementById("slid2"+n).style.display="",document.getElementById("slid2txt"+n).style.display="",document.getElementById("normleft"+n).style.display="",document.getElementById("normright"+n).style.display="none",document.getElementById("normleft"+n).style.left=r+"px",document.getElementById("normleft"+n).style.width=f-r+"px"),kt(n)}function vi(n,t,i,r,u,f,e){var a,b,k;if(u==i)n.moveTo(0,u),n.dashedLine(0,u,f,u);else{var s=(u-i)/((r-t)*(r-t)),c=-2*s*t,w=0;u>i&&(w=e),a=s*t*t+i-w,b=Math.sqrt(c*c-4*s*a),a+=w;var h=(-c-b)/(2*s),g=s*h*h+c*h+a,v=(-c+b)/(2*s),nt=g;v<h&&(k=h,h=v,v=k);for(var p=8,d=p*p,tt=v-h,o=t,l=i,y=0;o>h-5&&o>-5;)y%2==0?n.moveTo(o,l):n.lineTo(o,l),o-=Math.min(Math.sqrt(d/(1+Math.pow(2*s*(o-t),2))),Math.sqrt(p/Math.abs(s))),l=s*o*o+c*o+a,y++;for(o=t,l=i,y=0;o<v+5&&o<f+5;)y%2==0?n.moveTo(o,l):n.lineTo(o,l),o+=Math.min(Math.sqrt(d/(1+Math.pow(2*s*(o-t),2))),Math.sqrt(p/Math.abs(s))),l=s*o*o+c*o+a,y++}n.stroke()}function si(n,t,i,r,u,f,e,o,s){var y,g,tt,b;if(n.beginPath(),u==i)n.moveTo(0,u),n.lineTo(o,u),e<i?(n.lineTo(o,0),n.lineTo(0,0)):(n.lineTo(o,s),n.lineTo(0,s));else{var h=(u-i)/((r-t)*(r-t)),l=-2*h*t,k=0;u>i&&(k=s),y=h*t*t+i-k,g=Math.sqrt(l*l-4*h*y),y+=k;var c=(-l-g)/(2*h),v=h*c*c+l*c+y,a=(-l+g)/(2*h),p=v;a<c&&(tt=c,c=a,a=tt);var w=2*h*(c-t),it=v-w*c,rt=-w,ut=p-rt*a,d=(it-ut)/(rt-w),nt=w*d+it;h<0&&e<h*f*f+l*f+y||h>0&&e>h*f*f+l*f+y?(n.moveTo(c,v),n.quadraticCurveTo(d,nt,a,p)):(b=s,Math.abs(v-s)<2&&(b=0),n.moveTo(0,v),n.lineTo(c,v),n.quadraticCurveTo(d,nt,a,p),n.lineTo(o,p),n.lineTo(o,b),n.lineTo(0,b))}n.closePath()}var g=!1,r=[],st=[],ui=[],e=[],p=[],a=[],u=[],l=[],f=[],w=[],s=null,at=[],k=[],c=null,y=null,ri=["rgb(0,0,255)","rgb(255,0,0)","rgb(0,255,0)"],ai=["rgba(0,0,255,.4)","rgba(255,0,0,.4)","rgba(0,255,0,.4)"],o=null,et=null,t=null,ii=!1,b=!1,tt=!1,ct=!1,ti=null,yi=0,ut=null,h,ni;return typeof initstack!="undefined"?initstack.push(lt):n(function(){lt()}),h={idnums:[],curslider:{el:null,startpos:[0,0],outnode:null}},typeof initstack!="undefined"&&initstack.push(yt),ni={initCanvases:lt,clearcanvas:ci,settool:oi,addnormslider:hi,chgnormtype:dt}}(jQuery);