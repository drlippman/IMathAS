/**
 * Copyleft 2010-2011 Jay and Han (laughinghan@gmail.com)
 *   under the GNU Lesser General Public License
 *     http://www.gnu.org/licenses/lgpl.html
 * Project Website: http://mathquill.com
 *
 * Adapted for IMathAS by David Lippman
 * Source version at https://github.com/drlippman/mathquill
 */
(function(){var tb="editable",sb="intervalId",rb="\\Leftrightarrow ",qb="\\Leftarrow ",pb="\\Rightarrow ",U="</span>",N="<span></span>",ob='<span class="array"></span>',nb="\\backslash ",mb="\\rangle ",lb="\\langle ",L="[",K="]",kb='<span class="sqrt-stem"></span>',jb='<span class="block"><span class="sqrt-prefix">&radic;</span></span>',db="\\int ",T="fontSize",S="em",o="\\",cb="blur",s="$",M="empty",J="hasCursor",n=true,w=")",z="(",l="",y="}",x=" ",C="{",i=false,g=jQuery,q,c,h="[[mathquill internal data]]",Db=Math.min,Gb=Math.max;function fb(){}c=fb.prototype;c.prev=0;c.next=0;c.parent=0;c.firstChild=0;c.lastChild=0;c.eachChild=function(b){for(var a=this.firstChild;a;a=a.next)if(b.call(this,a)===i)break;return this};c.foldChildren=function(a,b){this.eachChild(function(c){a=b.call(this,a,c)});return a};c.keydown=function(a){return this.parent.keydown(a)};c.textInput=function(a){return this.parent.textInput(a)};function p(){}c=p.prototype=new fb;c.init=function(d,b,c,e){var a=this;if(d)a.cmd=d;if(b)a.html_template=b;if(c)a.text_template=c;a.jQ=g(a.html_template[0]).data(h,{cmd:a});a.initBlocks(e)};c.initBlocks=function(c){var a=this;if(a.html_template.length===1){a.firstChild=a.lastChild=a.jQ.data(h).block=c&&c.blockify()||new t;a.firstChild.parent=a;a.firstChild.jQ=a.jQ.append(a.firstChild.jQ);return}var b,d,f=a.html_template.length;this.firstChild=b=d=c&&c.blockify()||new t;b.parent=a;b.jQ=g(a.html_template[1]).data(h,{block:b}).append(b.jQ).appendTo(a.jQ);b.blur();for(var e=2;e<f;e+=1){b=new t;b.parent=a;b.prev=d;d.next=b;d=b;b.jQ=g(a.html_template[e]).data(h,{block:b}).appendTo(a.jQ);b.blur()}a.lastChild=b};c.latex=function(){return this.foldChildren(this.cmd,function(b,a){return b+C+(a.latex()||x)+y})};c.text_template=[l];c.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(c,d){a+=1;var b=d.text();return c&&this.text_template[a]===z&&b[0]===z&&b.slice(-1)===w?c+b.slice(1,-1)+this.text_template[a]:c+d.text()+(this.text_template[a]||l)})};c.insertAt=function(b){var a=this;a.parent=b.parent;a.next=b.next;a.prev=b.prev;if(b.prev)b.prev.next=a;else b.parent.firstChild=a;if(b.next)b.next.prev=a;else b.parent.lastChild=a;b.prev=a;a.jQ.insertBefore(b.jQ);a.respace();a.next&&a.next.respace();a.prev&&a.prev.respace();a.placeCursor(b);b.redraw()};c.respace=g.noop;c.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))};c.isEmpty=function(){return this.foldChildren(n,function(a,b){return a&&b.isEmpty()})};c.remove=function(){var a=this,c=a.prev,b=a.next,d=a.parent;if(c)c.next=b;else d.firstChild=b;if(b)b.prev=c;else d.lastChild=c;a.jQ.remove();return a};function j(a,b,c){this.init(a,[b],[c||(a&&a.length>1?a.slice(1):a)])}c=j.prototype=new p;c.initBlocks=g.noop;c.latex=function(){return this.cmd};c.text=function(){return this.text_template};c.placeCursor=g.noop;c.isEmpty=function(){return n};function t(){}c=t.prototype=new fb;c.latex=function(){return this.foldChildren(l,function(b,a){return b+a.latex()})};c.text=function(){var a=this;return a.firstChild===a.lastChild?a.firstChild.text():a.foldChildren(z,function(b,a){return b+a.text()})+w};c.isEmpty=function(){return this.firstChild===0&&this.lastChild===0};c.focus=function(){var a=this;a.jQ.addClass(J);a.isEmpty()&&a.jQ.removeClass(M);return a};c.blur=function(){var a=this;a.jQ.removeClass(J);a.isEmpty()&&a.jQ.addClass(M);return a};function A(b,d,c){if(!arguments.length)return;var a=this;a.parent=b;a.prev=d||0;a.next=c||0;a.jQinit(a.fold(g(),function(b,a){return a.jQ.add(b)}))}c=A.prototype;c.remove=p.prototype.remove;c.jQinit=function(a){this.jQ=a};c.each=function(c){var a=this;for(var b=a.prev.next||a.parent.firstChild;b!==a.next;b=b.next)if(c.call(a,b)===i)break;return a};c.fold=function(a,b){this.each(function(c){a=b.call(this,a,c)});return a};c.latex=function(){return this.fold(l,function(a,b){return a+b.latex()})};c.blockify=function(){var a=this,d=a.prev,c=a.next,e=a.parent,b=new t,f=b.firstChild=d.next||e.firstChild,g=b.lastChild=c.prev||e.lastChild;if(d)d.next=c;else e.firstChild=c;if(c)c.prev=d;else e.lastChild=d;f.prev=a.prev=0;g.next=a.next=0;a.parent=b;a.each(function(a){a.parent=b});b.jQ=a.jQ;return b};function wb(b,d,w,p){var t="mousedown.mathquill",v=b.contents().detach();!w&&b.addClass("mathquill-rendered-math");d.jQ=b.data(h,{block:d,revert:function(){b.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(v)}});var a=d.cursor=new gb(d);d.renderLatex(v.text());var j=d.textarea=g('<span class="textarea"><textarea></textarea></span>'),c=j.children(),e;d.selectionChanged=function(){if(e===q)e=setTimeout(f);ub(b[0])};function f(){e=q;var b=a.selection?s+a.selection.latex()+s:l;c.val(b);if(b)if(c[0].select)c[0].select();else if(document.selection){var d=c[0].createTextRange();d.expand("textedit");d.select()}}b.bind("selectstart.mathquill",function(a){a.target!==c[0]&&a.preventDefault();a.stopPropagation()});var k,C=a.blink;b.bind(t,function(c){function d(b){a.seek(g(b.target),b.pageX,b.pageY);(a.prev!==k.prev||a.parent!==k.parent)&&a.selectFrom(k);return i}function e(a){delete a.target;return d(a)}function f(){var c="mousemove";k=q;a.blink=C;if(!a.selection)if(p)a.show();else j.detach();b.unbind(c,d);g(document).unbind(c,e).unbind("mouseup",f)}a.blink=g.noop;a.seek(g(c.target),c.pageX,c.pageY);k=new A(a.parent,a.prev,a.next);!p&&b.prepend(j);b.mousemove(d);g(document).mousemove(e).mouseup(f);c.stopPropagation()});if(!p){b.bind("cut paste",i).bind("copy",f).prepend('<span class="selectable">$'+d.latex()+"$</span>");c.blur(function(){a.clearSelection();setTimeout(B)});function B(){j.detach()}return}b.prepend(j);b.addClass("mathquill-editable");w&&b.addClass("mathquill-textbox");c.focus(function(b){!a.parent&&a.appendTo(d);a.parent.jQ.addClass(J);if(a.selection){a.selection.jQ.removeClass(cb);setTimeout(d.selectionChanged)}else a.show();b.stopPropagation()}).blur(function(b){a.hide().parent.blur();a.selection&&a.selection.jQ.addClass(cb);b.stopPropagation()});b.bind("focus.mathquill blur.mathquill",function(a){c.trigger(a)}).bind(t,function(){setTimeout(x)}).bind("click.mathquill",x).blur();function x(){c.focus()}b.bind("cut",function(b){f();a.selection&&setTimeout(function(){a.deleteSelection();a.redraw()});b.stopPropagation()}).bind("copy",function(a){f();m=n;a.stopPropagation()}).bind("paste",function(a){m=n;setTimeout(D);a.stopPropagation()});function D(){var b=c.val();if(b.slice(0,1)===s&&b.slice(-1)===s)b=b.slice(1,-1);else b="\\text{"+b+y;a.writeLatex(b).show();c.val(l)}var u,o,r,m=i;b.bind("keydown.mathquill",function(b){u=b;o=n;a.parent.keydown(b)===i&&b.preventDefault()}).bind("keypress.mathquill",function(b){if(o)o=i;else if(r!==b.which)return;else a.parent.keydown(u);r=b.which;e!==q&&clearTimeout(e);m=i;setTimeout(z)});function z(){if(m)return;var b=c.val();if(b){c.val(l);for(var d=0;d<b.length;d+=1)a.parent.textInput(b.charAt(d))}else(a.selection||e!==q)&&f()}}function V(){}c=V.prototype=new t;c.latex=function(){return t.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")};c.text=function(){return this.foldChildren(l,function(b,a){return b+a.text()})};c.renderLatex=function(b){var a=this;a.jQ.children().slice(1).remove();a.firstChild=a.lastChild=0;a.cursor.appendTo(a).writeLatex(b);a.blur()};c.keydown=function(b){var a=this;b.ctrlKey=b.ctrlKey||b.metaKey;switch(b.originalEvent&&b.originalEvent.keyIdentifier||b.which){case 8:case"Backspace":case"U+0008":if(b.ctrlKey)while(a.cursor.prev||a.cursor.selection)a.cursor.backspace();else a.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(b.ctrlKey)break;var c=a.cursor.parent;if(b.shiftKey)if(c===a.cursor.root)return a.skipTextInput=n;else if(c.prev)a.cursor.appendTo(c.prev);else a.cursor.insertBefore(c.parent);else if(c===a.cursor.root)return a.skipTextInput=n;else if(c.next)a.cursor.prependTo(c.next);else a.cursor.insertAfter(c.parent);a.cursor.clearSelection();break;case 13:case"Enter":typeof savemathquill==="function"&&savemathquill();break;case 35:case"End":if(b.shiftKey)while(a.cursor.next||b.ctrlKey&&a.cursor.parent!==a)a.cursor.selectRight();else a.cursor.clearSelection().appendTo(b.ctrlKey?a:a.cursor.parent);break;case 36:case"Home":if(b.shiftKey)while(a.cursor.prev||b.ctrlKey&&a.cursor.parent!==a)a.cursor.selectLeft();else a.cursor.clearSelection().prependTo(b.ctrlKey?a:a.cursor.parent);break;case 37:case"Left":if(b.ctrlKey)break;if(b.shiftKey)a.cursor.selectLeft();else a.cursor.moveLeft();break;case 38:case"Up":if(b.ctrlKey)break;if(b.shiftKey)if(a.cursor.prev)while(a.cursor.prev)a.cursor.selectLeft();else a.cursor.selectLeft();else if(a.cursor.parent.prev)a.cursor.clearSelection().appendTo(a.cursor.parent.prev);else if(a.cursor.prev)a.cursor.clearSelection().prependTo(a.cursor.parent);else a.cursor.parent!==a&&a.cursor.clearSelection().insertBefore(a.cursor.parent.parent);break;case 39:case"Right":if(b.ctrlKey)break;if(b.shiftKey)a.cursor.selectRight();else a.cursor.moveRight();break;case 40:case"Down":if(b.ctrlKey)break;if(b.shiftKey)if(a.cursor.next)while(a.cursor.next)a.cursor.selectRight();else a.cursor.selectRight();else if(a.cursor.parent.next)a.cursor.clearSelection().prependTo(a.cursor.parent.next);else if(a.cursor.next)a.cursor.clearSelection().appendTo(a.cursor.parent);else a.cursor.parent!==a&&a.cursor.clearSelection().insertAfter(a.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(b.ctrlKey)while(a.cursor.next||a.cursor.selection)a.cursor.deleteForward();else a.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(b.ctrlKey&&!b.shiftKey&&!b.altKey){if(a!==a.cursor.root)return a.parent.keydown(b);a.cursor.clearSelection().appendTo(a);while(a.cursor.prev)a.cursor.selectLeft();break}default:a.skipTextInput=i;return n}a.skipTextInput=n;return i};c.textInput=function(a){!this.skipTextInput&&this.cursor.write(a)};function R(a){this.init(s);this.firstChild.cursor=a;this.firstChild.textInput=function(c){var b=this;if(b.skipTextInput)return;if(c!==s||a.parent!==b)a.write(c);else if(b.isEmpty())a.insertAfter(b.parent).backspace().insertNew(new e("\\$",s)).show();else if(!a.next)a.insertAfter(b.parent);else if(!a.prev)a.insertBefore(b.parent);else a.write(c)}}c=R.prototype=new p;c.html_template=['<span class="mathquill-rendered-math"></span>'];c.initBlocks=function(){var a=this;a.firstChild=a.lastChild=a.jQ.data(h).block=new V;a.firstChild.parent=a;a.firstChild.jQ=a.jQ};c.latex=function(){return s+this.firstChild.latex()+s};function vb(){}c=vb.prototype=new t;c.renderLatex=function(d){var b=this,c=b.cursor;b.jQ.children().slice(1).remove();b.firstChild=b.lastChild=0;c.show().appendTo(b);d=d.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||l;for(var g=0;g<d.length;g+=1){var a=d[g];if(a[0]===s){if(a[-1+a.length]===s&&a[-2+a.length]!==o)a=a.slice(1,-1);else a=a.slice(1);var f=new R(c);c.insertNew(f);f.firstChild.renderLatex(a);c.show().insertAfter(f)}else for(var h=0;h<a.length;h+=1)this.cursor.insertNew(new e(a[h]))}};c.keydown=V.prototype.keydown;c.textInput=function(b){var a=this;if(a.skipTextInput)return;a.cursor.deleteSelection();if(b===s)a.cursor.insertNew(new R(a.cursor));else a.cursor.insertNew(new e(b))};var u={},a={},Q,ub=g.noop,Fb=document.createElement("div"),xb=Fb.style,Eb={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1},bb;for(var Cb in Eb)if(Cb in xb){bb=Cb;break}if(bb)Q=function(a,b,c){a.css(bb,"scale("+b+","+c+w)};else if("filter"in xb){ub=function(a){a.className=a.className};Q=function(c,a,d){a/=1+(d-1)/2;c.addClass("matrixed").css({fontSize:d+S,marginTop:"-.1em",filter:"progid:DXImageTransform.Microsoft.Matrix(M11="+a+",SizingMethod='auto expand')"});function b(){c.css("marginRight",(1+c.width())*(a-1)/a+"px")}b();var e=setInterval(b);g(window).load(function(){clearTimeout(e);b()})}}else Q=function(a,c,b){a.css(T,b+S)};function k(b,a){a.prototype=b.prototype;return a}function b(a){var b=Array.prototype.slice.call(arguments,1);return k(a,function(){a.apply(this,Array.prototype.concat.apply(b,arguments))})}function D(c,b,a){this.init(c,[b],q,a)}k(p,D);a.mathrm=b(D,"\\mathrm",'<span class="roman font"></span>');a.mathit=b(D,"\\mathit",'<i class="font"></i>');a.mathbf=b(D,"\\mathbf",'<b class="font"></b>');a.mathsf=b(D,"\\mathsf",'<span class="sans-serif font"></span>');a.mathtt=b(D,"\\mathtt",'<span class="monospace font"></span>');a.underline=b(D,"\\underline",'<span class="underline"></span>');a.overline=a.bar=b(D,"\\overline",'<span class="overline"></span>');function v(d,b,c,a){this.init(d,[b],[c],a)}c=v.prototype=new p;c.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+C+(a||x)+y};c.redraw=function(){var a=this;a.prev&&a.prev.respace();if(!(a.prev instanceof v)){a.respace();a.next&&!(a.next instanceof v)&&a.next.respace()}};c.respace=function(){var a=this;if(a.prev.cmd===db||a.prev instanceof v&&a.prev.cmd!=a.cmd&&a.prev.prev&&a.prev.prev.cmd===db){if(!a.limit){a.limit=n;a.jQ.addClass("limit")}}else if(a.limit){a.limit=i;a.jQ.removeClass("limit")}a.respaced=a.prev instanceof v&&a.prev.cmd!=a.cmd&&!a.prev.respaced;if(a.respaced){var c=+a.jQ.css(T).slice(0,-2),b=a.prev.jQ.outerWidth();thisWidth=a.jQ.outerWidth();a.jQ.css({left:(a.limit&&a.cmd==="_"?-.25:0)-b/c+S,marginRight:.1-Db(thisWidth,b)/c+S})}else if(a.limit&&a.cmd==="_")a.jQ.css({left:"-.25em",marginRight:l});else a.jQ.css({left:l,marginRight:l});a.next instanceof v&&a.next.respace();return a};a.subscript=a._=k(v,function(a){v.call(this,"_","<sub></sub>","_",a)});a.superscript=a.supscript=a["^"]=k(v,function(a){v.call(this,"^","<sup></sup>","**",a)});function Z(a){this.init("\\frac",q,q,a);this.jQ.append('<span style="display:inline-block;width:0">&nbsp;</span>')}c=Z.prototype=new p;c.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'];c.text_template=[z,"/",w];c.redraw=function(){var a="width";if(g.browser.msie&&parseInt(g.browser.version,10)<=7){var e=this.jQ,d=e.children(".numerator"),c=e.children(".denominator"),b;d.css(a,"auto");c.css(a,"auto");b=Math.max(d.width(),c.width());d.css(a,b+"px");c.css(a,b+"px")}};a.frac=a.dfrac=a.cfrac=a.fraction=Z;function eb(){Z.apply(this,arguments)}c=eb.prototype=new Z;c.placeCursor=function(d){var b=this;if(b.firstChild.isEmpty()){var a=b.prev;while(a&&!(a instanceof f||a instanceof B||a instanceof G))a=a.prev;if(a instanceof G&&a.next instanceof v){a=a.next;if(a.next instanceof v&&a.next.cmd!=a.cmd)a=a.next}if(a!==b.prev){var c=new A(b.parent,a,b).blockify();c.jQ=b.firstChild.jQ.empty().removeClass(M).append(c.jQ).data(h,{block:c});c.next=b.lastChild;c.parent=b;b.firstChild=b.lastChild.prev=c}}d.appendTo(b.lastChild)};a.over=u["/"]=eb;function W(a){this.init("\\sqrt",q,q,a)}c=W.prototype=new p;c.html_template=[jb,kb];c.text_template=["sqrt(",w];c.redraw=function(){var a=this.lastChild.jQ;Q(a.prev(),1,a.innerHeight()/+a.css(T).slice(0,-2)-.1)};a.sqrt=a["√"]=W;function yb(b){var a=this;W.call(a,b);a.jQ=a.firstChild.jQ.detach().add(a.jQ)}c=yb.prototype=new W;c.html_template=[jb,'<sup class="nthroot"></sup>',kb];c.text_template=["sqrt[","](",w];c.latex=function(){return"\\nthroot{"+this.firstChild.latex()+"}{"+this.lastChild.latex()+y};a.nthroot=yb;function r(b,a,d,e,c){this.init("\\left"+d,['<span class="block"><span class="paren">'+b+'</span><span class="block"></span><span class="paren">'+a+"</span></span>"],[b,a],c);this.end="\\right"+e}c=r.prototype=new p;c.initBlocks=function(b){var a=this;a.firstChild=a.lastChild=b&&b.blockify()||new t;a.firstChild.parent=a;a.firstChild.jQ=a.jQ.children(":eq(1)").data(h,{block:a.firstChild}).append(a.firstChild.jQ);var c=a.blockjQ=a.firstChild.jQ;a.bracketjQs=c.prev().add(c.next())};c.latex=function(){return this.cmd+this.firstChild.latex()+this.end};c.redraw=function(){var a=this.blockjQ.outerHeight()/+this.blockjQ.css(T).slice(0,-2);Q(this.bracketjQs,Db(1+.2*(a-1),1.2),1.05*a)};a.intervalopenleft=k(r,function(a){r.call(this,z,K,z,K,a)});a.intervalopenright=k(r,function(a){r.call(this,L,w,L,w,a)});a.lbrace=u[C]=k(r,function(a){r.call(this,C,y,"\\{","\\}",a)});a.langle=a.lang=k(r,function(a){r.call(this,"&lang;","&rang;",lb,mb,a)});function F(){r.apply(this,arguments)}c=F.prototype=new r;c.placeCursor=function(b){var a=this;if(!a.next&&a.parent.parent&&a.parent.parent.end===a.end&&a.firstChild.isEmpty())b.backspace().insertAfter(a.parent.parent);else{a.firstChild.blur();a.redraw()}};a.rbrace=u[y]=k(F,function(a){F.call(this,C,y,"\\{","\\}",a)});a.rangle=a.rang=k(F,function(a){F.call(this,"&lang;","&rang;",lb,mb,a)});function H(b,a,c){r.call(this,b,a,b,a,c)}H.prototype=r.prototype;a.lparen=u[z]=k(H,function(a){H.call(this,z,w,a)});a.lbrack=a.lbracket=u[L]=k(H,function(a){H.call(this,L,K,a)});function O(b,a,c){F.call(this,b,a,b,a,c)}O.prototype=F.prototype;a.rparen=u[w]=k(O,function(a){O.call(this,z,w,a)});a.rbrack=a.rbracket=u[K]=k(O,function(a){O.call(this,L,K,a)});function Bb(a){H.call(this,"|","|",a)}c=Bb.prototype=new H;c.placeCursor=function(b){var a=this;if(!a.next&&a.parent.parent&&a.parent.parent.end===a.end&&a.firstChild.isEmpty())b.backspace().insertAfter(a.parent.parent);else b.appendTo(a.firstChild)};a.lpipe=a.rpipe=u["|"]=Bb;function B(a){if(a instanceof A)this.replacedText=a.remove().jQ.text();else if(typeof a==="string")this.replacedText=a;this.init()}c=B.prototype=new p;c.cmd="\\text";c.html_template=['<span class="text"></span>'];c.text_template=['"','"'];c.initBlocks=function(){var a=this;a.firstChild=a.lastChild=a.jQ.data(h).block=new ib;a.firstChild.parent=a;a.firstChild.jQ=a.jQ.append(a.firstChild.jQ)};c.placeCursor=function(c){var a=this;(a.cursor=c).appendTo(a.firstChild);if(a.replacedText)for(var b=0;b<a.replacedText.length;b+=1)a.write(a.replacedText.charAt(b))};c.write=function(a){this.cursor.insertNew(new e(a))};c.keydown=function(b){var a=this;if(!a.cursor.selection&&(b.which===8&&!a.cursor.prev||b.which===46&&!a.cursor.next)){a.isEmpty()&&a.cursor.insertAfter(a);return i}return a.parent.keydown(b)};c.textInput=function(c){var a=this;a.cursor.deleteSelection();if(c!==s)a.write(c);else if(a.isEmpty())a.cursor.insertAfter(a).backspace().insertNew(new e("\\$",s));else if(!a.cursor.next)a.cursor.insertAfter(a);else if(!a.cursor.prev)a.cursor.insertBefore(a);else{var b=new B(new A(a.firstChild,a.cursor.prev));b.placeCursor=function(a){this.prev=0;delete this.placeCursor;this.placeCursor(a)};b.firstChild.focus=function(){return this};a.cursor.insertAfter(a).insertNew(b);b.prev=a;a.cursor.insertBefore(b);delete b.firstChild.focus}};function ib(){}c=ib.prototype=new t;c.blur=function(){var c=this;c.jQ.removeClass(J);if(c.isEmpty()){var b=c.parent,a=b.cursor;if(a.parent===c)c.jQ.addClass(M);else{a.hide();b.remove();if(a.next===b)a.next=b.next;else if(a.prev===b)a.prev=b.prev;a.show().redraw()}}return c};c.focus=function(){var a=this;t.prototype.focus.call(a);var b=a.parent;if(b.next.cmd===b.cmd){var e=a,c=b.cursor,d=b.next.firstChild;d.eachChild(function(a){a.parent=e;a.jQ.appendTo(e.jQ)});if(a.lastChild)a.lastChild.next=d.firstChild;else a.firstChild=d.firstChild;d.firstChild.prev=a.lastChild;a.lastChild=d.lastChild;d.parent.remove();if(c.prev)c.insertAfter(c.prev);else c.prependTo(a);c.redraw()}else if(b.prev.cmd===b.cmd){var c=b.cursor;if(c.prev)b.prev.firstChild.focus();else c.appendTo(b.prev.firstChild)}return a};u.$=a.text=a.textnormal=a.textrm=a.textup=a.textmd=B;function E(b,d){function a(){B.apply(this,arguments)}c=a.prototype=new B;c.cmd=b;c.html_template=[d];return a}a.em=a.italic=a.italics=a.emph=a.textit=a.textsl=E("\\textit",'<i class="text"></i>');a.strong=a.bold=a.textbf=E("\\textbf",'<b class="text"></b>');a.sf=a.textsf=E("\\textsf",'<span class="sans-serif text"></span>');a.tt=a.texttt=E("\\texttt",'<span class="monospace text"></span>');a.textsc=E("\\textsc",'<span style="font-variant:small-caps" class="text"></span>');a.uppercase=E("\\uppercase",'<span style="text-transform:uppercase" class="text"></span>');a.lowercase=E("\\lowercase",'<span style="text-transform:lowercase" class="text"></span>');function hb(a){this.init(o);if(a){this.replacedFragment=a.detach();this.isEmpty=function(){return i}}}c=hb.prototype=new p;c.html_template=['<span class="latex-command-input">\\</span>'];c.text_template=[o];c.placeCursor=function(b){var a=this;a.cursor=b.appendTo(a.firstChild);if(a.replacedFragment)a.jQ=a.jQ.add(a.replacedFragment.jQ.addClass(cb).bind("mousedown mousemove",function(a){g(a.target=this.nextSibling).trigger(a);return i}).insertBefore(a.jQ))};c.latex=function(){return o+this.firstChild.latex()+x};c.keydown=function(a){if(a.which===9||a.which===13){this.renderCommand();return i}return this.parent.keydown(a)};c.textInput=function(b){var a=this;if(b.match(/[a-z]/i)){a.cursor.deleteSelection();a.cursor.insertNew(new e(b));return}a.renderCommand();if(b===x||b===o&&a.firstChild.isEmpty())return;a.cursor.parent.textInput(b)};c.renderCommand=function(){var a=this;a.jQ=a.jQ.last();a.remove();if(a.next)a.cursor.insertBefore(a.next);else a.cursor.appendTo(a.parent);var b=a.firstChild.latex();if(b)a.cursor.insertCmd(b,a.replacedFragment);else{var c=new e(nb,o);a.cursor.insertNew(c);a.replacedFragment&&a.replacedFragment.remove()}};u[o]=hb;function Y(b){var a=this;a.init("\\binom",q,q,b);a.jQ.wrapInner(ob);a.blockjQ=a.jQ.children();a.bracketjQs=g('<span class="paren">(</span>').prependTo(a.jQ).add(g('<span class="paren">)</span>').appendTo(a.jQ))}c=Y.prototype=new p;c.html_template=['<span class="block"></span>',N,N];c.text_template=["choose(",",",w];c.redraw=r.prototype.redraw;a.binom=a.binomial=Y;function zb(){Y.apply(this,arguments)}c=zb.prototype=new Y;c.placeCursor=eb.prototype.placeCursor;a.choose=zb;function Ab(a){this.init("\\vector",q,q,a)}c=Ab.prototype=new p;c.html_template=[ob,N];c.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){a.push(b.latex());return a}).join("\\\\")+"\\end{matrix}"};c.text=function(){return L+this.foldChildren([],function(a,b){a.push(b.text());return a}).join()+K};c.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)};c.keydown=function(d){var b=this,a=b.cursor.parent;if(a.parent===b)if(d.which===13){var c=new t;c.parent=b;c.jQ=g(N).data(h,{block:c}).insertAfter(a.jQ);if(a.next)a.next.prev=c;else b.lastChild=c;c.next=a.next;a.next=c;c.prev=a;b.cursor.appendTo(c).redraw();return i}else if(d.which===9&&!d.shiftKey&&!a.next){if(a.isEmpty())if(a.prev){b.cursor.insertAfter(b);delete a.prev.next;b.lastChild=a.prev;a.jQ.remove();b.cursor.redraw();return i}else return b.parent.keydown(d);var c=new t;c.parent=b;c.jQ=g(N).data(h,{block:c}).appendTo(b.jQ);b.lastChild=c;a.next=c;c.prev=a;b.cursor.appendTo(c).redraw();return i}else if(d.which===8)if(a.isEmpty()){if(a.prev){b.cursor.appendTo(a.prev);a.prev.next=a.next}else{b.cursor.insertBefore(b);b.firstChild=a.next}if(a.next)a.next.prev=a.prev;else b.lastChild=a.prev;a.jQ.remove();if(b.isEmpty())b.cursor.deleteForward();else b.cursor.redraw();return i}else if(!b.cursor.prev)return i;return b.parent.keydown(d)};a.vector=Ab;a.editable=k(R,function(){var a=this;a.init("\\editable");wb(a.jQ,a.firstChild,i,n);var b;a.placeCursor=function(a){b=a.appendTo(this.firstChild)};a.firstChild.blur=function(){var a=this;if(b.prev!==a.parent)return;delete a.blur;a.cursor.appendTo(a);t.prototype.blur.call(a)};a.latex=function(){return this.firstChild.latex()};a.text=function(){return this.firstChild.text()}});a.f=b(j,"f",'<var class="florin">&fnof;</var><span style="display:inline-block;width:0">&nbsp;</span>');function m(a,b){j.call(this,a,"<var>"+(b||a)+"</var>")}c=m.prototype=new j;c.text=function(){var a=this,b=a.cmd;if(a.prev&&!(a.prev instanceof m)&&!(a.prev instanceof f))b="*"+b;if(a.next&&!(a.next instanceof f)&&!(a.next.cmd==="^"))b+="*";return b};c.insertAt=function(b){var c=this.cmd;d=b.prev;while(d&&d instanceof m){c=d.cmd+c;d=d.prev}var a;if(a=c.match(/(sqrt|root|arcsin|arccos|arctan|sin|cos|tan|sec|csc|cot|log|ln)/)){for(var e=0;e<a[0].length-1;e++)b.selectLeft();if(a[0]=="root")a[0]="nthroot{3}";b.writeLatex(o+a[0]);a[0].match(/(sqrt|root)/)&&b.moveLeft()}else if(a=c.match(/(pi|\boo)$/)){if(a[0]=="oo")a[0]="infty";b.selectLeft();b.writeLatex(o+a[0])}else p.prototype.insertAt.apply(this,arguments)};function e(a,b){j.call(this,a,"<span>"+(b||a)+U)}e.prototype=j.prototype;u[x]=b(e,"\\:",x);a.prime=u["'"]=b(e,"'","&prime;");function I(a,b){j.call(this,a,'<span class="nonSymbola">'+(b||a)+U)}I.prototype=j.prototype;a["@"]=I;a["&"]=b(I,"\\&","&");a["%"]=b(I,"\\%","%");a.alpha=a.beta=a.gamma=a.delta=a.zeta=a.eta=a.theta=a.iota=a.kappa=a.mu=a.nu=a.xi=a.rho=a.sigma=a.tau=a.chi=a.psi=a.omega=k(j,function(b,a){m.call(this,o+a+x,"&"+a+";")});a.phi=b(m,"\\phi ","&#981;");a.phiv=a.varphi=b(m,"\\varphi ","&phi;");a.epsilon=b(m,"\\epsilon ","&#1013;");a.epsiv=a.varepsilon=b(m,"\\varepsilon ","&epsilon;");a.piv=a.varpi=b(m,"\\varpi ","&piv;");a.sigmaf=a.sigmav=a.varsigma=b(m,"\\varsigma ","&sigmaf;");a.thetav=a.vartheta=a.thetasym=b(m,"\\vartheta ","&thetasym;");a.upsilon=a.upsi=b(m,"\\upsilon ","&upsilon;");a.gammad=a.Gammad=a.digamma=b(m,"\\digamma ","&#989;");a.kappav=a.varkappa=b(m,"\\varkappa ","&#1008;");a.rhov=a.varrho=b(m,"\\varrho ","&#1009;");a.pi=a["π"]=b(I,"\\pi ","&pi;");a.lambda=b(I,"\\lambda ","&lambda;");a.Upsilon=a.Upsi=a.upsih=a.Upsih=b(j,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>');a.Gamma=a.Delta=a.Theta=a.Lambda=a.Xi=a.Pi=a.Sigma=a.Phi=a.Psi=a.Omega=a.forall=k(j,function(b,a){e.call(this,o+a+x,"&"+a+";")});function f(c,a,b){j.call(this,c,'<span class="binary-operator">'+a+U,b)}c=f.prototype=new j;c.insertAt=function(a){var b=a.prev.cmd+this.cmd;if(b==="<=")a.backspace().insertNew(new f("\\le ","&le;"));else if(b===">=")a.backspace().insertNew(new f("\\ge ","&ge;"));else p.prototype.insertAt.apply(this,arguments)};function P(){e.apply(this,arguments)}c=P.prototype=new f;c.respace=function(){var a=this;if(!a.prev)a.jQ[0].className=l;else if(a.prev instanceof f&&a.next&&!(a.next instanceof f))a.jQ[0].className="unary-operator";else a.jQ[0].className="binary-operator";return a};a["+"]=b(P,"+","+");a["–"]=a["-"]=b(P,"-","&minus;");a["±"]=a.pm=a.plusmn=a.plusminus=b(P,"\\pm ","&plusmn;");a.mp=a.mnplus=a.minusplus=b(P,"\\mp ","&#8723;");u["*"]=a.sdot=a.cdot=b(f,"\\cdot ","&middot;");a["="]=b(f,"=","=");a["<"]=b(f,"<","&lt;");a[">"]=b(f,">","&gt;");a.notin=a.sim=a.cong=a.equiv=a.oplus=a.otimes=k(f,function(b,a){f.call(this,o+a+x,"&"+a+";")});a.times=k(f,function(){f.call(this,"\\times ","&times;","[x]")});a["÷"]=a.div=a.divide=a.divides=b(f,"\\div ","&divide;","[/]");a["≠"]=a.ne=a.neq=b(f,"\\ne ","&ne;");a.ast=a.star=a.loast=a.lowast=b(f,"\\ast ","&lowast;");a.therefor=a.therefore=b(f,"\\therefore ","&there4;");a.cuz=a.because=b(f,"\\because ","&#8757;");a.prop=a.propto=b(f,"\\propto ","&prop;");a["≈"]=a.asymp=a.approx=b(f,"\\approx ","&asymp;");a.lt=b(f,"<","&lt;");a.gt=b(f,">","&gt;");a["≤"]=a.le=a.leq=b(f,"\\le ","&le;");a["≥"]=a.ge=a.geq=b(f,"\\ge ","&ge;");a.isin=a["in"]=b(f,"\\in ","&isin;");a.ni=a.contains=b(f,"\\ni ","&ni;");a.notni=a.niton=a.notcontains=a.doesnotcontain=b(f,"\\not\\ni ","&#8716;");a.sub=a.subset=b(f,"\\subset ","&sub;");a.sup=a.supset=a.superset=b(f,"\\supset ","&sup;");a.nsub=a.notsub=a.nsubset=a.notsubset=b(f,"\\not\\subset ","&#8836;");a.nsup=a.notsup=a.nsupset=a.notsupset=a.nsuperset=a.notsuperset=b(f,"\\not\\supset ","&#8837;");a.sube=a.subeq=a.subsete=a.subseteq=b(f,"\\subseteq ","&sube;");a.supe=a.supeq=a.supsete=a.supseteq=a.supersete=a.superseteq=b(f,"\\supseteq ","&supe;");a.nsube=a.nsubeq=a.notsube=a.notsubeq=a.nsubsete=a.nsubseteq=a.notsubsete=a.notsubseteq=b(f,"\\not\\subseteq ","&#8840;");a.nsupe=a.nsupeq=a.notsupe=a.notsupeq=a.nsupsete=a.nsupseteq=a.notsupsete=a.notsupseteq=a.nsupersete=a.nsuperseteq=a.notsupersete=a.notsuperseteq=b(f,"\\not\\supseteq ","&#8841;");function G(b,a){j.call(this,b,"<big>"+a+"</big>")}G.prototype=new j;a["∑"]=a.sum=a.summation=b(G,"\\sum ","&sum;");a["∏"]=a.prod=a.product=b(G,"\\prod ","&prod;");a.coprod=a.coproduct=b(G,"\\coprod ","&#8720;");a["∫"]=a.int=a.integral=b(G,db,"&int;");a.N=a.naturals=a.Naturals=b(e,"\\mathbb{N}","&#8469;");a.P=a.primes=a.Primes=a.projective=a.Projective=a.probability=a.Probability=b(e,"\\mathbb{P}","&#8473;");a.Z=a.integers=a.Integers=b(e,"\\mathbb{Z}","&#8484;");a.Q=a.rationals=a.Rationals=b(e,"\\mathbb{Q}","&#8474;");a.R=a.reals=a.Reals=b(e,"\\mathbb{R}","&#8477;");a.C=a.complex=a.Complex=a.complexes=a.Complexes=a.complexplane=a.Complexplane=a.ComplexPlane=b(e,"\\mathbb{C}","&#8450;");a.H=a.Hamiltonian=a.quaternions=a.Quaternions=b(e,"\\mathbb{H}","&#8461;");a.quad=a.emsp=b(e,"\\quad ","    ");a.qquad=b(e,"\\qquad ","        ");a.diamond=b(e,"\\diamond ","&#9671;");a.bigtriangleup=b(e,"\\bigtriangleup ","&#9651;");a.ominus=b(e,"\\ominus ","&#8854;");a.uplus=b(e,"\\uplus ","&#8846;");a.bigtriangledown=b(e,"\\bigtriangledown ","&#9661;");a.sqcap=b(e,"\\sqcap ","&#8851;");a.triangleleft=b(e,"\\triangleleft ","&#8882;");a.sqcup=b(e,"\\sqcup ","&#8852;");a.triangleright=b(e,"\\triangleright ","&#8883;");a.odot=b(e,"\\odot ","&#8857;");a.bigcirc=b(e,"\\bigcirc ","&#9711;");a.dagger=b(e,"\\dagger ","&#0134;");a.ddagger=b(e,"\\ddagger ","&#135;");a.wr=b(e,"\\wr ","&#8768;");a.amalg=b(e,"\\amalg ","&#8720;");a.models=b(e,"\\models ","&#8872;");a.prec=b(e,"\\prec ","&#8826;");a.succ=b(e,"\\succ ","&#8827;");a.preceq=b(e,"\\preceq ","&#8828;");a.succeq=b(e,"\\succeq ","&#8829;");a.simeq=b(e,"\\simeq ","&#8771;");a.mid=b(e,"\\mid ","&#8739;");a.ll=b(e,"\\ll ","&#8810;");a.gg=b(e,"\\gg ","&#8811;");a.parallel=b(e,"\\parallel ","&#8741;");a.bowtie=b(e,"\\bowtie ","&#8904;");a.sqsubset=b(e,"\\sqsubset ","&#8847;");a.sqsupset=b(e,"\\sqsupset ","&#8848;");a.smile=b(e,"\\smile ","&#8995;");a.sqsubseteq=b(e,"\\sqsubseteq ","&#8849;");a.sqsupseteq=b(e,"\\sqsupseteq ","&#8850;");a.doteq=b(e,"\\doteq ","&#8784;");a.frown=b(e,"\\frown ","&#8994;");a.vdash=b(e,"\\vdash ","&#8870;");a.dashv=b(e,"\\dashv ","&#8867;");a.longleftarrow=b(e,"\\longleftarrow ","&#8592;");a.longrightarrow=b(e,"\\longrightarrow ","&#8594;");a.Longleftarrow=b(e,"\\Longleftarrow ","&#8656;");a.Longrightarrow=b(e,"\\Longrightarrow ","&#8658;");a.longleftrightarrow=b(e,"\\longleftrightarrow ","&#8596;");a.updownarrow=b(e,"\\updownarrow ","&#8597;");a.Longleftrightarrow=b(e,"\\Longleftrightarrow ","&#8660;");a.Updownarrow=b(e,"\\Updownarrow ","&#8661;");a.mapsto=b(e,"\\mapsto ","&#8614;");a.nearrow=b(e,"\\nearrow ","&#8599;");a.hookleftarrow=b(e,"\\hookleftarrow ","&#8617;");a.hookrightarrow=b(e,"\\hookrightarrow ","&#8618;");a.searrow=b(e,"\\searrow ","&#8600;");a.leftharpoonup=b(e,"\\leftharpoonup ","&#8636;");a.rightharpoonup=b(e,"\\rightharpoonup ","&#8640;");a.swarrow=b(e,"\\swarrow ","&#8601;");a.leftharpoondown=b(e,"\\leftharpoondown ","&#8637;");a.rightharpoondown=b(e,"\\rightharpoondown ","&#8641;");a.nwarrow=b(e,"\\nwarrow ","&#8598;");a.ldots=b(e,"\\ldots ","&#8230;");a.cdots=b(e,"\\cdots ","&#8943;");a.vdots=b(e,"\\vdots ","&#8942;");a.ddots=b(e,"\\ddots ","&#8944;");a.surd=b(e,"\\surd ","&#8730;");a.triangle=b(e,"\\triangle ","&#9653;");a.ell=b(e,"\\ell ","&#8467;");a.top=b(e,"\\top ","&#8868;");a.flat=b(e,"\\flat ","&#9837;");a.natural=b(e,"\\natural ","&#9838;");a.sharp=b(e,"\\sharp ","&#9839;");a.wp=b(e,"\\wp ","&#8472;");a.bot=b(e,"\\bot ","&#8869;");a.clubsuit=b(e,"\\clubsuit ","&#9827;");a.diamondsuit=b(e,"\\diamondsuit ","&#9826;");a.heartsuit=b(e,"\\heartsuit ","&#9825;");a.spadesuit=b(e,"\\spadesuit ","&#9824;");a.oint=b(e,"\\oint ","&#8750;");a.bigcap=b(e,"\\bigcap ","&#8745;");a.bigcup=b(e,"\\bigcup ","&#8746;");a.bigsqcup=b(e,"\\bigsqcup ","&#8852;");a.bigvee=b(e,"\\bigvee ","&#8744;");a.bigwedge=b(e,"\\bigwedge ","&#8743;");a.bigodot=b(e,"\\bigodot ","&#8857;");a.bigotimes=b(e,"\\bigotimes ","&#8855;");a.bigoplus=b(e,"\\bigoplus ","&#8853;");a.biguplus=b(e,"\\biguplus ","&#8846;");a.lfloor=b(e,"\\lfloor ","&#8970;");a.rfloor=b(e,"\\rfloor ","&#8971;");a.lceil=b(e,"\\lceil ","&#8968;");a.rceil=b(e,"\\rceil ","&#8969;");a.slash=b(e,"\\slash ","&#47;");a.opencurlybrace=b(e,"\\opencurlybrace ","&#123;");a.closecurlybrace=b(e,"\\closecurlybrace ","&#125;");a.caret=b(e,"\\caret ","^");a.underscore=b(e,"\\underscore ","_");a.backslash=b(e,nb,o);a.vert=b(e,"|");a.perp=a.perpendicular=b(e,"\\perp ","&perp;");a.nabla=a.del=b(e,"\\nabla ","&nabla;");a.hbar=b(e,"\\hbar ","&#8463;");a.AA=a.Angstrom=a.angstrom=b(e,"\\text\\AA ","&#8491;");a.ring=a.circ=a.circle=b(e,"\\circ ","&#8728;");a.bull=a.bullet=b(e,"\\bullet ","&bull;");a.setminus=a.smallsetminus=b(e,"\\setminus ","&#8726;");a.not=a["¬"]=a.neg=b(e,"\\neg ","&not;");a["…"]=a.dots=a.ellip=a.hellip=a.ellipsis=a.hellipsis=b(e,"\\dots ","&hellip;");a.converges=a.darr=a.dnarr=a.dnarrow=a.downarrow=b(e,"\\downarrow ","&darr;");a.dArr=a.dnArr=a.dnArrow=a.Downarrow=b(e,"\\Downarrow ","&dArr;");a.diverges=a.uarr=a.uparrow=b(e,"\\uparrow ","&uarr;");a.uArr=a.Uparrow=b(e,"\\Uparrow ","&uArr;");a.to=b(f,"\\to ","&rarr;");a.rarr=a.rightarrow=b(e,"\\rightarrow ","&rarr;");a.implies=b(f,pb,"&rArr;");a.rArr=a.Rightarrow=b(e,pb,"&rArr;");a.gets=b(f,"\\gets ","&larr;");a.larr=a.leftarrow=b(e,"\\leftarrow ","&larr;");a.impliedby=b(f,qb,"&lArr;");a.lArr=a.Leftarrow=b(e,qb,"&lArr;");a.harr=a.lrarr=a.leftrightarrow=b(e,"\\leftrightarrow ","&harr;");a.iff=b(f,rb,"&hArr;");a.hArr=a.lrArr=a.Leftrightarrow=b(e,rb,"&hArr;");a.Re=a.Real=a.real=b(e,"\\Re ","&real;");a.Im=a.imag=a.image=a.imagin=a.imaginary=a.Imaginary=b(e,"\\Im ","&image;");a.part=a.partial=b(e,"\\partial ","&part;");a.inf=a.infin=a.infty=a.infinity=b(e,"\\infty ","&infin;");a.alef=a.alefsym=a.aleph=a.alephsym=b(e,"\\aleph ","&alefsym;");a.xist=a.xists=a.exist=a.exists=b(e,"\\exists ","&exist;");a.and=a.land=a.wedge=b(e,"\\wedge ","&and;");a.or=a.lor=a.vee=b(e,"\\vee ","&or;");a.o=a.O=a.empty=a.emptyset=a.oslash=a.Oslash=a.nothing=a.varnothing=b(f,"\\varnothing ","&empty;");a.cup=a.union=b(f,"\\cup ","&cup;");a.cap=a.intersect=a.intersection=b(f,"\\cap ","&cap;");a.deg=a.degree=b(e,"^\\circ ","&deg;");a.ang=a.angle=b(e,"\\angle ","&ang;");function ab(b,a){j.call(this,o+a+x,"<span>"+a+U)}c=ab.prototype=new j;c.respace=function(){this.jQ[0].className=this.next instanceof v||this.next instanceof r?l:"non-italicized-function"};a.ln=a.lg=a.log=a.span=a.proj=a.det=a.dim=a.min=a.max=a.mod=a.lcm=a.gcd=a.gcf=a.hcf=a.lim=ab;(function(){var b=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var c in b)a[b[c]]=a[b[c]+"h"]=a["a"+b[c]]=a["arc"+b[c]]=a["a"+b[c]+"h"]=a["arc"+b[c]+"h"]=ab})();function gb(b){var a=this;a.parent=a.root=b;var c=a.jQ=a._jQ=g('<span class="cursor">&zwj;</span>');a.blink=function(){c.toggleClass("blink")}}c=gb.prototype;c.prev=0;c.next=0;c.parent=0;c.show=function(){var a=this;a.jQ=a._jQ.removeClass("blink");if(sb in a)clearInterval(a.intervalId);else{if(a.next)if(a.selection&&a.selection.prev===a.prev)a.jQ.insertBefore(a.selection.jQ);else a.jQ.insertBefore(a.next.jQ.first());else a.jQ.appendTo(a.parent.jQ);a.parent.focus()}a.intervalId=setInterval(a.blink,500);return a};c.hide=function(){var a=this;sb in a&&clearInterval(a.intervalId);delete a.intervalId;a.jQ.detach();a.jQ=g();return a};c.redraw=function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()};c.insertAt=function(c,e,d){var a=this,b=a.parent;a.parent=c;a.prev=e;a.next=d;b.blur()};c.insertBefore=function(b){var a=this;a.insertAt(b.parent,b.prev,b);a.parent.jQ.addClass(J);a.jQ.insertBefore(b.jQ.first());return a};c.insertAfter=function(b){var a=this;a.insertAt(b.parent,b,b.next);a.parent.jQ.addClass(J);a.jQ.insertAfter(b.jQ.last());return a};c.prependTo=function(a){var b=this;b.insertAt(a,0,a.firstChild);if(a.textarea)b.jQ.insertAfter(a.textarea);else b.jQ.prependTo(a.jQ);a.focus();return b};c.appendTo=function(a){this.insertAt(a,a.lastChild,0);this.jQ.appendTo(a.jQ);a.focus();return this};c.hopLeft=function(){var a=this;a.jQ.insertBefore(a.prev.jQ.first());a.next=a.prev;a.prev=a.prev.prev;return a};c.hopRight=function(){var a=this;a.jQ.insertAfter(a.next.jQ.last());a.prev=a.next;a.next=a.next.next;return a};c.moveLeft=function(){var a=this;if(a.selection)a.insertBefore(a.selection.prev.next||a.parent.firstChild).clearSelection();else if(a.prev)if(a.prev.lastChild)a.appendTo(a.prev.lastChild);else a.hopLeft();else if(a.parent.prev)a.appendTo(a.parent.prev);else a.parent!==a.root&&a.insertBefore(a.parent.parent);return a.show()};c.moveRight=function(){var a=this;if(a.selection)a.insertAfter(a.selection.next.prev||a.parent.lastChild).clearSelection();else if(a.next)if(a.next.firstChild)a.prependTo(a.next.firstChild);else a.hopRight();else if(a.parent.next)a.prependTo(a.parent.next);else a.parent!==a.root&&a.insertAfter(a.parent.parent);return a.show()};c.seek=function(c,e){var a=this.clearSelection();if(c.hasClass(M)){a.prependTo(c.data(h).block);return a}var b=c.data(h);if(b){if(b.cmd&&!b.block){if(c.outerWidth()>2*(e-c.offset().left))a.insertBefore(b.cmd);else a.insertAfter(b.cmd);return a}}else{c=c.parent();b=c.data(h);if(!b)b={block:a.root}}if(b.cmd)a.insertAfter(b.cmd);else a.appendTo(b.block);var d=a.jQ.offset().left-e,f;do{a.moveLeft();f=d;d=a.jQ.offset().left-e}while(d>0&&(a.prev||a.parent!==a.root));-d>f&&a.moveRight();return a};c.writeLatex=function(b){this.deleteSelection();b=b&&b.match(/\\text\{([^}]|\\\})*\}|\\[a-z]*|[^\s]/ig)||0;(function c(g){while(b.length){var d=b.shift();if(!d||d===y)return;var f;if(d.slice(0,6)==="\\text{"){f=new B(d.slice(6,-1));g.insertNew(f).insertAfter(f);continue}else if(d==="\\left"||d==="\\right"){d=b.shift();if(d===o)d=b.shift();g.insertCh(d);f=g.prev||g.parent.parent;if(g.prev)return;else b.unshift(C)}else if(/^\\[a-z]+$/i.test(d)){d=d.slice(1);var f=a[d];if(f)g.insertNew(f=new f(q,d));else{f=new B(d);g.insertNew(f).insertAfter(f);continue}}else{if(d.match(/[a-eg-zA-Z]/))f=new m(d);else if(f=a[d])f=new f;else f=new e(d);g.insertNew(f)}f.eachChild(function(d){g.appendTo(d);var a=b.shift();if(!a)return i;if(a===C)c(g);else g.insertCh(a)});g.insertAfter(f)}})(this);return this.hide()};c.write=function(a){return this.show().insertCh(a)};c.insertCh=function(d){var b=this;if(b.selection){b.prev=b.selection.prev;b.next=b.selection.next}var c;if(d.match(/^[a-eg-zA-Z]$/))c=new m(d);else if(c=u[d]||a[d])c=new c(b.selection,d);else c=new e(d);if(b.selection){c instanceof j&&b.selection.remove();delete b.selection}return b.insertNew(c)};c.insertNew=function(a){a.insertAt(this);return this};c.insertCmd=function(d,c){var b=a[d];if(b){b=new b(c,d);this.insertNew(b);b instanceof j&&c&&c.remove()}else{b=new B(d);b.firstChild.focus=function(){delete this.focus;return this};this.insertNew(b).insertAfter(b);c&&c.remove()}return this};c.unwrapGramp=function(){var a=this,b=a.parent.parent,d=b.parent,c=b.prev,e=a;b.eachChild(function(a){if(a.isEmpty())return;a.eachChild(function(a){a.parent=d;a.jQ.insertBefore(b.jQ.first())});a.firstChild.prev=c;if(c)c.next=a.firstChild;else d.firstChild=a.firstChild;c=a.lastChild});c.next=b.next;if(b.next)b.next.prev=c;else d.lastChild=c;if(!a.next)if(a.prev)a.next=a.prev.next;else while(!a.next){a.parent=a.parent.next;if(a.parent)a.next=a.parent.firstChild;else{a.next=b.next;a.parent=d;break}}if(a.next)a.insertBefore(a.next);else a.appendTo(d);b.jQ.remove();b.prev&&b.prev.respace();b.next&&b.next.respace()};c.backspace=function(){var a=this;if(!a.deleteSelection())if(a.prev)if(a.prev.isEmpty())a.prev=a.prev.remove().prev;else a.selectLeft();else if(a.parent!==a.root)if(a.parent.parent.isEmpty())return a.insertAfter(a.parent.parent).backspace();else a.unwrapGramp();a.prev&&a.prev.respace();a.next&&a.next.respace();a.redraw();return a};c.deleteForward=function(){var a=this;if(!a.deleteSelection())if(a.next)if(a.next.isEmpty())a.next=a.next.remove().next;else a.selectRight();else if(a.parent!==a.root)if(a.parent.parent.isEmpty())return a.insertBefore(a.parent.parent).deleteForward();else a.unwrapGramp();a.prev&&a.prev.respace();a.next&&a.next.respace();a.redraw();return a};c.selectFrom=function(j){var f=this,d=f,c=j;a:while(n){for(var g=f;g!==d.parent.parent;g=g.parent.parent)if(g.parent===c.parent){b=g;a=c;break a}for(var e=j;e!==c.parent.parent;e=e.parent.parent)if(d.parent===e.parent){b=d;a=e;break a}if(d.parent.parent)d=d.parent.parent;if(c.parent.parent)c=c.parent.parent}var b,a,h;if(b.next!==a){for(var i=b;i;i=i.next)if(i===a.prev){h=n;break}if(!h){h=a;a=b;b=h}}f.hide().selection=new X(b.parent,b.prev,a.next);f.insertAfter(a.next.prev||a.parent.lastChild);f.root.selectionChanged()};c.selectLeft=function(){var a=this;if(a.selection)if(a.selection.prev===a.prev)if(a.prev){a.hopLeft().next.jQ.prependTo(a.selection.jQ);a.selection.prev=a.prev}else a.parent!==a.root&&a.insertBefore(a.parent.parent).selection.levelUp();else{a.prev.jQ.insertAfter(a.selection.jQ);a.hopLeft().selection.next=a.next;if(a.selection.prev===a.prev){a.deleteSelection();return}}else{if(a.prev)a.hopLeft();else if(a.parent!==a.root)a.insertBefore(a.parent.parent);else return;a.hide().selection=new X(a.parent,a.prev,a.next.next)}a.root.selectionChanged()};c.selectRight=function(){var a=this;if(a.selection)if(a.selection.next===a.next)if(a.next){a.hopRight().prev.jQ.appendTo(a.selection.jQ);a.selection.next=a.next}else a.parent!==a.root&&a.insertAfter(a.parent.parent).selection.levelUp();else{a.next.jQ.insertBefore(a.selection.jQ);a.hopRight().selection.prev=a.prev;if(a.selection.next===a.next){a.deleteSelection();return}}else{if(a.next)a.hopRight();else if(a.parent!==a.root)a.insertAfter(a.parent.parent);else return;a.hide().selection=new X(a.parent,a.prev.prev,a.next)}a.root.selectionChanged()};c.clearSelection=function(){var a=this;if(a.show().selection){a.selection.clear();delete a.selection;a.root.selectionChanged()}return a};c.deleteSelection=function(){var a=this;if(!a.show().selection)return i;a.prev=a.selection.prev;a.next=a.selection.next;a.selection.remove();delete a.selection;a.root.selectionChanged();return n};function X(){A.apply(this,arguments)}c=X.prototype=new A;c.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()};c.levelUp=function(){var a=this;a.clear().jQinit(a.parent.parent.jQ);a.prev=a.parent.parent.prev;a.next=a.parent.parent.next;a.parent=a.parent.parent.parent;return a};c.clear=function(){this.jQ.replaceWith(this.jQ.children());return this};c.blockify=function(){var a=this;a.jQ.replaceWith(a.jQ=a.jQ.children());return A.prototype.blockify.call(a)};c.detach=function(){var a=A.prototype.blockify.call(this);this.blockify=function(){this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children());return a};return this};g.fn.mathquill=function(e,a){var b=this;switch(e){case"redraw":b.find(":not(:has(:first))").each(function(){var a=g(this).data(h);a&&(a.cmd||a.block)&&gb.prototype.redraw.call(a.cmd||a.block)});return b;case"revert":return b.each(function(){var a=g(this).data(h);a&&a.revert&&a.revert()});case"latex":if(arguments.length>1)return b.each(function(){var b=g(this).data(h);b&&b.block&&b.block.renderLatex&&b.block.renderLatex(a)});var c=b.data(h);return c&&c.block&&c.block.latex();case"text":var c=b.data(h);return c&&c.block&&c.block.text();case"html":return b.html().replace(/ ?hasCursor|hasCursor /,l).replace(/ class=(""|(?= |>))/g,l).replace(/<span class="?cursor( blink)?"?><\/span>/i,l).replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,l);case"write":if(arguments.length>1)return b.each(function(){var d=g(this).data(h),c=d&&d.block,b=c&&c.cursor;b&&b.writeLatex(a).parent.blur()});case"writefunc":if(arguments.length>1)return b.each(function(){var d=g(this).data(h),c=d&&d.block,b=c&&c.cursor;if(b){if(b.selection)b.writeLatex(a+"\\left("+b.selection.latex()+"\\right)").parent.blur();else b.writeLatex(a+"\\left(\\right)").parent.blur();b.moveLeft()}});case"movecursor":if(arguments.length>1)return b.each(function(){var d=g(this).data(h),c=d&&d.block,b=c&&c.cursor;if(b)if(a=="l")b.moveLeft();else if(a=="r")b.moveRight();else if(a=="u")if(b.parent.prev)b.clearSelection().appendTo(b.parent.prev);else if(b.prev)b.clearSelection().prependTo(b.parent);else b.moveLeft();else if(a=="d")if(b.parent.next)b.clearSelection().prependTo(b.parent.next);else if(b.next)b.clearSelection().appendTo(b.parent);else b.moveRight()});case"writesimpfunc":if(arguments.length>1)return b.each(function(){var d=g(this).data(h),c=d&&d.block,b=c&&c.cursor;if(b){if(b.selection)b.writeLatex(a+C+b.selection.latex()+y).parent.blur();else b.writeLatex(a).parent.blur();b.moveLeft()}});case"cmd":if(arguments.length>1)return b.each(function(){var d=g(this).data(h),c=d&&d.block,b=c&&c.cursor;if(b){b.show();if(/^\\[a-z]+$/i.test(a)){if(b.selection){b.prev=b.selection.prev;b.next=b.selection.next}b.insertCmd(a.slice(1),b.selection);delete b.selection}else b.insertCh(a);b.hide().parent.blur()}});case"writeint":if(arguments.length>1)return b.each(function(){var d=g(this).data(h),c=d&&d.block,b=c&&c.cursor;if(b){var e=i;if(b.selection&&b.selection.latex().match(/,/))e=n;b.show();if(/^\\[a-z]+$/i.test(a)){if(b.selection){b.prev=b.selection.prev;b.next=b.selection.next}b.insertCmd(a.slice(1),b.selection);delete b.selection}else b.insertCh(a);b.hide().parent.blur()}});default:var d=e==="textbox",j=d||e===tb,f=d?vb:V;return b.each(function(){wb(g(this),new f,d,j)})}};g(function(){g(".mathquill-editable:not(.mathquill-rendered-math)").mathquill(tb);g(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox");g(".mathquill-embedded-latex").mathquill()})})();
