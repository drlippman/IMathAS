var MQeditor=function(f){var y={layoutstyle:"auto",layout:[]},g={},r=!1,h=null,l=null,p=null,q=MathQuill.getInterface(MathQuill.getInterface.MAX),b=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"];function i(){try{return window.self!==window.top}catch(t){return!0}}function n(n,t,e){var a,o,s,r,l,i,d,c,m,u,h,p;if("string"==typeof n&&(n=document.getElementById(n)),a="boolean"==typeof t?t:"hidden"!=n.type,o=n.id,!0===a){if(s=f(n).attr("type","hidden").val(),y.hasOwnProperty("toMQ")&&(s=y.toMQ(s,o)),0==(r=f("#mqinput-"+o)).length){if(l=f("<span/>",{id:"mqinput-"+o,class:"mathquill-math-field",text:s}),null!==(i=n.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&l.addClass(i[0]),d=n.hasAttribute("size")?3<n.size?n.size/1.8:n.size:10,l.css("min-width",d+"em"),l.insertAfter(n),c={handlers:{edit:v,enter:C}},y.hasOwnProperty("getLayoutstyle")?y.curlayoutstyle=y.getLayoutstyle():"auto"==y.layoutstyle?y.curlayoutstyle=k():y.curlayoutstyle=y.layoutstyle,"OSK"==y.curlayoutstyle&&(c.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},c.keyboardPassthrough=!0),c.autoOperatorNames=c.autoParenOperators="ln log abs exp sin cos tan arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth arcsinh arccosh arctanh",c.autoCommands="pi theta root sqrt ^oo degree",""!=(m=n.getAttribute("data-mq-vars")||""))for(m=""==m?[]:m.split(/,/),h=0;h<m.length;h++)for(u=m[h].split(/_/),p=0;p<u.length;p++)1<u[p].length&&u[p].match(/^[a-zA-Z]+$/)&&(-1!=b.indexOf(u[p].toLowerCase())?c.autoCommands+=" "+u[p]:c.autoOperatorNames+=" "+u[p]);n.disabled?(r=q.StaticMath(l[0]),l.addClass("disabled")):(r=q.MathField(l[0],c).config(g),w(l),f(n).on("change.mqed",function(t,e){if(!e){var a=n.value;y.hasOwnProperty("toMQ")&&(a=y.toMQ(a,n.id)),r.latex(a)}}))}else r.show(),r=q(r[0]).latex(s);!0!==e&&r.focus()}else f(n).attr("type","text").off("change.mqed"),!0!==e&&f(n).focus(),f("#mqinput-"+o).hide()}function w(t){f(t).find(".mq-textarea > *").on("focus.mqeditor",e).on("blur.mqeditor",function(){l=setTimeout(a,100),y.hasOwnProperty("onBlur")&&y.onBlur()}),f(t).on("click.mqeditor",function(t){var e=f(t.target).closest("label");if(0<e.length)return"undefined"!==e.attr("for")&&f("#"+e.attr("for")).prop("checked",!0),t.stopPropagation(),!1})}function e(t){var a,e,n,o,s;clearTimeout(l),a=f(t.target).closest(".mathquill-math-field"),!1===r&&(f("body").append(f("<div/>",{id:"mqeditor",class:"mqeditor"})),f("#mqeditor").on("mousedown touchstart",function(t){t.preventDefault()}),r=!0),e=y.curlayoutstyle,y.hasOwnProperty("getLayoutstyle")?y.curlayoutstyle=y.getLayoutstyle():"auto"==y.layoutstyle?y.curlayoutstyle=k():y.curlayoutstyle=y.layoutstyle,"OSK"===y.curlayoutstyle?(i()?f("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):f("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),document.getElementById("mqe-fb-spacer")||((n=document.createElement("div")).style.height="200px",n.id="mqe-fb-spacer",f("body").append(n))):f("#mqeditor").removeClass("fixedbottom iframeosk"),o=!1,null!==h&&a[0]==h.el()&&e===y.curlayoutstyle||(o=!0,null!==h&&f("#"+h.el().id.substring(8)).trigger("change",!0),y.hasOwnProperty("getLayout")&&(y.layout=y.getLayout(a[0],y.curlayoutstyle)),f("#mqeditor").empty().show(),y.layout.tabs?function(t,e,a){var n,o,s,r,l,i,d=document.createElement("div");d.className="mqed-row mqed-tabrow";n=document.createElement("div"),r=0;t.appendChild(d),t.appendChild(n);for(l=0;l<e.tabs.length;l++)if(!0===e.tabs[l].enabled)for(r++,O(d,e.tabs[l],a+"-"+l),(s=document.createElement("div")).className="mqed-row mqed-tabpanel",s.id=a+"-"+l+"-tabpanel",n.appendChild(s),i=0;i<e.tabs[l].tabcontent.length;i++)(o=e.tabs[l].tabcontent[i]).hasOwnProperty("flow")&&0==o.contents.length||(o.hasOwnProperty("flow")?u(s,o,a+"-"+l+"-"+i):O(s,o,a+"-"+l+"-"+i));1<r?f(t).find(".mqed-tab").first().addClass("mqed-activetab"):f(d).hide()}(document.getElementById("mqeditor"),y.layout,"mqeditor"):u(document.getElementById("mqeditor"),y.layout,"mqeditor"),f("#mqeditor .mqed-btn.rend").each(function(){q.StaticMath(this,{mouseEvents:!1})}),0<f("#mqeditor .mqed-tabrow").length&&(f("#mqeditor .mqed-tabpanel").hide().first().show(),(s=f("#mqeditor .mqed-tabrow + div")).css("height",s.height()))),"OSK"!==y.curlayoutstyle||i()?f("#mqeditor").show():f("#mqeditor").slideDown(50,function(){var t=f("#mqeditor").height()+5,e=f(window).height()-(a.offset().top+a.outerHeight()-f(window).scrollTop());e<t&&f(window).scrollTop(f(window).scrollTop()+(t-e))}),d(a),h=q.MathField(a[0]),f("#"+a[0].id.substring(8)).triggerHandler("focus"),y.hasOwnProperty("onShow")&&y.onShow(a[0],y.curlayoutstyle,o),f(document).trigger("mqeditor:show")}function a(t){f(document).trigger("mqeditor:hide"),"OSK"!==y.curlayoutstyle||i()?f("#mqeditor").hide():f("#mqeditor").slideUp(50),f("#"+h.el().id.substring(8)).trigger("change",!0),h=null}function d(t){var e,a,n,o,s;"under"==y.curlayoutstyle||i()?(a=(e=f(t).closest(".mathquill-math-field")).offset(),n=e.outerHeight(),o=a.left,document.getElementById("mqeditor")&&o+(s=document.getElementById("mqeditor").offsetWidth)>document.documentElement.clientWidth&&(o=document.documentElement.clientWidth-s-5),i()?f("#mqeditor").css("top",a.top+n+3).css("left",0):f("#mqeditor").css("top",a.top+n+3).css("left",o)):f("#mqeditor").css("top","auto").css("left",0)}function v(t){var e,a=t.el();d(a),y.hasOwnProperty("onResize")&&y.onResize(a,y.curlayoutstyle),a.id.match(/mqinput/)&&(e=t.latex(),y.hasOwnProperty("fromMQ")&&(e=y.fromMQ(e,a.id)),f("#"+a.id.substring(8)).val(e).trigger("input"),""!=e&&f("#"+a.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),y.hasOwnProperty("onEdit")&&y.onEdit(a.id,e))}function C(t){y.hasOwnProperty("onEnter")&&y.onEnter(t.el().id)}function k(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function u(t,e,a){var n,o,s,r,l,i,d=e.flow,c=100;for(e.hasOwnProperty("s")&&"row"==d&&(c=e.s),n=document.createElement("div"),e.hasOwnProperty("s")&&(n.style.flexGrow=e.s),e.hasOwnProperty("class")&&(n.className=e.class),e.hasOwnProperty("tabpanel")&&(n.id=e.tabpanel.id,n.style.display=e.tabpanel.hidden?"none":""),(o=document.createElement("div")).className="mqed-"+d,i=l=s=0;i<e.contents.length;i++)(r=e.contents[i]).hasOwnProperty("flow")&&0==r.contents.length||(c<s+(l=r.hasOwnProperty("s")?r.s:1)&&(n.appendChild(o),s=0,(o=document.createElement("div")).className="mqed-"+d),r.hasOwnProperty("flow")?u(o,r,a+"-"+i):O(o,r,a+"-"+i),s+=l);n.appendChild(o),t.appendChild(n)}function O(t,e,a){var n,o,s,r,l,i,d=document.createElement("div");(d.className="mqed-btn-cont",e.s&&(d.style.flexGrow=e.s),e.contid&&(d.id=e.contid),e.contclass&&f(d).addClass(e.contclass),t.appendChild(d),e.l||e.b||e.p)&&((n=document.createElement("span")).tabIndex=0,e.l?(e.op?(n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+e.l.substring(1)+"</var></span>"):e.pr?(n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-root-block">'+e.pr+"</span>"):e.l.match(/\\left(.)\\right(.)/)?(r=e.l.match(/\\left(.)\\right(.)/),n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+r[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+r[2]+"</span></span>"):(n.className="mqed-btn rend",n.innerText=e.l),o="c",s=e.l.substring(1)):e.b?(e.r?(n.className="mqed-btn rend",n.innerHTML=e.b):(n.className="mqed-btn mq-math-mode",e.v?n.innerHTML='<span class="mq-root-block"><var>'+e.b+"</var></span>":n.innerHTML='<span class="mq-root-block"><span>'+e.b+"</span></span>"),o="t",((s=e.b).match(/^\d$/)||"."==s)&&f(n).addClass("mqed-digitkey")):(n.className="mqed-btn",n.innerHTML=e.p,o="t",s=e.p),e.c&&("shift"==(o=e.c)?f(n).addClass("mqed-shift"):"k"==o&&f(n).addClass("mqed-navkey")),e.sm&&(n.style.fontSize=100-10*e.sm+"%"),e.w&&(s=e.w),e.tabcontent&&(f(n).addClass("mqed-tab"),o="showtabpanel",s=a+"-tabpanel"),f(n).data("cmdtype",o).data("cmdval",s),f(n).on("click mousedown touchstart keydown",(l=o,i=s,function(t){!function t(e,a,n){var o,s,r,l,i,d,c,u;if(("mousedown"!=e.type||"Backspace"===n)&&!("click"==e.type&&"Backspace"===n||"keydown"==e.type&&"Enter"!==e.key))if("touchstart"==e.type&&(e.preventDefault(),f(e.currentTarget).addClass("mactive")),"t"==a)n.match(/^[a-zA-Z]$/)&&f(e.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(n=n.toUpperCase()),h.typedText(n);else if("c"==a)h.cmd(n);else if("l"==a)h.latex(n);else if("w"==a){if(h.write(n),m=n.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(o=m[1].split(/&/).length,s=0;s<o;s++)h.keystroke("Left")}else"k"==a?(h.keystroke(n),"Backspace"===n&&(p=setTimeout(function(){t(e,a,n)},null===p?600:70))):"m"==a?h.matrixCmd(n):"f"==a?(r=h.getSelection())?(h.write(n+"\\left("+r+"\\right)"),h.keystroke("Left")):n.match(/{}$/)?h.typedText(n.replace(/{}$/,"")):h.write(n):"sf"==a?((r=h.getSelection())?h.write(n+"{"+r+"}"):h.cmd(n),h.keystroke("Left")):"i"==a?((r=h.getSelection())||(r=""),"string"==typeof n?(l=n.charAt(0),i=n.charAt(1),h.write("\\left"+l+r+"\\right"+i)):h.write(n[0]+r+n[1]),""==r&&h.keystroke("Left")):"showtabpanel"==a?((d=f(e.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),d.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),f("#"+n).show(),d.addClass("mqed-activetab"),y.hasOwnProperty("onTab")&&y.onTab(d[0],y.curlayoutstyle,n)):"shift"==a&&(d=f(e.target).closest(".mqed-btn"),c=f(e.target).closest(".mqed-tabpanel"),(u=!d.hasClass("active"))?d.addClass("active"):d.removeClass("active"),c.find(".mqed-btn").each(function(t,e){var a=e.textContent;a.match(/^[a-zA-Z]$/)&&(e.textContent=u?e.textContent.toUpperCase():e.textContent.toLowerCase())}))}(t,l,i)})).on("touchend",function(t){setTimeout(function(){f(t.currentTarget).removeClass("mactive")},50)}).on("touchend mouseup",function(){clearTimeout(p),p=null}),d.appendChild(n))}return{setConfig:function(t){for(var e in t)y[e]=t[e]},setMQconfig:function(t){g=t},toggleMQ:n,toggleMQAll:function(t,e){var a=e||null;f(t).each(function(t,e){n(e,a,!0)})},attachEditor:w,getLayoutstyle:k,resetEditor:function(){clearTimeout(l),f("#mqeditor").hide(),h=null}}}(jQuery);
