var MQeditor=function(h){var p,f,u,y,g,q,b,w;function v(){try{return window.self!==window.top}catch(t){return 1}}function s(a,t,e){var s,o,n,r,l,i,c,d,m,u;if("string"==typeof a&&(a=document.getElementById(a)),t="boolean"==typeof t?t:"hidden"!=a.type,s=a.id,o=a.getAttribute("data-mq")||"",!0===t){if(t=h(a).attr("type","hidden").val(),p.hasOwnProperty("toMQ")&&(t=p.toMQ(t,s)),0==(n=h("#mqinput-"+s)).length){if(r=h("<span/>",{id:"mqinput-"+s,class:"mathquill-math-field",text:t,"aria-label":a.getAttribute("aria-label")}),null!==(l=a.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&r.addClass(l[0]),o.match(/chem/)&&r.addClass("mq-chem"),l=a.hasAttribute("size")?3<a.size?a.size/1.8:a.size:10,r.css("min-width",l+"em"),r.insertAfter(a),i={handlers:{edit:O,enter:x}},p.hasOwnProperty("getLayoutstyle")?p.curlayoutstyle=p.getLayoutstyle():"auto"==p.layoutstyle?p.curlayoutstyle=E():p.curlayoutstyle=p.layoutstyle,"OSK"==p.curlayoutstyle&&(i.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},i.keyboardPassthrough=!0),o.match(/chem/)&&(i.charsThatBreakOutOfSupSubVar="",i.charsThatBreakOutOfSupSubOp="",i.autoSubscriptNumerals=!0),o.match(/list/)&&(i.charsThatBreakOutOfSupSub="=<>,"),o.match(/allowplusminus/)&&(i.quickplusminus=!0),i.autoOperatorNames=i.autoParenOperators="ln log abs exp sin cos tan arcsinh arccosh arctanh arcsech arccsch arccoth argsinh argcosh argtanh argsech argcsch argcoth arsinh arcosh artanh arsech arcsch arcoth arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth",i.autoCommands="pi theta root sqrt ^oo degree",o.match(/logic/)&&(i.autoCommands+=" neg xor or and implies iff"),o.match(/setexp/)&&(i.autoCommands+=" nn xor uu ominus cap cup oplus"),""!=(c=a.getAttribute("data-mq-vars")||""))for(c=""==c?[]:c.split(/,/),m=0;m<c.length;m++)for(d=c[m].split(/_/),u=0;u<d.length;u++)1<d[u].length&&d[u].match(/^[a-zA-Z]+$/)&&(-1!=w.indexOf(d[u].toLowerCase())?i.autoCommands+=" "+d[u]:i.autoOperatorNames+=" "+d[u]);a.disabled?(n=b.StaticMath(r[0]),r.addClass("disabled")):(n=b.MathField(r[0],i).config(f),C(r),h(a).on("change.mqed",function(t,e){e||(e=a.value,p.hasOwnProperty("toMQ")&&(e=p.toMQ(e,a.id)),n.latex(e))}))}else n.show(),n=b(n[0]).latex(t);!0!==e&&n.focus()}else h(a).attr("type","text").off("change.mqed"),!0!==e&&h(a).focus(),h("#mqinput-"+s).hide()}function C(t){h(t).find(".mq-textarea > *").on("focus.mqeditor",e).on("blur.mqeditor",function(){g=setTimeout(a,100),p.hasOwnProperty("onBlur")&&p.onBlur()}),h(t).on("click.mqeditor",function(t){var e=h(t.target).closest("label");if(0<e.length)return"undefined"!==e.attr("for")&&h("#"+e.attr("for")).prop("checked",!0),t.stopPropagation(),!1})}function e(t){var a,e;if(clearTimeout(g),a=h(t.target).closest(".mathquill-math-field"),!1===u&&(h("body").append(h("<div/>",{id:"mqeditor",class:"mqeditor"})),h("#mqeditor").on("mousedown touchstart",function(t){t.preventDefault()}),u=!0),t=p.curlayoutstyle,p.hasOwnProperty("getLayoutstyle")?p.curlayoutstyle=p.getLayoutstyle():"auto"==p.layoutstyle?p.curlayoutstyle=E():p.curlayoutstyle=p.layoutstyle,"OSK"===p.curlayoutstyle?(v()?h("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):h("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),document.getElementById("mqe-fb-spacer")||((e=document.createElement("div")).style.height="200px",e.id="mqe-fb-spacer",h("body").append(e))):h("#mqeditor").removeClass("fixedbottom iframeosk"),h("#mqeditor").toggleClass("mq-chem",h(a).hasClass("mq-chem")),e=!1,null===y||a[0]!=y.el()||t!==p.curlayoutstyle){if(e=!0,null!==y&&h("#"+y.el().id.substring(8)).trigger("change",!0),p.hasOwnProperty("getLayout")&&(p.layout=p.getLayout(a[0],p.curlayoutstyle)),h("#mqeditor").empty().show(),p.layout.tabs){var s,o,n,r,l,i,t=document.getElementById("mqeditor"),c=p.layout,d="mqeditor";for((s=document.createElement("div")).className="mqed-row mqed-tabrow",o=document.createElement("div"),0,t.appendChild(s),t.appendChild(o),l=0;l<c.tabs.length;l++)if(!0===c.tabs[l].enabled)for(P(s,c.tabs[l],d+"-"+l),(r=document.createElement("div")).className="mqed-row mqed-tabpanel",r.id=d+"-"+l+"-tabpanel",o.appendChild(r),i=0;i<c.tabs[l].tabcontent.length;i++)(n=c.tabs[l].tabcontent[i]).hasOwnProperty("flow")&&0==n.contents.length||(n.hasOwnProperty("flow")?T:P)(r,n,d+"-"+l+"-"+i);P(s,{s:1}),P(s,{p:"&times;",c:"close",lb:"close"}),h(t).find(".mqed-tab").first().addClass("mqed-activetab")}else T(document.getElementById("mqeditor"),p.layout,"mqeditor");h("#mqeditor .mqed-btn.rend").each(function(){b.StaticMath(this,{mouseEvents:!1})}),0<h("#mqeditor .mqed-tabrow").length&&(h("#mqeditor .mqed-tabpanel").hide().first().show(),(t=h("#mqeditor .mqed-tabrow + div")).css("height",t.height()))}"OSK"!==p.curlayoutstyle||v()?h("#mqeditor").show():h("#mqeditor").slideDown(50,function(){var t=h("#mqeditor").height()+5,e=h(window).height()-(a.offset().top+a.outerHeight()-h(window).scrollTop());e<t&&h(window).scrollTop(h(window).scrollTop()+(t-e))}),k(a),y=b.MathField(a[0]),h("#"+a[0].id.substring(8)).triggerHandler("focus"),p.hasOwnProperty("onShow")&&p.onShow(a[0],p.curlayoutstyle,e),h(document).trigger("mqeditor:show")}function a(t){y&&(h(document).trigger("mqeditor:hide"),"OSK"!==p.curlayoutstyle||v()?h("#mqeditor").hide():h("#mqeditor").slideUp(50),h("#"+y.el().id.substring(8)).trigger("change",!0),y=null)}function k(t){var e,a,s;"under"==p.curlayoutstyle||v()?(e=(t=h(t).closest(".mathquill-math-field")).offset(),t=t.outerHeight(),a=e.left,document.getElementById("mqeditor")&&a+(s=document.getElementById("mqeditor").offsetWidth)>document.documentElement.clientWidth&&(a=document.documentElement.clientWidth-s-5),v()?h("#mqeditor").css("top",e.top+t+3).css("left",0):h("#mqeditor").css("top",e.top+t+3).css("left",a)):h("#mqeditor").css("top","auto").css("left",0)}function O(t){var e=t.el();k(e),p.hasOwnProperty("onResize")&&p.onResize(e,p.curlayoutstyle),e.id.match(/mqinput/)&&(t=t.latex(),p.hasOwnProperty("fromMQ")&&(t=p.fromMQ(t,e.id)),h("#"+e.id.substring(8)).val(t).trigger("input"),""!=t&&h("#"+e.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),p.hasOwnProperty("onEdit"))&&p.onEdit(e.id,t)}function x(t){p.hasOwnProperty("onEnter")&&p.onEnter(t.el().id)}function E(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function T(t,e,a){var s,o,n,r,l,i,c=e.flow,d=100;for(e.hasOwnProperty("s")&&"row"==c&&(d=e.s),s=document.createElement("div"),e.hasOwnProperty("s")&&(s.style.flexGrow=e.s),e.hasOwnProperty("class")&&(s.className=e.class),e.hasOwnProperty("tabpanel")&&(s.id=e.tabpanel.id,s.style.display=e.tabpanel.hidden?"none":""),(o=document.createElement("div")).className="mqed-"+c,i=l=n=0;i<e.contents.length;i++)(r=e.contents[i]).hasOwnProperty("flow")&&0==r.contents.length||(d<n+(l=r.hasOwnProperty("s")?r.s:1)&&(s.appendChild(o),n=0,(o=document.createElement("div")).className="mqed-"+c),(r.hasOwnProperty("flow")?T:P)(o,r,a+"-"+i),n+=l);s.appendChild(o),t.appendChild(s)}function P(t,e,a){var s,o,n,r,l=document.createElement("div");l.className="mqed-btn-cont",e.s&&(l.style.flexGrow=e.s),e.contid&&(l.id=e.contid),e.contclass&&h(l).addClass(e.contclass),t.appendChild(l),(e.l||e.b||e.p)&&((t=document.createElement("span")).tabIndex=0,e.l?(e.op?(t.className="mqed-btn mq-math-mode",t.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+e.l.substring(1)+"</var></span>"):e.pr?(t.className="mqed-btn mq-math-mode",t.innerHTML='<span class="mq-root-block">'+e.pr+"</span>"):e.l.match(/\\left(.)\\right(.)/)?(o=e.l.match(/\\left(.)\\right(.)/),t.className="mqed-btn mq-math-mode",t.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+o[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+o[2]+"</span></span>"):(t.className="mqed-btn rend",t.innerText=e.l),o="c",s=e.l.substring(1)):e.b?(e.r?(t.className="mqed-btn rend",t.innerHTML=e.b):(t.className="mqed-btn mq-math-mode",e.v?t.innerHTML='<span class="mq-root-block"><var>'+e.b+"</var></span>":t.innerHTML='<span class="mq-root-block"><span>'+e.b+"</span></span>"),o="t",!(s=e.b).match(/^\d$/)&&"."!=s||h(t).addClass("mqed-digitkey")):(t.className="mqed-btn",t.innerHTML=e.p,o="t",s=e.p),e.c&&("shift"==(o=e.c)?h(t).addClass("mqed-shift"):"k"==o?h(t).addClass("mqed-navkey"):"close"==o&&h(t).addClass("mqed-closebtn")),e.lb&&t.setAttribute("aria-label",e.lb),e.sm&&(t.style.fontSize=100-10*e.sm+"%"),e.w&&(s=e.w),e.tabcontent&&(h(t).addClass("mqed-tab"),o="showtabpanel",s=a+"-tabpanel"),h(t).data("cmdtype",o).data("cmdval",s),h(t).on("click mousedown touchstart keydown",(n=o,r=s,function(t){!function t(e,a,s){var o,n,r,l,i,c,d;{if("mousedown"==e.type&&"Backspace"!==s)return;if("click"==e.type&&"Backspace"===s)return}if("keydown"==e.type&&"Enter"!==e.key)return;"touchstart"==e.type&&(e.preventDefault(),h(e.currentTarget).addClass("mactive"));if("t"==a)s.match(/^[a-zA-Z]$/)&&h(e.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(s=s.toUpperCase()),y.typedText(s);else if("c"==a)y.cmd(s);else if("l"==a)y.latex(s);else if("w"==a){if(y.write(s),m=s.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(o=m[1].split(/&/).length,n=0;n<o;n++)y.keystroke("Left")}else"k"==a?(y.keystroke(s),"Backspace"===s&&(q=setTimeout(function(){t(e,a,s)},null===q?600:70))):"m"==a?y.matrixCmd(s):"f"==a?(r=y.getSelection())?(y.write(s+"\\left("+r+"\\right)"),y.keystroke("Left")):s.match(/{}$/)?y.typedText(s.replace(/{}$/,"")):y.write(s):"sf"==a?((r=y.getSelection())?y.write(s+"{"+r+"}"):y.cmd(s),y.keystroke("Left")):"i"==a?(r=(r=y.getSelection())||"","string"==typeof s?(c=s.charAt(0),l=s.charAt(1),y.write("\\left"+c+r+"\\right"+l)):y.write(s[0]+r+s[1]),""==r&&y.keystroke("Left")):"showtabpanel"==a?((i=h(e.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),i.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),h("#"+s).show(),i.addClass("mqed-activetab"),p.hasOwnProperty("onTab")&&p.onTab(i[0],p.curlayoutstyle,s)):"shift"==a?(i=h(e.target).closest(".mqed-btn"),c=h(e.target).closest(".mqed-tabpanel"),d=!i.hasClass("active"),d?i.addClass("active"):i.removeClass("active"),c.find(".mqed-btn").each(function(t,e){var a=e.textContent;a.match(/^[a-zA-Z]$/)&&(e.textContent=d?e.textContent.toUpperCase():e.textContent.toLowerCase())})):"close"==a&&y.blur()}(t,n,r)})).on("touchend",function(t){setTimeout(function(){h(t.currentTarget).removeClass("mactive")},50)}).on("touchend mouseup",function(){clearTimeout(q),q=null}),l.appendChild(t))}return p={layoutstyle:"auto",layout:[]},u=!(f={}),q=g=y=null,b=MathQuill.getInterface(MathQuill.getInterface.MAX),w=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"],{setConfig:function(t){for(var e in t)p[e]=t[e]},setMQconfig:function(t){f=t},toggleMQ:s,toggleMQAll:function(t,e){var a=e||null;h(t).each(function(t,e){s(e,a,!0)})},attachEditor:C,getLayoutstyle:E,resetEditor:function(){clearTimeout(g),h("#mqeditor").hide(),y=null}}}(jQuery);
