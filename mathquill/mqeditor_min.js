var MQeditor=function(u){var h={layoutstyle:"auto",layout:[]},p={},f=!1,y=null,g=null,b=null,q=MathQuill.getInterface(MathQuill.getInterface.MAX),w=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"];function v(){try{return window.self!==window.top}catch(t){return 1}}function n(a,t,e){var n,o,s,r,l,i,d,c,m;if("string"==typeof a&&(a=document.getElementById(a)),t="boolean"==typeof t?t:"hidden"!=a.type,n=a.id,!0===t){if(t=u(a).attr("type","hidden").val(),h.hasOwnProperty("toMQ")&&(t=h.toMQ(t,n)),0==(o=u("#mqinput-"+n)).length){if(s=u("<span/>",{id:"mqinput-"+n,class:"mathquill-math-field",text:t,"aria-label":a.getAttribute("aria-label")}),null!==(l=a.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&s.addClass(l[0]),l=a.hasAttribute("size")?3<a.size?a.size/1.8:a.size:10,s.css("min-width",l+"em"),s.insertAfter(a),r={handlers:{edit:k,enter:x}},h.hasOwnProperty("getLayoutstyle")?h.curlayoutstyle=h.getLayoutstyle():"auto"==h.layoutstyle?h.curlayoutstyle=E():h.curlayoutstyle=h.layoutstyle,"OSK"==h.curlayoutstyle&&(r.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},r.keyboardPassthrough=!0),(l=a.getAttribute("data-mq")||"").match(/chem/)&&(r.charsThatBreakOutOfSupSubVar="",r.charsThatBreakOutOfSupSubOp=""),l.match(/list/)&&(r.charsThatBreakOutOfSupSub="=<>,"),r.autoOperatorNames=r.autoParenOperators="ln log abs exp sin cos tan arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth arcsinh arccosh arctanh",l.match(/logic/)?r.autoCommands+=" theta not neg xor or and iff implies":l.match(/sexp/)?r.autoCommands+=" pi theta xor cap cup":r.autoCommands="pi theta root sqrt ^oo degree",""!=(i=a.getAttribute("data-mq-vars")||""))for(i=""==i?[]:i.split(/,/),c=0;c<i.length;c++)for(d=i[c].split(/_/),m=0;m<d.length;m++)1<d[m].length&&d[m].match(/^[a-zA-Z]+$/)&&(-1!=w.indexOf(d[m].toLowerCase())?r.autoCommands+=" "+d[m]:r.autoOperatorNames+=" "+d[m]);a.disabled?(o=q.StaticMath(s[0]),s.addClass("disabled")):(o=q.MathField(s[0],r).config(p),C(s),u(a).on("change.mqed",function(t,e){e||(e=a.value,h.hasOwnProperty("toMQ")&&(e=h.toMQ(e,a.id)),o.latex(e))}))}else o.show(),o=q(o[0]).latex(t);!0!==e&&o.focus()}else u(a).attr("type","text").off("change.mqed"),!0!==e&&u(a).focus(),u("#mqinput-"+n).hide()}function C(t){u(t).find(".mq-textarea > *").on("focus.mqeditor",e).on("blur.mqeditor",function(){g=setTimeout(a,100),h.hasOwnProperty("onBlur")&&h.onBlur()}),u(t).on("click.mqeditor",function(t){var e=u(t.target).closest("label");if(0<e.length)return"undefined"!==e.attr("for")&&u("#"+e.attr("for")).prop("checked",!0),t.stopPropagation(),!1})}function e(t){var a,e;if(clearTimeout(g),a=u(t.target).closest(".mathquill-math-field"),!1===f&&(u("body").append(u("<div/>",{id:"mqeditor",class:"mqeditor"})),u("#mqeditor").on("mousedown touchstart",function(t){t.preventDefault()}),f=!0),t=h.curlayoutstyle,h.hasOwnProperty("getLayoutstyle")?h.curlayoutstyle=h.getLayoutstyle():"auto"==h.layoutstyle?h.curlayoutstyle=E():h.curlayoutstyle=h.layoutstyle,"OSK"===h.curlayoutstyle?(v()?u("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):u("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),document.getElementById("mqe-fb-spacer")||((e=document.createElement("div")).style.height="200px",e.id="mqe-fb-spacer",u("body").append(e))):u("#mqeditor").removeClass("fixedbottom iframeosk"),e=!1,null===y||a[0]!=y.el()||t!==h.curlayoutstyle){if(e=!0,null!==y&&u("#"+y.el().id.substring(8)).trigger("change",!0),h.hasOwnProperty("getLayout")&&(h.layout=h.getLayout(a[0],h.curlayoutstyle)),u("#mqeditor").empty().show(),h.layout.tabs){var n,o,s,r,t=document.getElementById("mqeditor"),l=h.layout,i="mqeditor",d=document.createElement("div"),c=(d.className="mqed-row mqed-tabrow",document.createElement("div"));for(t.appendChild(d),t.appendChild(c),s=0;s<l.tabs.length;s++)if(!0===l.tabs[s].enabled)for(P(d,l.tabs[s],i+"-"+s),(o=document.createElement("div")).className="mqed-row mqed-tabpanel",o.id=i+"-"+s+"-tabpanel",c.appendChild(o),r=0;r<l.tabs[s].tabcontent.length;r++)(n=l.tabs[s].tabcontent[r]).hasOwnProperty("flow")&&0==n.contents.length||(n.hasOwnProperty("flow")?T:P)(o,n,i+"-"+s+"-"+r);P(d,{s:1}),P(d,{p:"&times;",c:"close",lb:"close"}),u(t).find(".mqed-tab").first().addClass("mqed-activetab")}else T(document.getElementById("mqeditor"),h.layout,"mqeditor");u("#mqeditor .mqed-btn.rend").each(function(){q.StaticMath(this,{mouseEvents:!1})}),0<u("#mqeditor .mqed-tabrow").length&&(u("#mqeditor .mqed-tabpanel").hide().first().show(),(t=u("#mqeditor .mqed-tabrow + div")).css("height",t.height()))}"OSK"!==h.curlayoutstyle||v()?u("#mqeditor").show():u("#mqeditor").slideDown(50,function(){var t=u("#mqeditor").height()+5,e=u(window).height()-(a.offset().top+a.outerHeight()-u(window).scrollTop());e<t&&u(window).scrollTop(u(window).scrollTop()+(t-e))}),O(a),y=q.MathField(a[0]),u("#"+a[0].id.substring(8)).triggerHandler("focus"),h.hasOwnProperty("onShow")&&h.onShow(a[0],h.curlayoutstyle,e),u(document).trigger("mqeditor:show")}function a(t){y&&(u(document).trigger("mqeditor:hide"),"OSK"!==h.curlayoutstyle||v()?u("#mqeditor").hide():u("#mqeditor").slideUp(50),u("#"+y.el().id.substring(8)).trigger("change",!0),y=null)}function O(t){var e,a,n;"under"==h.curlayoutstyle||v()?(e=(t=u(t).closest(".mathquill-math-field")).offset(),t=t.outerHeight(),a=e.left,document.getElementById("mqeditor")&&a+(n=document.getElementById("mqeditor").offsetWidth)>document.documentElement.clientWidth&&(a=document.documentElement.clientWidth-n-5),v()?u("#mqeditor").css("top",e.top+t+3).css("left",0):u("#mqeditor").css("top",e.top+t+3).css("left",a)):u("#mqeditor").css("top","auto").css("left",0)}function k(t){var e=t.el();O(e),h.hasOwnProperty("onResize")&&h.onResize(e,h.curlayoutstyle),e.id.match(/mqinput/)&&(t=t.latex(),h.hasOwnProperty("fromMQ")&&(t=h.fromMQ(t,e.id)),u("#"+e.id.substring(8)).val(t).trigger("input"),""!=t&&u("#"+e.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),h.hasOwnProperty("onEdit")&&h.onEdit(e.id,t))}function x(t){h.hasOwnProperty("onEnter")&&h.onEnter(t.el().id)}function E(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function T(t,e,a){var n,o,s,r,l,i,d=e.flow,c=100;for(e.hasOwnProperty("s")&&"row"==d&&(c=e.s),n=document.createElement("div"),e.hasOwnProperty("s")&&(n.style.flexGrow=e.s),e.hasOwnProperty("class")&&(n.className=e.class),e.hasOwnProperty("tabpanel")&&(n.id=e.tabpanel.id,n.style.display=e.tabpanel.hidden?"none":""),(o=document.createElement("div")).className="mqed-"+d,i=l=s=0;i<e.contents.length;i++)(r=e.contents[i]).hasOwnProperty("flow")&&0==r.contents.length||(c<s+(l=r.hasOwnProperty("s")?r.s:1)&&(n.appendChild(o),s=0,(o=document.createElement("div")).className="mqed-"+d),(r.hasOwnProperty("flow")?T:P)(o,r,a+"-"+i),s+=l);n.appendChild(o),t.appendChild(n)}function P(t,e,a){var n,o,s,r,l=document.createElement("div");l.className="mqed-btn-cont",e.s&&(l.style.flexGrow=e.s),e.contid&&(l.id=e.contid),e.contclass&&u(l).addClass(e.contclass),t.appendChild(l),(e.l||e.b||e.p)&&((t=document.createElement("span")).tabIndex=0,e.l?(e.op?(t.className="mqed-btn mq-math-mode",t.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+e.l.substring(1)+"</var></span>"):e.pr?(t.className="mqed-btn mq-math-mode",t.innerHTML='<span class="mq-root-block">'+e.pr+"</span>"):e.l.match(/\\left(.)\\right(.)/)?(o=e.l.match(/\\left(.)\\right(.)/),t.className="mqed-btn mq-math-mode",t.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+o[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+o[2]+"</span></span>"):(t.className="mqed-btn rend",t.innerText=e.l),o="c",n=e.l.substring(1)):e.b?(e.r?(t.className="mqed-btn rend",t.innerHTML=e.b):(t.className="mqed-btn mq-math-mode",e.v?t.innerHTML='<span class="mq-root-block"><var>'+e.b+"</var></span>":t.innerHTML='<span class="mq-root-block"><span>'+e.b+"</span></span>"),o="t",!(n=e.b).match(/^\d$/)&&"."!=n||u(t).addClass("mqed-digitkey")):(t.className="mqed-btn",t.innerHTML=e.p,o="t",n=e.p),e.c&&("shift"==(o=e.c)?u(t).addClass("mqed-shift"):"k"==o?u(t).addClass("mqed-navkey"):"close"==o&&u(t).addClass("mqed-closebtn")),e.lb&&t.setAttribute("aria-label",e.lb),e.sm&&(t.style.fontSize=100-10*e.sm+"%"),e.w&&(n=e.w),e.tabcontent&&(u(t).addClass("mqed-tab"),o="showtabpanel",n=a+"-tabpanel"),u(t).data("cmdtype",o).data("cmdval",n),u(t).on("click mousedown touchstart keydown",(s=o,r=n,function(t){!function t(e,a,n){var o,s,r,l,i,d,c;{if("mousedown"==e.type&&"Backspace"!==n)return;if("click"==e.type&&"Backspace"===n)return}if("keydown"==e.type&&"Enter"!==e.key)return;"touchstart"==e.type&&(e.preventDefault(),u(e.currentTarget).addClass("mactive"));if("t"==a)n.match(/^[a-zA-Z]$/)&&u(e.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(n=n.toUpperCase()),y.typedText(n);else if("c"==a)y.cmd(n);else if("l"==a)y.latex(n);else if("w"==a){if(y.write(n),m=n.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(o=m[1].split(/&/).length,s=0;s<o;s++)y.keystroke("Left")}else"k"==a?(y.keystroke(n),"Backspace"===n&&(b=setTimeout(function(){t(e,a,n)},null===b?600:70))):"m"==a?y.matrixCmd(n):"f"==a?(r=y.getSelection())?(y.write(n+"\\left("+r+"\\right)"),y.keystroke("Left")):n.match(/{}$/)?y.typedText(n.replace(/{}$/,"")):y.write(n):"sf"==a?((r=y.getSelection())?y.write(n+"{"+r+"}"):y.cmd(n),y.keystroke("Left")):"i"==a?(r=(r=y.getSelection())||"","string"==typeof n?(d=n.charAt(0),l=n.charAt(1),y.write("\\left"+d+r+"\\right"+l)):y.write(n[0]+r+n[1]),""==r&&y.keystroke("Left")):"showtabpanel"==a?((i=u(e.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),i.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),u("#"+n).show(),i.addClass("mqed-activetab"),h.hasOwnProperty("onTab")&&h.onTab(i[0],h.curlayoutstyle,n)):"shift"==a?(i=u(e.target).closest(".mqed-btn"),d=u(e.target).closest(".mqed-tabpanel"),c=!i.hasClass("active"),c?i.addClass("active"):i.removeClass("active"),d.find(".mqed-btn").each(function(t,e){var a=e.textContent;a.match(/^[a-zA-Z]$/)&&(e.textContent=c?e.textContent.toUpperCase():e.textContent.toLowerCase())})):"close"==a&&y.blur()}(t,s,r)})).on("touchend",function(t){setTimeout(function(){u(t.currentTarget).removeClass("mactive")},50)}).on("touchend mouseup",function(){clearTimeout(b),b=null}),l.appendChild(t))}return{setConfig:function(t){for(var e in t)h[e]=t[e]},setMQconfig:function(t){p=t},toggleMQ:n,toggleMQAll:function(t,e){var a=e||null;u(t).each(function(t,e){n(e,a,!0)})},attachEditor:C,getLayoutstyle:E,resetEditor:function(){clearTimeout(g),u("#mqeditor").hide(),y=null}}}(jQuery);