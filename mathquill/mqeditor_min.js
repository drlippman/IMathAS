var MQeditor=function(h){var y={layoutstyle:"auto",layout:[]},f={},r=!1,p=null,i=null,g=null,q=MathQuill.getInterface(MathQuill.getInterface.MAX);function l(){try{return window.self!==window.top}catch(t){return!0}}function o(o,t,e){var a,n,s,r,i,l,d,c,u,m;if("string"==typeof o&&(o=document.getElementById(o)),a="boolean"==typeof t?t:"hidden"!=o.type,n=o.id,!0===a){if(s=h(o).attr("type","hidden").val(),y.hasOwnProperty("toMQ")&&(s=y.toMQ(s,n)),0==(r=h("#mqinput-"+n)).length){if(i=h("<span/>",{id:"mqinput-"+n,class:"mathquill-math-field",text:s}),null!==(l=o.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&i.addClass(l[0]),d=o.hasAttribute("size")?3<o.size?o.size/1.8:o.size:10,i.css("min-width",d+"em"),i.insertAfter(o),c={handlers:{edit:w,enter:v}},y.hasOwnProperty("getLayoutstyle")?y.curlayoutstyle=y.getLayoutstyle():"auto"==y.layoutstyle?y.curlayoutstyle=C():y.curlayoutstyle=y.layoutstyle,"OSK"==y.curlayoutstyle&&(c.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},c.keyboardPassthrough=!0),c.autoOperatorNames=c.autoParenOperators="ln log abs exp sin cos tan arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth arcsinh arccosh arctanh",""!=(u=o.getAttribute("data-mq-vars")||""))for(u=""==u?[]:u.split(/,/),m=0;m<u.length;m++)1<u[m].length&&u[m].match(/^[a-zA-Z]+$/)&&(c.autoOperatorNames+=" "+u[m]);o.disabled?(r=q.StaticMath(i[0]),i.addClass("disabled")):(r=q.MathField(i[0],c).config(f),b(i),h(o).on("change.mqed",function(t,e){if(!e){var a=o.value;y.hasOwnProperty("toMQ")&&(a=y.toMQ(a)),r.latex(a)}}))}else r.show(),r=q(r[0]).latex(s);!0!==e&&r.focus()}else h(o).attr("type","text").off("change.mqed"),!0!==e&&h(o).focus(),h("#mqinput-"+n).hide()}function b(t){h(t).find(".mq-textarea > *").on("focus.mqeditor",e).on("blur.mqeditor",function(){i=setTimeout(a,100),y.hasOwnProperty("onBlur")&&y.onBlur()}),h(t).on("click.mqeditor",function(t){var e=h(t.target).closest("label");if(0<e.length)return"undefined"!==e.attr("for")&&h("#"+e.attr("for")).prop("checked",!0),t.stopPropagation(),!1})}function e(t){var a,e,o,n,s;clearTimeout(i),a=h(t.target).closest(".mathquill-math-field"),!1===r&&(h("body").append(h("<div/>",{id:"mqeditor",class:"mqeditor"})),h("#mqeditor").on("mousedown touchstart",function(t){t.preventDefault()}),r=!0),e=y.curlayoutstyle,y.hasOwnProperty("getLayoutstyle")?y.curlayoutstyle=y.getLayoutstyle():"auto"==y.layoutstyle?y.curlayoutstyle=C():y.curlayoutstyle=y.layoutstyle,"OSK"===y.curlayoutstyle?(l()?h("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):h("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),document.getElementById("mqe-fb-spacer")||((o=document.createElement("div")).style.height="200px",o.id="mqe-fb-spacer",h("body").append(o))):h("#mqeditor").removeClass("fixedbottom iframeosk"),n=!1,null!==p&&a[0]==p.el()&&e===y.curlayoutstyle||(n=!0,null!==p&&h("#"+p.el().id.substring(8)).trigger("change",!0),y.hasOwnProperty("getLayout")&&(y.layout=y.getLayout(a[0],y.curlayoutstyle)),h("#mqeditor").empty().show(),y.layout.tabs?function(t,e,a){var o,n,s,r,i,l,d=document.createElement("div");d.className="mqed-row mqed-tabrow";o=document.createElement("div"),r=0;t.appendChild(d),t.appendChild(o);for(i=0;i<e.tabs.length;i++)if(!0===e.tabs[i].enabled)for(r++,k(d,e.tabs[i],a+"-"+i),(s=document.createElement("div")).className="mqed-row mqed-tabpanel",s.id=a+"-"+i+"-tabpanel",o.appendChild(s),l=0;l<e.tabs[i].tabcontent.length;l++)(n=e.tabs[i].tabcontent[l]).hasOwnProperty("flow")&&0==n.contents.length||(n.hasOwnProperty("flow")?u(s,n,a+"-"+i+"-"+l):k(s,n,a+"-"+i+"-"+l));1<r?h(t).find(".mqed-tab").first().addClass("mqed-activetab"):h(d).hide()}(document.getElementById("mqeditor"),y.layout,"mqeditor"):u(document.getElementById("mqeditor"),y.layout,"mqeditor"),h("#mqeditor .mqed-btn.rend").each(function(){q.StaticMath(this,{mouseEvents:!1})}),0<h("#mqeditor .mqed-tabrow").length&&(h("#mqeditor .mqed-tabpanel").hide().first().show(),(s=h("#mqeditor .mqed-tabrow + div")).css("height",s.height()))),"OSK"!==y.curlayoutstyle||l()?h("#mqeditor").show():h("#mqeditor").slideDown(50,function(){var t=h("#mqeditor").height()+5,e=h(window).height()-(a.offset().top+a.outerHeight()-h(window).scrollTop());e<t&&h(window).scrollTop(h(window).scrollTop()+(t-e))}),d(a),p=q.MathField(a[0]),h("#"+a[0].id.substring(8)).triggerHandler("focus"),y.hasOwnProperty("onShow")&&y.onShow(a[0],y.curlayoutstyle,n),h(document).trigger("mqeditor:show")}function a(t){h(document).trigger("mqeditor:hide"),"OSK"!==y.curlayoutstyle||l()?h("#mqeditor").hide():h("#mqeditor").slideUp(50),h("#"+p.el().id.substring(8)).trigger("change",!0),p=null}function d(t){var e,a,o,n,s;"under"==y.curlayoutstyle||l()?(a=(e=h(t).closest(".mathquill-math-field")).offset(),o=e.outerHeight(),n=a.left,document.getElementById("mqeditor")&&n+(s=document.getElementById("mqeditor").offsetWidth)>document.documentElement.clientWidth&&(n=document.documentElement.clientWidth-s-5),l()?h("#mqeditor").css("top",a.top+o+3).css("left",0):h("#mqeditor").css("top",a.top+o+3).css("left",n)):h("#mqeditor").css("top","auto").css("left",0)}function w(t){var e,a=t.el();d(a),y.hasOwnProperty("onResize")&&y.onResize(a,y.curlayoutstyle),a.id.match(/mqinput/)&&(e=t.latex(),y.hasOwnProperty("fromMQ")&&(e=y.fromMQ(e,a.id)),h("#"+a.id.substring(8)).val(e).trigger("input"),""!=e&&h("#"+a.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),y.hasOwnProperty("onEdit")&&y.onEdit(a.id,e))}function v(t){y.hasOwnProperty("onEnter")&&y.onEnter(t.el().id)}function C(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function u(t,e,a){var o,n,s,r,i,l,d=e.flow,c=100;for(e.hasOwnProperty("s")&&"row"==d&&(c=e.s),o=document.createElement("div"),e.hasOwnProperty("s")&&(o.style.flexGrow=e.s),e.hasOwnProperty("class")&&(o.className=e.class),e.hasOwnProperty("tabpanel")&&(o.id=e.tabpanel.id,o.style.display=e.tabpanel.hidden?"none":""),(n=document.createElement("div")).className="mqed-"+d,l=i=s=0;l<e.contents.length;l++)(r=e.contents[l]).hasOwnProperty("flow")&&0==r.contents.length||(c<s+(i=r.hasOwnProperty("s")?r.s:1)&&(o.appendChild(n),s=0,(n=document.createElement("div")).className="mqed-"+d),r.hasOwnProperty("flow")?u(n,r,a+"-"+l):k(n,r,a+"-"+l),s+=i);o.appendChild(n),t.appendChild(o)}function k(t,e,a){var o,n,s,r,i,l;((n=document.createElement("div")).className="mqed-btn-cont",e.s&&(n.style.flexGrow=e.s),e.contid&&(n.id=e.contid),e.contclass&&h(n).addClass(e.contclass),t.appendChild(n),e.l||e.b||e.p)&&((o=document.createElement("span")).tabIndex=0,e.l?(o.className="mqed-btn rend",o.innerText=e.l,s="c",r=e.l.substring(1)):e.b?(o.className="mqed-btn rend",o.innerHTML=e.b,s="t",((r=e.b).match(/^\d$/)||"."==r)&&h(o).addClass("mqed-digitkey")):(o.className="mqed-btn",o.innerHTML=e.p,s="t",r=e.p),e.c&&("shift"==(s=e.c)?h(o).addClass("mqed-shift"):"k"==s&&h(o).addClass("mqed-navkey")),e.sm&&(o.style.fontSize=100-10*e.sm+"%"),e.w&&(r=e.w),e.tabcontent&&(h(o).addClass("mqed-tab"),s="showtabpanel",r=a+"-tabpanel"),h(o).data("cmdtype",s).data("cmdval",r),h(o).on("click mousedown touchstart keydown",(i=s,l=r,function(t){!function t(e,a,o){var n,s,r,i,l,d,c,u;if(("mousedown"!=e.type||"Backspace"===o)&&!("click"==e.type&&"Backspace"===o||"keydown"==e.type&&"Enter"!==e.key))if("touchstart"==e.type&&(e.preventDefault(),h(e.currentTarget).addClass("mactive")),"t"==a)o.match(/^[a-zA-Z]$/)&&h(e.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(o=o.toUpperCase()),p.typedText(o);else if("c"==a)p.cmd(o);else if("l"==a)p.latex(o);else if("w"==a){if(p.write(o),m=o.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(n=m[1].split(/&/).length,s=0;s<n;s++)p.keystroke("Left")}else"k"==a?(p.keystroke(o),"Backspace"===o&&(g=setTimeout(function(){t(e,a,o)},null===g?600:70))):"m"==a?p.matrixCmd(o):"f"==a?(r=p.getSelection())?(p.write(o+"\\left("+r+"\\right)"),p.keystroke("Left")):o.match(/{}$/)?p.typedText(o.replace(/{}$/,"")):p.write(o):"sf"==a?((r=p.getSelection())?p.write(o+"{"+r+"}"):p.cmd(o),p.keystroke("Left")):"i"==a?((r=p.getSelection())||(r=""),"string"==typeof o?(i=o.charAt(0),l=o.charAt(1),p.write("\\left"+i+r+"\\right"+l)):p.write(o[0]+r+o[1]),""==r&&p.keystroke("Left")):"showtabpanel"==a?((d=h(e.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),d.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),h("#"+o).show(),d.addClass("mqed-activetab"),y.hasOwnProperty("onTab")&&y.onTab(d[0],y.curlayoutstyle,o)):"shift"==a&&(d=h(e.target).closest(".mqed-btn"),c=h(e.target).closest(".mqed-tabpanel"),(u=!d.hasClass("active"))?d.addClass("active"):d.removeClass("active"),c.find(".mqed-btn").each(function(t,e){var a=e.textContent;a.match(/^[a-zA-Z]$/)&&(e.textContent=u?e.textContent.toUpperCase():e.textContent.toLowerCase())}))}(t,i,l)})).on("touchend",function(t){setTimeout(function(){h(t.currentTarget).removeClass("mactive")},50)}).on("touchend mouseup",function(){clearTimeout(g),g=null}),n.appendChild(o))}return{setConfig:function(t){for(var e in t)y[e]=t[e]},setMQconfig:function(t){f=t},toggleMQ:o,toggleMQAll:function(t,e){var a=e||null;h(t).each(function(t,e){o(e,a,!0)})},attachEditor:b,getLayoutstyle:C,resetEditor:function(){clearTimeout(i),h("#mqeditor").hide(),p=null}}}(jQuery);
