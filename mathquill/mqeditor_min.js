var MQeditor=function(t){var e={layoutstyle:"auto",layout:[]},a={},s=!1,n=null,o=null,r=null,l=MathQuill.getInterface(MathQuill.getInterface.MAX),i=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"];function c(){try{return window.self!==window.top}catch(t){return!0}}function d(s,n,o){"string"==typeof s&&(s=document.getElementById(s));var r="boolean"==typeof n?n:"hidden"!=s.type,c=s.id,d=s.getAttribute("data-mq")||"";if(!0===r){var m=t(s).attr("type","hidden").val();e.hasOwnProperty("toMQ")&&(m=e.toMQ(m,c));var h=t("#mqinput-"+c);if(0==h.length){var p,f=t("<span/>",{id:"mqinput-"+c,class:"mathquill-math-field",text:m,"aria-label":s.getAttribute("aria-label")});if(null!==(p=s.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&f.addClass(p[0]),d.match(/chem/)&&f.addClass("mq-chem"),"string"==typeof s.style.width&&s.style.width.match(/[\d\.]+\s*\w{2,3}/))f.css("min-width",s.style.width.replace(/([\d\.]+)\s*(\w{2,3})/,(function(t,e,a){return e/1.15+a})));else{var b=s.hasAttribute("size")?s.size>3?s.size/1.8:s.size:10;f.css("min-width",b+"em")}f.insertAfter(s);var v={handlers:{edit:y,enter:g}};e.hasOwnProperty("getLayoutstyle")?e.curlayoutstyle=e.getLayoutstyle():"auto"==e.layoutstyle?e.curlayoutstyle=q():e.curlayoutstyle=e.layoutstyle,"OSK"==e.curlayoutstyle&&(v.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},v.keyboardPassthrough=!0),d.match(/chem/)&&(v.charsThatBreakOutOfSupSubVar="",v.charsThatBreakOutOfSupSubOp="",v.autoSubscriptNumerals=!0),d.match(/(list|ntuple)/)&&(v.charsThatBreakOutOfSupSub="=<>,"),d.match(/allowplusminus/)&&(v.quickplusminus=!0),v.autoOperatorNames=v.autoParenOperators="ln log abs exp sin cos tan arcsinh arccosh arctanh arcsech arccsch arccoth argsinh argcosh argtanh argsech argcsch argcoth arsinh arcosh artanh arsech arcsch arcoth arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth",v.autoCommands="pi theta root sqrt ^oo degree",d.match(/logic/)&&(v.autoCommands+=" neg xor or and implies iff"),d.match(/setexp/)&&(v.autoCommands+=" nn xor uu ominus cap cup oplus");var w,C=s.getAttribute("data-mq-vars")||"";if(""!=C){C=""==C?[]:C.split(/,/);for(var k=0;k<C.length;k++){w=C[k].split(/_/);for(var O=0;O<w.length;O++)w[O].length>1&&w[O].match(/^[a-zA-Z]+$/)&&(-1!=i.indexOf(w[O].toLowerCase())?v.autoCommands+=" "+w[O]:v.autoOperatorNames+=" "+w[O]);C[k].match(/^(hat|bar|vec)\(/)&&(v.autoCommands+=" "+C[k].substring(0,3))}}s.disabled?(h=l.StaticMath(f[0]),f.addClass("disabled")):(h=l.MathField(f[0],v).config(a),u(f),t(s).on("change.mqed",(function(t,a){if(!a){var n=s.value;e.hasOwnProperty("toMQ")&&(n=e.toMQ(n,s.id)),h.latex(n)}})))}else h.show(),h=l(h[0]).latex(m);!0!==o&&h.focus()}else t(s).attr("type","text").off("change.mqed"),!0!==o&&t(s).focus(),t("#mqinput-"+c).hide()}function u(a){t(a).find(".mq-textarea > *").on("focus.mqeditor",h).on("blur.mqeditor",(function(){o=setTimeout(p,100),e.hasOwnProperty("onBlur")&&e.onBlur()})),t(a).on("click.mqeditor",(function(e){var a=t(e.target).closest("label");if(a.length>0)return"undefined"!==a.attr("for")&&t("#"+a.attr("for")).prop("checked",!0),e.stopPropagation(),!1}))}function h(a){clearTimeout(o);var r=t(a.target).closest(".mathquill-math-field");!1===s&&(t("body").append(t("<div/>",{id:"mqeditor",class:"mqeditor"})),t("#mqeditor").on("mousedown touchstart",(function(t){t.preventDefault()})),s=!0);var i=e.curlayoutstyle;if(e.hasOwnProperty("getLayoutstyle")?e.curlayoutstyle=e.getLayoutstyle():"auto"==e.layoutstyle?e.curlayoutstyle=q():e.curlayoutstyle=e.layoutstyle,"OSK"===e.curlayoutstyle){if(c()?t("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):t("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),!document.getElementById("mqe-fb-spacer")){var d=document.createElement("div");d.style.height="200px",d.id="mqe-fb-spacer",t("body").append(d)}}else t("#mqeditor").removeClass("fixedbottom iframeosk");t("#mqeditor").toggleClass("mq-chem",t(r).hasClass("mq-chem"));var m=!1;if((null===n||r[0]!=n.el()||i!==e.curlayoutstyle)&&(m=!0,null!==n&&t("#"+n.el().id.substring(8)).trigger("change",!0),e.hasOwnProperty("getLayout")&&(e.layout=e.getLayout(r[0],e.curlayoutstyle)),t("#mqeditor").empty().show(),e.layout.tabs?function(e,a,s){var n=document.createElement("div");n.className="mqed-row mqed-tabrow";var o,r,l=document.createElement("div");e.appendChild(n),e.appendChild(l);for(var i=0;i<a.tabs.length;i++)if(!0===a.tabs[i].enabled){v(n,a.tabs[i],s+"-"+i),(r=document.createElement("div")).className="mqed-row mqed-tabpanel",r.id=s+"-"+i+"-tabpanel",l.appendChild(r);for(var c=0;c<a.tabs[i].tabcontent.length;c++)(o=a.tabs[i].tabcontent[c]).hasOwnProperty("flow")&&0==o.contents.length||(o.hasOwnProperty("flow")?b(r,o,s+"-"+i+"-"+c):v(r,o,s+"-"+i+"-"+c))}v(n,{s:1}),v(n,{p:"&times;",c:"close",lb:"close"}),t(e).find(".mqed-tab").first().addClass("mqed-activetab")}(document.getElementById("mqeditor"),e.layout,"mqeditor"):b(document.getElementById("mqeditor"),e.layout,"mqeditor"),t("#mqeditor .mqed-btn.rend").each((function(){l.StaticMath(this,{mouseEvents:!1})})),t("#mqeditor .mqed-tabrow").length>0)){t("#mqeditor .mqed-tabpanel").hide().first().show();var u=t("#mqeditor .mqed-tabrow + div");u.css("height",u.height())}"OSK"!==e.curlayoutstyle||c()?t("#mqeditor").show():t("#mqeditor").slideDown(50,(function(){var e=t("#mqeditor").height()+5,a=t(window).height()-(r.offset().top+r.outerHeight()-t(window).scrollTop());a<e&&t(window).scrollTop(t(window).scrollTop()+(e-a))})),f(r),n=l.MathField(r[0]),t("#"+r[0].id.substring(8)).triggerHandler("focus"),e.hasOwnProperty("onShow")&&e.onShow(r[0],e.curlayoutstyle,m),t(document).trigger("mqeditor:show")}function p(a){n&&(t(document).trigger("mqeditor:hide"),"OSK"!==e.curlayoutstyle||c()?t("#mqeditor").hide():t("#mqeditor").slideUp(50),t("#"+n.el().id.substring(8)).trigger("change",!0),n=null)}function f(a){if("under"==e.curlayoutstyle||c()){var s=t(a).closest(".mathquill-math-field"),n=s.offset(),o=s.outerHeight(),r=n.left;if(document.getElementById("mqeditor")){var l=document.getElementById("mqeditor").offsetWidth;r+l>document.documentElement.clientWidth&&(r=document.documentElement.clientWidth-l-5)}c()?t("#mqeditor").css("top",n.top+o+3).css("left",0):t("#mqeditor").css("top",n.top+o+3).css("left",r)}else t("#mqeditor").css("top","auto").css("left",0)}function y(a){var s=a.el();if(f(s),e.hasOwnProperty("onResize")&&e.onResize(s,e.curlayoutstyle),s.id.match(/mqinput/)){var n=a.latex();e.hasOwnProperty("fromMQ")&&(n=e.fromMQ(n,s.id)),t("#"+s.id.substring(8)).val(n).trigger("input"),""!=n&&t("#"+s.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),e.hasOwnProperty("onEdit")&&e.onEdit(s.id,n)}}function g(t){e.hasOwnProperty("onEnter")&&e.onEnter(t.el().id)}function q(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function b(t,e,a){var s=e.flow,n=100;e.hasOwnProperty("s")&&"row"==s&&(n=e.s);var o=document.createElement("div");e.hasOwnProperty("s")&&(o.style.flexGrow=e.s),e.hasOwnProperty("class")&&(o.className=e.class),e.hasOwnProperty("tabpanel")&&(o.id=e.tabpanel.id,o.style.display=e.tabpanel.hidden?"none":""),(d=document.createElement("div")).className="mqed-"+s;for(var r,l=0,i=0,c=0;c<e.contents.length;c++)if(!(r=e.contents[c]).hasOwnProperty("flow")||0!=r.contents.length){var d;if(l+(i=r.hasOwnProperty("s")?r.s:1)>n)o.appendChild(d),l=0,(d=document.createElement("div")).className="mqed-"+s;r.hasOwnProperty("flow")?b(d,r,a+"-"+c):v(d,r,a+"-"+c),l+=i}o.appendChild(d),t.appendChild(o)}function v(e,a,s){var n,o,l,i;if((o=document.createElement("div")).className="mqed-btn-cont",a.s&&(o.style.flexGrow=a.s),a.contid&&(o.id=a.contid),a.contclass&&t(o).addClass(a.contclass),e.appendChild(o),a.l||a.b||a.p){if((n=document.createElement("span")).tabIndex=0,a.l){if(a.op)n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+a.l.substring(1)+"</var></span>";else if(a.pr)n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-root-block">'+a.pr+"</span>";else if(a.l.match(/\\left(.)\\right(.)/)){var c=a.l.match(/\\left(.)\\right(.)/);n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+c[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+c[2]+"</span></span>"}else n.className="mqed-btn rend",n.innerText=a.l;l="c",i=a.l.substring(1)}else a.b?(a.r?(n.className="mqed-btn rend",n.innerHTML=a.b):(n.className="mqed-btn mq-math-mode",a.v?n.innerHTML='<span class="mq-root-block"><var>'+a.b+"</var></span>":n.innerHTML='<span class="mq-root-block"><span>'+a.b+"</span></span>"),l="t",((i=a.b).match(/^\d$/)||"."==i)&&t(n).addClass("mqed-digitkey")):(n.className="mqed-btn",n.innerHTML=a.p,l="t",i=a.p);a.c&&("shift"==(l=a.c)?t(n).addClass("mqed-shift"):"k"==l?t(n).addClass("mqed-navkey"):"close"==l&&t(n).addClass("mqed-closebtn")),a.lb&&n.setAttribute("aria-label",a.lb),a.sm&&(n.style.fontSize=100-10*a.sm+"%"),a.w&&(i=a.w),a.tabcontent&&(t(n).addClass("mqed-tab"),l="showtabpanel",i=s+"-tabpanel"),t(n).data("cmdtype",l).data("cmdval",i),t(n).on("click mousedown touchstart keydown",function(t,e){return function(a){w(a,t,e)}}(l,i)).on("touchend",(function(e){setTimeout((function(){t(e.currentTarget).removeClass("mactive")}),50)})).on("touchend mouseup",(function(){clearTimeout(r),r=null})),o.appendChild(n)}}function w(a,s,o){if(("mousedown"!=a.type||"Backspace"===o)&&!("click"==a.type&&"Backspace"===o||"keydown"==a.type&&"Enter"!==a.key))if("touchstart"==a.type&&(a.preventDefault(),t(a.currentTarget).addClass("mactive")),"t"==s)o.match(/^[a-zA-Z]$/)&&t(a.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(o=o.toUpperCase()),n.typedText(o);else if("c"==s)n.cmd(o);else if("l"==s)n.latex(o);else if("w"==s){if(n.write(o),m=o.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(var l=m[1].split(/&/).length,i=0;i<l;i++)n.keystroke("Left")}else if("k"==s)n.keystroke(o),"Backspace"===o&&(r=setTimeout((function(){w(a,s,o)}),null===r?600:70));else if("m"==s)n.matrixCmd(o);else if("f"==s){(c=n.getSelection())?(n.write(o+"\\left("+c+"\\right)"),n.keystroke("Left")):o.match(/{}$/)?n.typedText(o.replace(/{}$/,"")):n.write(o)}else if("sf"==s){(c=n.getSelection())?n.write(o+"{"+c+"}"):n.cmd(o),n.keystroke("Left")}else if("i"==s){var c;if((c=n.getSelection())||(c=""),"string"==typeof o){var d=o.charAt(0),u=o.charAt(1);n.write("\\left"+d+c+"\\right"+u)}else n.write(o[0]+c+o[1]);""==c&&n.keystroke("Left")}else if("showtabpanel"==s){(h=t(a.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),h.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),t("#"+o).show(),h.addClass("mqed-activetab"),e.hasOwnProperty("onTab")&&e.onTab(h[0],e.curlayoutstyle,o)}else if("shift"==s){var h=t(a.target).closest(".mqed-btn"),p=t(a.target).closest(".mqed-tabpanel"),f=!h.hasClass("active");f?h.addClass("active"):h.removeClass("active"),p.find(".mqed-btn").each((function(t,e){e.textContent.match(/^[a-zA-Z]$/)&&(e.textContent=f?e.textContent.toUpperCase():e.textContent.toLowerCase())}))}else"close"==s&&n.blur()}return{setConfig:function(t){for(var a in t)e[a]=t[a]},setMQconfig:function(t){a=t},toggleMQ:d,toggleMQAll:function(e,a){var s=a||null;t(e).each((function(t,e){d(e,s,!0)}))},attachEditor:u,getLayoutstyle:q,resetEditor:function(){clearTimeout(o),t("#mqeditor").hide(),n=null}}}(jQuery);